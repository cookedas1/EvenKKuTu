<<<<<<< HEAD
/*!
 * Rule the words! KKuTu Online
 * Copyright (C) 2017 JJoriping(op@jjo.kr)
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 */(()=>{var e={};e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),function(){var a,t,s,n,l,d,c,m,u,p,g=[null,"10000000","10001000","10010010","10011010","11011010","11011110","11011111","11111111"],f={profile:{title:L.null},data:{score:0}},h=30,v=[],k=new RegExp(["느으*[^가-힣]*금마?","니[^가-힣]*(엄|앰|엠)","(ㅄ|ㅅㅂ|ㅂㅅ)","미친(년|놈)?","(병|븅|빙)[^가-힣]*신","보[^가-힣]*지","(새|섀|쌔|썌)[^가-힣]*(기|끼)","섹[^가-힣]*스","(시|씨|쉬|쒸)이*입?[^가-힣]*(발|빨|벌|뻘|팔|펄)","십[^가-힣]*새","씹","(애|에)[^가-힣]*미","자[^가-힣]*지","존[^가-힣]*나","좆|죶","지랄","창[^가-힣]*(녀|년|놈)","fuck","sex"].join("|"),"g"),_={},y={},w={},C={Classic:{},Jaqwi:{},Crossword:{},Typing:{},Hunmin:{},Daneo:{},Sock:{},Drawing:{}},T=!!window.hasOwnProperty("AudioContext")&&new AudioContext,x=window.WebSocket,S=setInterval,j=setTimeout;function D(e){32==e.keyCode&&(m.chatBtn.trigger("click"),e.preventDefault())}function q(){var e=w._list.slice(w.chain),a=w.room.opts.proverb?1:5,r="",o=e[0].length;o>=20&&(r="18px"),o>=50&&(r="15px"),m.game.display.css("font-size",r),e[0]="<label style='color: #FFFF44;'>"+e[0]+"</label>",m.game.display.html(e.slice(0,a).join(" ")),m.game.chain.show().html(w.chain),$(".jjo-turn-time .graph-bar").width("100%").html(e.slice(a,2*a).join(" ")).css({"text-align":"center","background-color":"#70712D"})}function O(e){$(".jjo-turn-time .graph-bar").html(e+L.afterRun),e>0&&G(O,1e3,e-1)}function R(e){var a;for(a in e)$("#game-user-"+a+" .game-user-score").empty().append($("<div>").css({float:"none",color:"#4444FF","text-align":"center"}).html(e[a]+"<label style='font-size: 11px;'>"+L.kpm+"</label>"))}$(document).ready(function(){var r,o,i;for(window.differ=new diff_match_patch,w.PUBLIC="true"==$("#PUBLIC").html(),w.URL=$("#URL").html(),w.version=$("#version").html(),w.server=location.href.match(/\?.*server=(\d+)/)[1],w.shop={},w._okg=0,w._playTime=0,w._kd="",w._timers=[],w._obtain=[],w._wblock={},w._shut={},w.usersR={},v.push(He(1)),r=2;r<360;r++)v.push(v[r-2]+He(r));if(v[359]=1/0,v.push(1/0),m={loading:$("#Loading"),lobby:{userListTitle:$(".UserListBox .product-title"),userList:$(".UserListBox .product-body"),roomListTitle:$(".RoomListBox .product-title"),roomList:$(".RoomListBox .product-body"),createBanner:$("<div>").addClass("rooms-item rooms-create").append($("<div>").html(L.newRoom))},chat:$("#Chat"),chatLog:$("#chat-log-board"),talk:$("#Talk"),chatBtn:$("#ChatBtn"),menu:{help:$("#HelpBtn"),setting:$("#SettingBtn"),community:$("#CommunityBtn"),newRoom:$("#NewRoomBtn"),setRoom:$("#SetRoomBtn"),quickRoom:$("#QuickRoomBtn"),spectate:$("#SpectateBtn"),shop:$("#ShopBtn"),dict:$("#DictionaryBtn"),wordPlus:$("#WordPlusBtn"),invite:$("#InviteBtn"),practice:$("#PracticeBtn"),ready:$("#ReadyBtn"),start:$("#StartBtn"),exit:$("#ExitBtn"),notice:$("#NoticeBtn"),replay:$("#ReplayBtn"),leaderboard:$("#LeaderboardBtn")},dialog:{setting:$("#SettingDiag"),settingServer:$("#setting-server"),settingOK:$("#setting-ok"),community:$("#CommunityDiag"),commFriends:$("#comm-friends"),commFriendAdd:$("#comm-friend-add"),room:$("#RoomDiag"),roomOK:$("#room-ok"),quick:$("#QuickDiag"),quickOK:$("#quick-ok"),result:$("#ResultDiag"),resultOK:$("#result-ok"),resultSave:$("#result-save"),practice:$("#PracticeDiag"),practiceOK:$("#practice-ok"),dict:$("#DictionaryDiag"),dictInjeong:$("#dict-injeong"),dictSearch:$("#dict-search"),wordPlus:$("#WordPlusDiag"),wordPlusOK:$("#wp-ok"),invite:$("#InviteDiag"),inviteList:$(".invite-board"),inviteRobot:$("#invite-robot"),roomInfo:$("#RoomInfoDiag"),roomInfoJoin:$("#room-info-join"),profile:$("#ProfileDiag"),profileShut:$("#profile-shut"),profileHandover:$("#profile-handover"),profileKick:$("#profile-kick"),profileLevel:$("#profile-level"),profileDress:$("#profile-dress"),profileWhisper:$("#profile-whisper"),kickVote:$("#KickVoteDiag"),kickVoteY:$("#kick-vote-yes"),kickVoteN:$("#kick-vote-no"),purchase:$("#PurchaseDiag"),purchaseOK:$("#purchase-ok"),purchaseNO:$("#purchase-no"),replay:$("#ReplayDiag"),replayView:$("#replay-view"),leaderboard:$("#LeaderboardDiag"),lbTable:$("#ranking tbody"),lbPage:$("#lb-page"),lbNext:$("#lb-next"),lbMe:$("#lb-me"),lbPrev:$("#lb-prev"),dress:$("#DressDiag"),dressOK:$("#dress-ok"),charFactory:$("#CharFactoryDiag"),cfCompose:$("#cf-compose"),injPick:$("#InjPickDiag"),injPickAll:$("#injpick-all"),injPickNo:$("#injpick-no"),injPickOK:$("#injpick-ok"),chatLog:$("#ChatLogDiag"),obtain:$("#ObtainDiag"),obtainOK:$("#obtain-ok"),help:$("#HelpDiag")},box:{chat:$(".ChatBox"),userList:$(".UserListBox"),roomList:$(".RoomListBox"),shop:$(".ShopBox"),room:$(".RoomBox"),game:$(".GameBox"),me:$(".MeBox")},game:{display:$(".jjo-display"),hints:$(".GameBox .hints"),tools:$(".GameBox .tools"),drawingTitle:$("#drawing-title"),themeisTitle:$("#themeis-title"),cwcmd:$(".GameBox .cwcmd"),bb:$(".GameBox .bb"),items:$(".GameBox .items"),chain:$(".GameBox .chain"),round:$(".rounds"),here:$(".game-input").hide(),hereText:$("#game-input"),history:$(".history"),roundBar:$(".jjo-round-time .graph-bar"),turnBar:$(".jjo-turn-time .graph-bar")},yell:$("#Yell").hide(),balloons:$("#Balloons")},null==x)return N(L.websocketUnsupport),void alert(L.websocketUnsupport);for(w._soundList=[{key:"k",value:"/media/kkutu/k.mp3"},{key:"lobby",value:"/media/kkutu/LobbyBGM.mp3"},{key:"jaqwi",value:"/media/kkutu/JaqwiBGM.mp3"},{key:"jaqwiF",value:"/media/kkutu/JaqwiFastBGM.mp3"},{key:"game_start",value:"/media/kkutu/game_start.mp3"},{key:"round_start",value:"/media/kkutu/round_start.mp3"},{key:"fail",value:"/media/kkutu/fail.mp3"},{key:"timeout",value:"/media/kkutu/timeout.mp3"},{key:"lvup",value:"/media/kkutu/lvup.mp3"},{key:"Al",value:"/media/kkutu/Al.mp3"},{key:"success",value:"/media/kkutu/success.mp3"},{key:"missing",value:"/media/kkutu/missing.mp3"},{key:"mission",value:"/media/kkutu/mission.mp3"},{key:"kung",value:"/media/kkutu/kung.mp3"},{key:"horr",value:"/media/kkutu/horr.mp3"}],r=0;r<=10;r++)w._soundList.push({key:"T"+r,value:"/media/kkutu/T"+r+".mp3"},{key:"K"+r,value:"/media/kkutu/K"+r+".mp3"},{key:"As"+r,value:"/media/kkutu/As"+r+".mp3"});for(r in o=w._soundList,i=function(){Me(y)},w._lsRemain=o.length,o.forEach(function(e){!function(e,a,r){var o=new XMLHttpRequest;function t(r){_[e]=new s(a),i()}function i(){0==--w._lsRemain?r&&r():N(L.loadRemain+w._lsRemain)}function s(e){var a=this;this.audio=new Audio(e),this.audio.load(),this.start=function(){a.audio.play()},this.stop=function(){a.audio.currentTime=0,a.audio.pause()}}o.open("GET",a),o.responseType="arraybuffer",o.onload=function(a){T?T.decodeAudioData(a.target.response,function(a){_[e]=a,i()},t):t()},o.send()}(e.key,e.value,i)}),delete w._soundList,t=$("#MOREMI_PART").html().split(","),s=$("#AVAIL_EQUIP").html().split(","),n=JSON.parse($("#RULE").html()),l=JSON.parse($("#OPTIONS").html()),a=Object.keys(n),(p="true"==$("#mobile").html())&&(h=200),w._timePercent=function(){return 100-(w._turnSound.audio?w._turnSound.audio.currentTime:T.currentTime-w._turnSound.startedAt)/w.turnTime*1e5+"%"},w.setRoom=function(e,a){var r="for-lobby"==Q();null==a?(delete w.rooms[e],r&&$("#room-"+e).remove()):(r&&!w.rooms[e]&&m.lobby.roomList.append($("<div>").attr("id","room-"+e)),w.rooms[e]=a,r&&$("#room-"+e).replaceWith(te(a)))},w.setUser=function(e,a){var r,o=Q(),t="for-lobby"==o||"for-master"==o;w._replay?u.users[e]=a:null==a?(delete w.users[e],t&&$("#users-item-"+e+",#invite-item-"+e).remove()):(t&&!w.users[e]&&(r=re(a,"for-master"==o),"for-master"==o?m.dialog.inviteList.append(r):m.lobby.userList.append(r)),w.users[e]=a,t&&(r?$("#"+r.attr("id")).replaceWith(r):$("#"+("for-lobby"==o?"users-item-":"invite-item")+e).replaceWith(re(a,"for-master"==o))))},$(document).on("paste",function(e){if(w.room&&w.room.gaming)return e.preventDefault(),!1}),m.talk.on("drop",function(e){if(w.room&&w.room.gaming)return e.preventDefault(),!1}),w.opts=$.cookie("kks"),w.opts&&E(JSON.parse(w.opts)),$(".dialog-head .dialog-title").on("mousedown",function(e){var a,r,o,t,i=$(e.currentTarget).parents(".dialog");$(".dialog-front").removeClass("dialog-front"),i.addClass("dialog-front"),a=i,r=e.pageX,o=e.pageY,t=a.position(),$(window).on("mousemove",function(e){var i=e.pageX-r,s=e.pageY-o;a.css("left",t.left+i),a.css("top",t.top+s)})}).on("mouseup",function(e){$(window).off("mousemove")}),m.chatBtn.on("click",function(e){var a=p&&m.game.here.is(":visible")?m.game.hereText.val():m.talk.val();if(a){var r={value:a.trim()};"/"==r.value[0]?(r.cmd=r.value.split(" "),function(e){var a,r,o={"/ㄱ":L.cmd_r,"/청소":L.cmd_cls,"/ㄹ":L.cmd_f,"/ㄷ":L.cmd_e,"/ㄷㄷ":L.cmd_ee,"/무시":L.cmd_wb,"/차단":L.cmd_shut,"/id":L.cmd_id};switch(e[0].toLowerCase()){case"/ㄱ":case"/r":w.room&&(w.room.master==w.id?m.menu.start.trigger("click"):m.menu.ready.trigger("click"));break;case"/청소":case"/cls":$("#Chat").empty();break;case"/ㄹ":case"/f":M(m.dialog.chatLog),m.chatLog.scrollTop(999999999);break;case"/귓":case"/ㄷ":case"/e":V(e[1],e.slice(2).join(" "));break;case"/답":case"/ㄷㄷ":case"/ee":w._recentFrom?V(w._recentFrom,e.slice(1).join(" ")):na(L.error_425);break;case"/무시":case"/wb":t=e[1],w._wblock.hasOwnProperty(t)?(delete w._wblock[t],na(t+L.wnblocked)):(w._wblock[t]=!0,na(t+L.wblocked));break;case"/차단":case"/shut":H(e.slice(1).join(" "));break;case"/id":if(e[1]){for(a in r=0,e[1]=e.slice(1).join(" "),w.users)(w.users[a].profile.title||w.users[a].profile.name)==e[1]&&na("["+ ++r+"] "+a);r||na(L.error_405)}else na(L.myId+w.id);break;default:for(a in o)na(o[a],a)}var t}(r.cmd)):((m.game.here.is(":visible")||w._relay)&&(r.relay=!0),F("talk",r)),w._whisper?(m.talk.val("/e "+w._whisper+" "),delete w._whisper):m.talk.val(""),m.game.hereText.val("")}}).hotkey(m.talk,13).hotkey(m.game.hereText,13),$("#cw-q-input").on("keydown",function(e){if(13==e.keyCode){var a=$(e.currentTarget),r=a.val(),o={relay:!0,data:w._sel,value:r};if(!r)return;F("talk",o),a.val("")}}).on("focusout",function(e){$(".cw-q-body").empty(),m.game.cwcmd.css("opacity",0)}),$("#room-limit").on("change",function(e){var a=$(e.currentTarget),r=a.val();r<2||r>8?a.css("color","#FF4444"):a.css("color","")}),$("#room-round").on("change",function(e){var a=$(e.currentTarget),r=a.val();r<1||r>10?a.css("color","#FF4444"):a.css("color","")}),m.game.here.on("click",function(e){p||m.talk.focus()}),m.talk.on("keyup",function(e){m.game.hereText.val(m.talk.val())}),$(window).on("beforeunload",function(e){if(w.room)return L.sureExit}),$(".result-me-gauge .graph-bar").addClass("result-me-before-bar"),$(".result-me-gauge").append($("<div>").addClass("graph-bar result-me-current-bar")).append($("<div>").addClass("graph-bar result-me-bonus-bar")),m.dialog)m.dialog[r].children(".dialog-head").hasClass("no-close")||m.dialog[r].children(".dialog-head").append($("<div>").addClass("closeBtn").on("click",function(e){$(e.currentTarget).parent().parent().hide()}).hotkey(!1,27));function g(e,a){var r,o;for(r in l)o=l[r].name.toLowerCase(),-1==e.indexOf(r)?$("#"+a+"-"+o+"-panel").hide():$("#"+a+"-"+o+"-panel").show()}function f(e){var a,r,o={};for(a in l)r=l[a].name.toLowerCase(),$("#"+e+"-"+r).is(":checked")&&(o[r]=!0);return o}function b(e,a,r,o){var t;if(!o){if(e.gaming)return!1;if(e.password)return!1;if(e.players.length>=e.limit)return!1}if(e.mode!=a)return!1;for(t in r)if(!e.opts[t])return!1;return!0}for(m.menu.help.on("click",function(e){$("#help-board").attr("src","/help"),M(m.dialog.help)}),m.menu.setting.on("click",function(e){M(m.dialog.setting)}),m.menu.community.on("click",function(e){if(w.guest)return va(451);M(m.dialog.community)}),m.dialog.commFriendAdd.on("click",function(e){var a=prompt(L.friendAddNotice);if(a)return w.users[a]?void F("friendAdd",{target:a},!0):va(450)}),m.menu.newRoom.on("click",function(e){var a;m.dialog.quick.hide(),w.typeRoom="enter",M(a=m.dialog.room),a.find(".dialog-title").html(L.newRoom)}),m.menu.setRoom.on("click",function(e){var r,o,t,i=n[a[w.room.mode]];for(o in w.typeRoom="setRoom",$("#room-title").val(w.room.title),$("#room-limit").val(w.room.limit),$("#room-mode").val(w.room.mode).trigger("change"),$("#room-round").val(w.room.round),$("#room-time").val(w.room.time/i.time),l)t=l[o].name.toLowerCase(),$("#room-"+t).attr("checked",w.room.opts[t]);w._injpick=w.room.opts.injpick,M(r=m.dialog.room),r.find(".dialog-title").html(L.setRoom)}),$("#quick-mode, #QuickDiag .game-option").on("change",function(e){var r,o,t=$("#quick-mode").val(),i=0;for(r in"quick-mode"==e.currentTarget.id&&$("#QuickDiag .game-option").prop("checked",!1),o=f("quick"),g(n[a[t]].opts,"quick"),w.rooms)b(w.rooms[r],t,o,!0)&&i++;$("#quick-status").html(L.quickStatus+" "+i)}),m.menu.quickRoom.on("click",function(e){m.dialog.room.hide(),M(m.dialog.quick),m.dialog.quick.is(":visible")&&($("#QuickDiag>.dialog-body").find("*").prop("disabled",!1),$("#quick-mode").trigger("change"),$("#quick-queue").html(""),m.dialog.quickOK.removeClass("searching").html(L.OK))}),m.dialog.quickOK.on("click",function(e){var a=$("#quick-mode").val(),r=f("quick");if("for-lobby"==Q()){if(m.dialog.quickOK.hasClass("searching"))return m.dialog.quick.hide(),o(),void m.menu.quickRoom.trigger("click");$("#QuickDiag>.dialog-body").find("*").prop("disabled",!0),m.dialog.quickOK.addClass("searching").html("<i class='fa fa-spinner fa-spin'></i> "+L.NO).prop("disabled",!1),w._quickn=0,w._quickT=I(o,1e3)}function o(){var e,o=[];if(m.dialog.quick.is(":visible")){for(e in $("#quick-queue").html(L.quickQueue+" "+ee(1e3*w._quickn++)),w.rooms)b(w.rooms[e],a,r)&&o.push(e);o.length&&(e=o[Math.floor(Math.random()*o.length)],w._preQuick=!0,$("#room-"+e).trigger("click"))}else clearTimeout(w._quickT)}}),$("#room-mode").on("change",function(e){var r=$("#room-mode").val(),o=n[a[r]];$("#game-mode-expl").html(L["modex"+r]),g(o.opts,"room"),w._injpick=[],-1!=o.opts.indexOf("ijp")?$("#room-injpick-panel").show():$("#room-injpick-panel").hide(),"Typing"==o.rule&&$("#room-round").val(3),$("#room-time").children("option").each(function(e,a){$(a).html(Number($(a).val())*o.time+L.SECOND)})}).trigger("change"),m.menu.spectate.on("click",function(e){m.menu.spectate.hasClass("toggled")?(F("form",{mode:"J"}),m.menu.spectate.removeClass("toggled")):(F("form",{mode:"S"}),m.menu.spectate.addClass("toggled"))}),m.menu.shop.on("click",function(a){var r;(w._shop=!w._shop)?((r=$("#shop-shelf")).html(L.LOADING),Me(function(a){if(r.empty(),w.guest&&(a.error=423),a.error)return m.menu.shop.trigger("click"),va(a.error);a.goods.sort(function(e,a){return a.updatedAt-e.updatedAt}).forEach(function(e,a,o){if(!(e.cost<0)){var t=ua(!1,e);r.append($("<div>").attr("id","goods_"+e._id).addClass("goods").append($("<div>").addClass("jt-image goods-image").css("background-image","url("+t+")")).append($("<div>").addClass("goods-title").html(ca(e._id))).append($("<div>").addClass("goods-cost").html(ha(e.cost)+L.ping)).append(Ne(e,!1)).on("click",Ee))}}),e.g.expl(r)}),$(".shop-type.selected").removeClass("selected"),$("#shop-type-all").addClass("selected"),m.menu.shop.addClass("toggled")):m.menu.shop.removeClass("toggled"),z()}),$(".shop-type").on("click",function(e){var a=$(e.currentTarget),r=a.attr("id").slice(10);$(".shop-type.selected").removeClass("selected"),a.addClass("selected"),function(e){var a,r,o,t=!0===e;t||(e=e.split(","));for(o in w.shop)(r=w.shop[o]).cost<0||(a=$("#goods_"+o).show(),t||-1==e.indexOf(r.group)&&a.hide())}("all"==r||a.attr("value"))}),m.menu.dict.on("click",function(e){M(m.dialog.dict)}),m.menu.wordPlus.on("click",function(e){M(m.dialog.wordPlus)}),m.menu.invite.on("click",function(e){M(m.dialog.invite),ae(!0)}),m.menu.practice.on("click",function(e){n[a[w.room.mode]].ai?($("#PracticeDiag .dialog-title").html(L.practice),$("#ai-team").val(0).prop("disabled",!0),M(m.dialog.practice)):F("practice",{level:-1})}),m.menu.ready.on("click",function(e){F("ready")}),m.menu.start.on("click",function(e){F("start")}),m.menu.exit.on("click",function(e){if(w.room.gaming){if(!confirm(L.sureExit))return;!function(){w._spaced&&C.Typing.spaceOff();clearInterval(w._tTime),w._relay=!1}()}F("leave")}),m.menu.replay.on("click",function(e){w._replay&&Se(),M(m.dialog.replay),m.dialog.replayView.attr("disabled",!0),m.dialog.replay.is(":visible")&&$("#replay-file").trigger("change")}),m.menu.leaderboard.on("click",function(e){w._lbpage=0,m.dialog.leaderboard.is(":visible")?m.dialog.leaderboard.hide():$.get("/ranking",function(e){he(e),M(m.dialog.leaderboard)})}),m.dialog.lbPrev.on("click",function(e){$(e.currentTarget).attr("disabled",!0),$.get("/ranking?p="+(w._lbpage-1),function(e){he(e)})}),m.dialog.lbMe.on("click",function(e){$(e.currentTarget).attr("disabled",!0),$.get("/ranking?id="+w.id,function(e){he(e)})}),m.dialog.lbNext.on("click",function(e){$(e.currentTarget).attr("disabled",!0),$.get("/ranking?p="+(w._lbpage+1),function(e){he(e)})}),m.dialog.settingServer.on("click",function(e){location.href="/"}),m.dialog.settingOK.on("click",function(e){E({mb:$("#mute-bgm").is(":checked"),me:$("#mute-effect").is(":checked"),di:$("#deny-invite").is(":checked"),dw:$("#deny-whisper").is(":checked"),df:$("#deny-friend").is(":checked"),ar:$("#auto-ready").is(":checked"),su:$("#sort-user").is(":checked"),ow:$("#only-waiting").is(":checked"),ou:$("#only-unlock").is(":checked")}),$.cookie("kks",JSON.stringify(w.opts)),m.dialog.setting.hide()}),m.dialog.profileLevel.on("click",function(e){$("#PracticeDiag .dialog-title").html(L.robot),$("#ai-team").prop("disabled",!1),M(m.dialog.practice)}),m.dialog.practiceOK.on("click",function(e){var a=$("#practice-level").val(),r=$("#ai-team").val();m.dialog.practice.hide(),$("#PracticeDiag .dialog-title").html()==L.robot?F("setAI",{target:w._profiled,level:a,team:r}):F("practice",{level:a})}),m.dialog.roomOK.on("click",function(e){var a,r,o={injpick:w._injpick};for(a in l)o[r=l[a].name.toLowerCase()]=$("#room-"+r).is(":checked");F(w.typeRoom,{title:$("#room-title").val().trim()||$("#room-title").attr("placeholder").trim(),password:$("#room-pw").val(),limit:$("#room-limit").val(),mode:$("#room-mode").val(),round:$("#room-round").val(),time:$("#room-time").val(),opts:o}),m.dialog.room.hide()}),m.dialog.resultOK.on("click",function(e){1==w._resultPage&&w._resultRank?Pe(w._resultRank[w.id]):(w.practicing&&(w.room.gaming=!0,F("leave")),w.resulting=!1,m.dialog.result.hide(),delete w._replay,delete w._resultRank,m.box.room.height(360),Ze("lobby"),ta(),z())}),m.dialog.resultSave.on("click",function(e){var a=new Date(u.time),r=new Blob([JSON.stringify(u)],{type:"text/plain"}),o=URL.createObjectURL(r),t="KKuTu"+a.getFullYear()+"-"+(a.getMonth()+1)+"-"+a.getDate()+" "+a.getHours()+"-"+a.getMinutes()+"-"+a.getSeconds()+".replay",i=$("<a>").attr({download:t,href:o}).on("click",function(e){i.remove()});$("#Jungle").append(i),i[0].click()}),m.dialog.dictInjeong.on("click",function(e){var a=$(e.currentTarget);a.is(":disabled")||$("#dict-theme").val()&&(a.prop("disabled",!0),$("#dict-output").html(L.searching),$.get("/injeong/"+$("#dict-input").val()+"?theme="+$("#dict-theme").val(),function(e){if(G(function(){a.prop("disabled",!1)},2e3),e.error)return $("#dict-output").html(e.error+": "+L["wpFail_"+e.error]);$("#dict-output").html(L.wpSuccess+"("+e.message+")")}))}),m.dialog.dictSearch.on("click",function(e){var a=$(e.currentTarget);a.is(":disabled")||(a.prop("disabled",!0),$("#dict-output").html(L.searching),W($("#dict-input").val(),function(e){if(G(function(){a.prop("disabled",!1)},500),e.error)return $("#dict-output").html(e.error+": "+L["wpFail_"+e.error]);$("#dict-output").html(Ue(e.word,e.mean,e.theme,e.type.split(",")))}))}).hotkey($("#dict-input"),13),m.dialog.wordPlusOK.on("click",function(e){var a;m.dialog.wordPlusOK.hasClass("searching")||(a=$("#wp-input").val())&&((a=a.replace(/[^a-z가-힣]/g,"")).length<2||($("#wp-input").val(""),$(e.currentTarget).addClass("searching").html("<i class='fa fa-spin fa-spinner'></i>"),F("wp",{value:a})))}).hotkey($("#wp-input"),13),m.dialog.inviteRobot.on("click",function(e){$e("AI")}),m.box.me.on("click",function(e){be(w.id)}),m.dialog.roomInfoJoin.on("click",function(e){m.dialog.roomInfo.hide(),oa(w._roominfo)}),m.dialog.profileHandover.on("click",function(e){confirm(L.sureHandover)&&F("handover",{target:w._profiled})}),m.dialog.profileKick.on("click",function(e){F("kick",{robot:w.robots.hasOwnProperty(w._profiled),target:w._profiled})}),m.dialog.profileShut.on("click",function(e){var a=w.users[w._profiled];a&&H(a.profile.title||a.profile.name)}),m.dialog.profileWhisper.on("click",function(e){var a=w.users[w._profiled];m.talk.val("/e "+(a.profile.title||a.profile.name).replace(/\s/g,"")+" ").focus()}),m.dialog.profileDress.on("click",function(e){return w.guest?va(421):w._gaming?va(438):void(M(m.dialog.dress)&&$.get("/box",function(e){if(e.error)return va(e.error);w.box=e,ue()}))}),m.dialog.dressOK.on("click",function(e){$(e.currentTarget).attr("disabled",!0),$.post("/exordial",{data:$("#dress-exordial").val()},function(e){if(m.dialog.dressOK.attr("disabled",!1),e.error)return va(e.error);m.dialog.dress.hide()})}),$("#DressDiag .dress-type").on("click",function(e){var a=$(e.currentTarget),r=a.attr("id").slice(11);$(".dress-type.selected").removeClass("selected"),a.addClass("selected"),ge("all"==r||a.attr("value"))}),$("#dress-cf").on("click",function(e){if(w._gaming)return va(438);M(m.dialog.charFactory)&&fe()}),m.dialog.cfCompose.on("click",function(e){if(!m.dialog.cfCompose.hasClass("cf-composable"))return va(436);confirm(L.cfSureCompose)&&$.post("/cf",{tray:w._tray.join("|")},function(e){var a;if(e.error)return va(e.error);for(a in F("refresh"),alert(L.cfComposed),w.users[w.id].money=e.money,w.box=e.box,e.gain)pa(e.gain[a]);ue(w._avGroup),Z(),fe()})}),$("#room-injeong-pick").on("click",function(e){var r,o=n[a[$("#room-mode").val()]];for(r in $("#injpick-list>div").hide(),"ko"==o.lang?(w._ijkey="#ko-pick-",$("#ko-pick-list").show()):"en"==o.lang&&(w._ijkey="#en-pick-",$("#en-pick-list").show()),m.dialog.injPickNo.trigger("click"),w._injpick)$(w._ijkey+w._injpick[r]).prop("checked",!0);M(m.dialog.injPick)}),m.dialog.injPickAll.on("click",function(e){$("#injpick-list input").prop("checked",!0)}),m.dialog.injPickNo.on("click",function(e){$("#injpick-list input").prop("checked",!1)}),m.dialog.injPickOK.on("click",function(e){var a=$(w._ijkey+"list"),r=[];w._injpick=a.find("input").each(function(e,a){var o=$(a),t=o.attr("id").slice(8);o.is(":checked")&&r.push(t)}),w._injpick=r,m.dialog.injPick.hide()}),m.dialog.kickVoteY.on("click",function(e){F("kickVote",{agree:!0}),clearTimeout(w._kickTimer),m.dialog.kickVote.hide()}),m.dialog.kickVoteN.on("click",function(e){F("kickVote",{agree:!1}),clearTimeout(w._kickTimer),m.dialog.kickVote.hide()}),m.dialog.purchaseOK.on("click",function(e){$.post("/buy/"+w._sgood,function(e){var a=w.users[w.id];if(e.error)return va(e.error);alert(L.purchased),a.money=e.money,a.box=e.box,Z()}),m.dialog.purchase.hide()}),m.dialog.purchaseNO.on("click",function(e){m.dialog.purchase.hide()}),m.dialog.obtainOK.on("click",function(e){var a=w._obtain.shift();a?ga(a):m.dialog.obtain.hide()}),r=0;r<5;r++)$("#team-"+r).on("click",k);function k(e){$(".team-selector").hasClass("team-unable")||F("team",{value:$(e.currentTarget).attr("id").slice(5)})}function y(){(d=new x(w.URL)).onopen=function(e){N()},d.onmessage=_onMessage=function(e){J(JSON.parse(e.data))},d.onclose=function(e){var a=L.closed+" (#"+e.code+")";c&&c.close(),ra(),alert(a),$.get("/kkutu_notice.html",function(e){N(e)})},d.onerror=function(e){console.warn(L.error,e)}}$("#replay-file").on("change",function(e){var a=e.target.files[0],r=new FileReader,o=$("#replay-date").html("-"),t=$("#replay-version").html("-"),i=$("#replay-players").html("-");u=!1,m.dialog.replayView.attr("disabled",!0),a&&(r.readAsText(a),r.onload=function(e){var a,r;try{for(a in r=JSON.parse(e.target.result),o.html(new Date(r.time).toLocaleString()),t.html(r.version),i.empty(),r.players){var s,n=r.players[a];i.append(s=$("<div>").addClass("replay-player-bar ellipse").html(n.title).prepend(Ye(n.data.score).addClass("users-level"))),n.id==r.me&&s.css("font-weight","bold")}u=r,m.dialog.replayView.attr("disabled",!1)}catch(e){return console.warn(e),alert(L.replayError)}})}),m.dialog.replayView.on("click",function(e){!function(){var e;for(e in Se(),w._replay=!0,w.room={title:u.title,players:[],events:[],time:u.roundTime,round:u.round,mode:u.mode,limit:u.limit,game:u.game,opts:u.opts,readies:u.readies},ye(),u.events)w.room.events.push(u.events[e]);m.box.userList.hide(),m.box.roomList.hide(),m.box.game.show(),m.dialog.replay.hide(),_e(),le(!0),w.$gp=$(".GameBox .product-title").empty().append(w.$gpt=$("<div>").addClass("game-replay-title")).append(w.$gpc=$("<div>").addClass("game-replay-controller").append($("<button>").html(L.replayNext).on("click",Le)).append($("<button>").html(L.replayPause).on("click",Ce)).append($("<button>").html(L.replayPrev).on("click",we))),w._gpp=L.replay+" - "+new Date(u.time).toLocaleString(),w._gtt=w.room.events[w.room.events.length-1].time,w._eventTime=0,w._rt=G(xe,2e3),w._rprev=0,w._rpause=!1,Te()}()}),I(function(){A>0?A=0:B>0&&(B-=.03)},1e3)}),C.Classic.roundReady=function(e){w.room.game.title.length;De(),w._roundTime=1e3*w.room.time,m.game.display.html(Ve(e.char,e.subChar)),m.game.chain.show().html(w.chain=0),w.room.opts.mission&&m.game.items.show().css("opacity",1).html(w.mission=e.mission),"KAP"==a[w.room.mode]&&$(".jjoDisplayBar .graph-bar").css({float:"right","text-align":"left"}),qe(e.round),aa("round_start"),je("roundReady")},C.Classic.turnStart=function(e){w.room.game.turn=e.turn,e.seq&&(w.room.game.seq=e.seq),(w._tid=w.room.game.seq[e.turn])&&(w._tid.robot&&(w._tid=w._tid.id),e.id=w._tid,m.game.display.html(w._char=Ve(e.char,e.subChar,e.wordLength)),$("#game-user-"+e.id).addClass("game-user-current"),w._replay||(m.game.here.css("display",e.id==w.id?"block":"none"),e.id==w.id&&(p?m.game.hereText.val("").focus():m.talk.focus())),m.game.items.html(w.mission=e.mission),d.onmessage=_onMessage,clearInterval(w._tTime),w._chars=[e.char,e.subChar],w._speed=e.speed,w._tTime=I(Oe,h),w.turnTime=e.turnTime,w._turnTime=e.turnTime,w._roundTime=e.roundTime,w._turnSound=aa("T"+e.speed),je("turnStart"))},C.Classic.turnGoing=function(){w.room||clearInterval(w._tTime),w._turnTime-=h,w._roundTime-=h,m.game.turnBar.width(w._timePercent()).html((.001*w._turnTime).toFixed(1)+L.SECOND),m.game.roundBar.width(w._roundTime/w.room.time*.1+"%").html((.001*w._roundTime).toFixed(1)+L.SECOND),m.game.roundBar.hasClass("round-extreme")||w._roundTime<=5e3&&m.game.roundBar.addClass("round-extreme")},C.Classic.turnEnd=function(e,r){var o,t=$("<div>").addClass("deltaScore").html(r.score>0?"+"+(r.score-r.bonus):r.score),i=$(".game-user-current");w._turnSound&&w._turnSound.stop(),Be(e,r.score),clearInterval(w._tTime),r.ok?(ke(),clearTimeout(w._fail),m.game.here.hide(),m.game.chain.html(++w.chain),Ge(r.value,r.mean,r.theme,r.wc)):(ke(e),t.addClass("lost"),$(".game-user-current").addClass("game-user-bomb"),m.game.here.hide(),aa("timeout")),r.hint&&(r.hint=r.hint._id,-1==(o=r.hint.indexOf(w._chars[0]))&&(o=r.hint.indexOf(w._chars[1])),"KAP"==a[w.room.mode]?m.game.display.empty().append($("<label>").css("color","#AAAAAA").html(r.hint.slice(0,o))).append($("<label>").html(r.hint.slice(o))):m.game.display.empty().append($("<label>").html(r.hint.slice(0,o+1))).append($("<label>").css("color","#AAAAAA").html(r.hint.slice(o+1)))),r.bonus&&(p?t.html("+"+(b.score-b.bonus)+"+"+b.bonus):G(function(){var e=$("<div>").addClass("deltaScore bonus").html("+"+r.bonus);Ae(i,e)},500)),Ae(i,t).removeClass("game-user-current"),ce(e,Re(e))},C.Jaqwi.roundReady=function(e){var a=L.jqTheme+": "+L["theme_"+e.theme];De(),w._roundTime=1e3*w.room.time,w._fastTime=1e4,m.game.display.html(a),m.game.items.hide(),m.game.hints.show(),$(".jjo-turn-time .graph-bar").width("100%").html(a).css("text-align","center"),qe(e.round),aa("round_start"),clearInterval(w._tTime)},C.Jaqwi.turnStart=function(e){$(".game-user-current").removeClass("game-user-current"),$(".game-user-bomb").removeClass("game-user-bomb"),w.room.game.seq.indexOf(w.id)>=0&&m.game.here.show(),m.game.display.html(w._char=e.char),clearInterval(w._tTime),w._tTime=I(Oe,h),Ze("jaqwi")},C.Jaqwi.turnGoing=function(){var e,a,r=m.game.roundBar;w.room||clearInterval(w._tTime),w._roundTime-=h,a=w._spectate?L.stat_spectate:(.001*w._roundTime).toFixed(1)+L.SECOND,r.width(w._roundTime/w.room.time*.1+"%").html(a),r.hasClass("round-extreme")||w._roundTime<=w._fastTime&&(e=w.bgm.currentTime/w.bgm.duration,w.bgm.paused?ea():Ze("jaqwiF"),w.bgm.currentTime=w.bgm.duration*e,r.addClass("round-extreme"))},C.Jaqwi.turnHint=function(e){aa("mission"),Ke(e.hint)},C.Jaqwi.turnEnd=function(e,a){var r=$("<div>").addClass("deltaScore").html("+"+a.score),o=$("#game-user-"+e);a.giveup?o.addClass("game-user-bomb"):a.answer?(m.game.here.hide(),m.game.display.html($("<label>").css("color","#FFFF44").html(a.answer)),ea(),aa("horr")):(e==w.id&&m.game.here.hide(),Be(e,a.score),w._roundTime>1e4&&(w._roundTime=1e4),Ae(o,r),ce(e,Re(e)).addClass("game-user-current"),aa("success"))},C.Crossword.roundReady=function(e,a){var r=e.seq?e.seq.indexOf(w.id):-1;De(),$(".jjoriping,.rounds,.game-body").addClass("cw"),w._roundTime=1e3*w.room.time,w._fastTime=3e4,w.selectedRound=-1==r?1:r%w.room.round+1,m.game.items.hide(),m.game.cwcmd.show().css("opacity",0),qe(w.selectedRound),a||aa("round_start"),clearInterval(w._tTime)},C.Crossword.turnEnd=function(e,a){var r,o,t=$("<div>").addClass("deltaScore").html("+"+a.score),i=$("#game-user-"+e);a.score?(o=a.pos.join(","),e==w.id?(m.game.cwcmd.css("opacity",0),aa("success")):(w._sel&&a.pos.join(",")==w._sel.join(",")&&m.game.cwcmd.css("opacity",0),aa("mission")),w._bdb[o][4]=a.value,w._bdb[o][5]=e,a.pos[0]==w.selectedRound-1?C.Crossword.drawDisplay():(r=$(m.game.round.children("label").get(a.pos[0])).addClass("round-effect"),G(function(){r.removeClass("round-effect")},800)),Be(e,a.score),ce(e,Re(e)),Ae(i,t)):(ea(),m.game.round.empty(),aa("horr"))},C.Crossword.drawDisplay=function(){var e,a,r,o,t,i,s,n,l,d=12.5,c=w._boards[w.selectedRound-1],u=m.game.display.empty(),p={};for(a in c)for(o=Number(c[a][0]),t=Number(c[a][1]),i="1"==c[a][2],s=Number(c[a][3]),n=c[a][4],u.append(e=$("<div>").addClass("cw-bar").attr("id","cw-"+o+"-"+t+"-"+c[a][2]).css({top:t*d+"%",left:o*d+"%",width:(i?1:s)*d+"%",height:(i?s:1)*d+"%"})),n&&e.addClass("cw-open"),c[a][5]==w.id?e.addClass("cw-my-open"):e.on("click",C.Crossword.onBar).on("mouseleave",C.Crossword.onSwap),r=0;r<s;r++)l=o+"-"+t,n&&(p[l]=n.charAt(r)),e.append($("<div>").addClass("cw-cell").attr("id","cwc-"+l).html(p[l]||"")),i?t++:o++},C.Crossword.onSwap=function(e){m.game.display.prepend($(e.currentTarget))},C.Crossword.onRound=function(e){var a=$(e.currentTarget).html().charCodeAt(0)-9311;qe(w.selectedRound=a),$(".rounds label").on("click",C.Crossword.onRound),C.Crossword.drawDisplay()},C.Crossword.onBar=function(e){var a=$(e.currentTarget).attr("id").slice(3).split("-"),r=w._means[w.selectedRound-1][a.join(",")],o="1"==r.dir;m.game.cwcmd.css("opacity",1),w._sel=[w.selectedRound-1,a[0],a[1],a[2]],$(".cw-q-head").html(L[o?"cwVert":"cwHorz"]+r.len+L.cwL),$("#cw-q-input").val("").focus(),$(".cw-q-body").html(Ue("★",r.mean,r.theme,r.type.split(",")))},C.Crossword.turnStart=function(e,a){var r,o;for(r in w._bdb={},w._boards=e.boards,w._means=e.means,e.boards)for(o in e.boards[r])w._bdb[[r,e.boards[r][o][0],e.boards[r][o][1],e.boards[r][o][2]].join(",")]=e.boards[r][o];$(".rounds label").on("click",C.Crossword.onRound),C.Crossword.drawDisplay(),clearInterval(w._tTime),w._tTime=I(Oe,h),Ze("jaqwi")},C.Crossword.turnGoing=C.Jaqwi.turnGoing,C.Crossword.turnHint=function(e){aa("fail")},C.Typing.roundReady=function(e){w.room.game.title.length;w._chatter=p?m.game.hereText:m.talk,De(),w._round=e.round,w._roundTime=1e3*w.room.time,w._fastTime=1e4,w._list=e.list.concat(e.list),w.chain=0,q(),qe(e.round),aa("round_start"),je("roundReady")},C.Typing.spaceOn=function(){w.room.opts.proverb||(w._spaced=!0,$("body").on("keydown","#"+w._chatter.attr("id"),D))},C.Typing.spaceOff=function(){delete w._spaced,$("body").off("keydown","#"+w._chatter.attr("id"),D)},C.Typing.turnStart=function(e){w._spectate||(m.game.here.show(),p?m.game.hereText.val("").focus():m.talk.val("").focus(),C.Typing.spaceOn()),d.onmessage=_onMessage,clearInterval(w._tTime),w._tTime=I(Oe,h),w._roundTime=e.roundTime,Ze("jaqwi"),je("turnStart")},C.Typing.turnGoing=C.Jaqwi.turnGoing,C.Typing.turnEnd=function(e,a){var r=$("<div>").addClass("deltaScore").html("+"+a.score),o=$("#game-user-"+e);a.error?(w.chain++,q(),aa("fail")):a.ok?(w.id==e?(w.chain++,q(),aa("mission"),Je(a.value,"")):w._spectate&&aa("mission"),Be(e,a.score),Ae(o,r),ce(e,Re(e))):(clearInterval(w._tTime),C.Typing.spaceOff(),m.game.here.hide(),ea(),aa("horr"),G(R,1e3,a.speed),w._round<w.room.round&&O(10))},C.Hunmin.roundReady=function(e){w.room.game.title.length;De(),w._roundTime=1e3*w.room.time,m.game.display.html(w._char="&lt;"+e.theme+"&gt;"),m.game.chain.show().html(w.chain=0),w.room.opts.mission&&m.game.items.show().css("opacity",1).html(w.mission=e.mission),qe(e.round),aa("round_start"),je("roundReady")},C.Hunmin.turnStart=function(e){w.room.game.turn=e.turn,e.seq&&(w.room.game.seq=e.seq),w._tid=w.room.game.seq[e.turn],w._tid.robot&&(w._tid=w._tid.id),e.id=w._tid,m.game.display.html(w._char),$("#game-user-"+e.id).addClass("game-user-current"),w._replay||(m.game.here.css("display",e.id==w.id?"block":"none"),e.id==w.id&&(p?m.game.hereText.val("").focus():m.talk.focus())),m.game.items.html(w.mission=e.mission),d.onmessage=_onMessage,clearInterval(w._tTime),w._chars=[e.char,e.subChar],w._speed=e.speed,w._tTime=I(Oe,h),w.turnTime=e.turnTime,w._turnTime=e.turnTime,w._roundTime=e.roundTime,w._turnSound=aa("T"+e.speed),je("turnStart")},C.Hunmin.turnGoing=C.Classic.turnGoing,C.Hunmin.turnEnd=function(e,a){var r,o=$("<div>").addClass("deltaScore").html(a.score>0?"+"+(a.score-a.bonus):a.score),t=$(".game-user-current");w._turnSound.stop(),Be(e,a.score),clearInterval(w._tTime),a.ok?(clearTimeout(w._fail),m.game.here.hide(),m.game.chain.html(++w.chain),Ge(a.value,a.mean,a.theme,a.wc)):(o.addClass("lost"),$(".game-user-current").addClass("game-user-bomb"),m.game.here.hide(),aa("timeout")),a.hint&&(a.hint=a.hint._id,-1==(r=a.hint.indexOf(w._chars[0]))&&(r=a.hint.indexOf(w._chars[1])),m.game.display.empty().append($("<label>").html(a.hint.slice(0,r+1))).append($("<label>").css("color","#AAAAAA").html(a.hint.slice(r+1)))),a.bonus&&(p?o.html("+"+(b.score-b.bonus)+"+"+b.bonus):G(function(){var e=$("<div>").addClass("deltaScore bonus").html("+"+a.bonus);Ae(t,e)},500)),Ae(t,o).removeClass("game-user-current"),ce(e,Re(e))},C.Daneo.roundReady=function(e){w.room.game.title.length;De(),w._roundTime=1e3*w.room.time,m.game.display.html(w._char="&lt;"+L["theme_"+e.theme]+"&gt;"),m.game.chain.show().html(w.chain=0),w.room.opts.mission&&m.game.items.show().css("opacity",1).html(w.mission=e.mission),qe(e.round),aa("round_start"),je("roundReady")},C.Daneo.turnStart=function(e){w.room.game.turn=e.turn,e.seq&&(w.room.game.seq=e.seq),w._tid=w.room.game.seq[e.turn],w._tid.robot&&(w._tid=w._tid.id),e.id=w._tid,m.game.display.html(w._char),$("#game-user-"+e.id).addClass("game-user-current"),w._replay||(m.game.here.css("display",e.id==w.id?"block":"none"),e.id==w.id&&(p?m.game.hereText.val("").focus():m.talk.focus())),m.game.items.html(w.mission=e.mission),d.onmessage=_onMessage,clearInterval(w._tTime),w._chars=[e.char,e.subChar],w._speed=e.speed,w._tTime=I(Oe,h),w.turnTime=e.turnTime,w._turnTime=e.turnTime,w._roundTime=e.roundTime,w._turnSound=aa("T"+e.speed),je("turnStart")},C.Daneo.turnGoing=C.Classic.turnGoing,C.Daneo.turnEnd=function(e,a){var r,o=$("<div>").addClass("deltaScore").html(a.score>0?"+"+(a.score-a.bonus):a.score),t=$(".game-user-current");w._turnSound.stop(),Be(e,a.score),clearInterval(w._tTime),a.ok?(clearTimeout(w._fail),m.game.here.hide(),m.game.chain.html(++w.chain),Ge(a.value,a.mean,a.theme,a.wc)):(o.addClass("lost"),$(".game-user-current").addClass("game-user-bomb"),m.game.here.hide(),aa("timeout")),a.hint&&(a.hint=a.hint._id,-1==(r=a.hint.indexOf(w._chars[0]))&&(r=a.hint.indexOf(w._chars[1])),m.game.display.empty().append($("<label>").html(a.hint.slice(0,r+1))).append($("<label>").css("color","#AAAAAA").html(a.hint.slice(r+1)))),a.bonus&&(p?o.html("+"+(b.score-b.bonus)+"+"+b.bonus):G(function(){var e=$("<div>").addClass("deltaScore bonus").html("+"+a.bonus);Ae(t,e)},500)),Ae(t,o).removeClass("game-user-current"),ce(e,Re(e))},C.Sock.roundReady=function(e,r){e.seq&&e.seq.indexOf(w.id);De(),w._relay=!0,$(".jjoriping,.rounds,.game-body").addClass("cw"),w._va=[],w._lang=n[a[w.room.mode]].lang,w._board=e.board,w._maps=[],w._roundTime=1e3*w.room.time,w._fastTime=1e4,m.game.items.hide(),m.game.bb.show(),C.Sock.drawDisplay(),qe(e.round),r||aa("round_start"),clearInterval(w._tTime)},C.Sock.turnEnd=function(e,a){var r,o,t,i=$("<div>").addClass("deltaScore").html("+"+a.score),s=$("#game-user-"+e);if(a.score){for(t=(r=a.value).length,w._maps.push(r),o=0;o<t;o++)w._board=w._board.replace(r.charAt(o),"　");e==w.id?aa("success"):aa("mission"),C.Sock.drawDisplay(),Be(e,a.score),ce(e,Re(e)),Ae(s,i)}else ea(),w._relay=!1,aa("horr")},C.Sock.drawMaps=function(){m.game.bb.empty(),w._maps.sort(function(e,a){return a.length-e.length}).forEach(function(e){m.game.bb.append(function(e){var a,r=$("<div>").addClass("bb-word"),o=e.length;for(a=0;a<o;a++)r.append($("<div>").addClass("bb-char").html(e.charAt(a)));return r}(e))})},C.Sock.drawDisplay=function(){var e,a=$("<div>").css("height","100%"),r=w._board.split(""),o="ko"==w._lang?"12.5%":"10%";r.forEach(function(r,t){a.append(e=$("<div>").addClass("sock-char sock-"+r).css({width:o,height:o}).html(r)),w._va[t]&&w._va[t]!=r&&e.html(w._va[t]).addClass("sock-picked").animate({opacity:0},500)}),w._va=r,m.game.display.empty().append(a),C.Sock.drawMaps()},C.Sock.turnStart=function(e,a){clearInterval(w._tTime),w._tTime=I(Oe,h),Ze("jaqwi")},C.Sock.turnGoing=C.Jaqwi.turnGoing,C.Sock.turnHint=function(e){aa("fail")},C.Drawing.roundReady=function(e,a){L.jqTheme,L["theme_"+e.theme];De(),$(".jjoriping,.rounds,.game-body").addClass("cw"),$(".jjoriping,.rounds").addClass("dg"),$(".game-user-drawing").removeClass("game-user-drawing"),m.game.tools.hide(),w._relay=!1,w._roundTime=1e3*w.room.time,w._fastTime=1e4,w._fullImageString="",m.game.items.hide(),m.game.hints.show(),m.game.cwcmd.show().css("opacity",0),w.id===e.painter?(console.log("i'm painter!"),w._isPainter=!0):w._isPainter=!1,$("#game-user-"+e.painter).addClass("game-user-drawing"),qe(e.round),aa("round_start"),clearInterval(w._tTime)},C.Drawing.turnStart=function(e,a){$(".game-user-current").removeClass("game-user-current"),$(".game-user-bomb").removeClass("game-user-bomb"),w.room.game.seq.indexOf(w.id)>=0&&(w._isPainter?($("#drawing-line-width").change(function(){console.log(this.value),m.game.canvas.freeDrawingBrush.width=this.value,F("drawingCanvas",{data:JSON.stringify(m.game.canvas)},!1)}),$("#drawing-color").change(function(){console.log(this.value),m.game.canvas.freeDrawingBrush.color=this.value,F("drawingCanvas",{data:JSON.stringify(m.game.canvas)},!1)}),$("#drawing-clear").click(function(){console.log("clear"),m.game.canvas.clear(),F("drawingCanvas",{data:JSON.stringify(m.game.canvas)},!1)}),$(".button-color#color-red").click(function(){console.log("change red"),m.game.canvas.freeDrawingBrush.color="#FF0000",F("drawingCanvas",{data:JSON.stringify(m.game.canvas)},!1)}),$(".button-color#color-orange").click(function(){console.log("change orange"),m.game.canvas.freeDrawingBrush.color="#FFA500",F("drawingCanvas",{data:JSON.stringify(m.game.canvas)},!1)}),$(".button-color#color-yellow").click(function(){console.log("change yellow"),m.game.canvas.freeDrawingBrush.color="#FFFF00",F("drawingCanvas",{data:JSON.stringify(m.game.canvas)},!1)}),$(".button-color#color-green").click(function(){console.log("change green"),m.game.canvas.freeDrawingBrush.color="#008000",F("drawingCanvas",{data:JSON.stringify(m.game.canvas)},!1)}),$(".button-color#color-blue").click(function(){console.log("change blue"),m.game.canvas.freeDrawingBrush.color="#0000FF",F("drawingCanvas",{data:JSON.stringify(m.game.canvas)},!1)}),$(".button-color#color-indigo").click(function(){console.log("change indigo"),m.game.canvas.freeDrawingBrush.color="#4B0082",F("drawingCanvas",{data:JSON.stringify(m.game.canvas)},!1)}),$(".button-color#color-violet").click(function(){console.log("change red"),m.game.canvas.freeDrawingBrush.color="#9400D3",F("drawingCanvas",{data:JSON.stringify(m.game.canvas)},!1)}),$(".button-color#color-black").click(function(){console.log("change black"),m.game.canvas.freeDrawingBrush.color="#000000",F("drawingCanvas",{data:JSON.stringify(m.game.canvas)},!1)}),$(".button-color#color-white").click(function(){console.log("change white"),m.game.canvas.freeDrawingBrush.color="#FFFFFF",F("drawingCanvas",{data:JSON.stringify(m.game.canvas)},!1)}),m.game.drawingTitle.text(e.word),m.game.themeisTitle.text(L["theme_"+e.theme]),m.game.hints.hide(),m.game.tools.show(),$(".rounds").removeClass("dg"),$(".rounds").addClass("painter")):(m.game.hints.show(),m.game.tools.hide(),w._relay=!0)),C.Drawing.drawDisplay(),clearInterval(w._tTime),w._tTime=I(Oe,h),Ze("jaqwi")},C.Drawing.turnHint=function(e){var a;a=Array.isArray(e.hint)?L["theme_"+e.hint[0]]:e.hint,aa("mission"),Ke(a)},C.Drawing.turnEnd=function(e,a){var r=$("<div>").addClass("deltaScore").html("+"+a.score),o=$("#game-user-"+e);a.giveup?(o.addClass("game-user-bomb"),w._relay=!1):a.answer?(m.game.here.hide(),m.game.display.html($("<label>").css("color","#FFFF44").html(a.answer)),ea(),aa("horr"),w._relay=!1):(e==w.id&&m.game.here.hide(),Be(e,a.score),w._roundTime>1e4&&(w._roundTime=1e4),Ae(o,r),ce(e,Re(e)).addClass("game-user-current"),aa("success"))},C.Drawing.drawDisplay=function(){m.game.display.empty().append($("<canvas>").attr("id","canvas").css({width:"300",height:"300",left:0,top:0}).addClass("canvas"));var e=window._canvas=new fabric.Canvas("canvas");e.backgroundColor="#ffffff",e.isDrawingMode=w._isPainter,e.setHeight(300),e.setWidth(300),e.selection=!1,$("#drawing-line-width").val(20),$("#drawing-color").val("#000000"),w._isPainter&&e.on("mouse:up",function(a){var r=JSON.stringify(e),o=window.differ.patch_make(w._fullImageString,r);F("drawingCanvas",{diffed:!0,data:o=window.differ.patch_toText(o)},!1),w._fullImageString=r}),e.renderAll(),m.game.canvas=e},C.Drawing.turnGoing=function(){var e,a,r=m.game.roundBar;w.room||clearInterval(w._tTime),w._roundTime-=h,a=w._spectate?L.stat_spectate:(.001*w._roundTime).toFixed(1)+L.SECOND,r.width(w._roundTime/w.room.time*.1+"%").html(a),r.hasClass("round-extreme")||w._roundTime<=w._fastTime&&(e=w.bgm.currentTime/w.bgm.duration,w.bgm.paused?ea():Ze("jaqwiF"),w.bgm.currentTime=w.bgm.duration*e,r.addClass("round-extreme"))},C.Drawing.drawCanvas=function(e){if(!w._isPainter){var a="";if(e.diffed){var r=window.differ.patch_fromText(e.data),o=window.differ.patch_apply(r,w._fullImageString);o[1]?a=o[0]:F("canvasNotValid",{},!1)}else a=e.data;m.game.canvas.clear(),m.game.canvas.loadFromJSON(a,m.game.canvas.renderAll.bind(m.game.canvas)),w._fullImageString=a}},C.Drawing.diffNotValid=function(e){w._isPainter&&F("drawingCanvas",{diffed:!1,data:w._fullImageString},!1)};var B=0,A=0;function P(e,a){var r=e.toString();return"000000000000000".slice(0,Math.max(0,a-r.length))+r}function F(e,a,r){var o,t={type:e},i=r?d:c||d;for(o in a)t[o]=a[o];if("test"!=e&&A++>10){if(++B>=3)return i.close();A=5}i.send(JSON.stringify(t))}function N(e){e?$("#Intro").is(":visible")?(m.loading.hide(),$("#intro-text").html(e)):m.loading.show().html(e):m.loading.hide()}function M(e,a){var r=[$(window).width(),$(window).height()];return!a&&e.is(":visible")?(e.hide(),!1):($(".dialog-front").removeClass("dialog-front"),e.show().addClass("dialog-front").css({left:.5*(r[0]-e.width()),top:.5*(r[1]-e.height())}),!0)}function E(e){w.opts=e,w.muteBGM=w.opts.mb,w.muteEff=w.opts.me,$("#mute-bgm").attr("checked",w.muteBGM),$("#mute-effect").attr("checked",w.muteEff),$("#deny-invite").attr("checked",w.opts.di),$("#deny-whisper").attr("checked",w.opts.dw),$("#deny-friend").attr("checked",w.opts.df),$("#auto-ready").attr("checked",w.opts.ar),$("#sort-user").attr("checked",w.opts.su),$("#only-waiting").attr("checked",w.opts.ow),$("#only-unlock").attr("checked",w.opts.ou),w.bgm&&(w.muteBGM?(w.bgm.volume=0,w.bgm.stop()):(w.bgm.volume=1,w.bgm=Ze(w.bgm.key,!0)))}function I(e,a,r,o,t,i,s){var n=S(e,a,r,o,t,i,s);return w._timers.push(n),n}function G(e,a,r,o,t,i,s){var n=j(e,a,r,o,t,i,s);return w._timers.push(n),n}function K(e,r,o,t,i,s){if(w.room){var l=n[a[w.room.mode]];if(!l)return null;C[l.rule][e].call(this,r,o,t,i,s)}}function J(e){var a,r,o,t,i,s,n,l,p;switch(e.type){case"recaptcha":var g=$("#intro-text");g.empty(),g.html("게스트는 캡챠 인증이 필요합니다.<br/>로그인을 하시면 캡챠 인증을 건너뛰실 수 있습니다.<br/><br/>"),g.append($('<div class="g-recaptcha" id="recaptcha" style="display: table; margin: 0 auto;"></div>')),grecaptcha.render("recaptcha",{sitekey:e.siteKey,callback:function(e){d.send(JSON.stringify({type:"recaptcha",token:e}))}});break;case"welcome":w.id=e.id,w.guest=e.guest,w.admin=e.admin,w.users=e.users,w.robots={},w.rooms=e.rooms,w.place=0,w.friends=e.friends,w._friends={},w._playTime=e.playTime,w._okg=e.okg,w._gaming=!1,w.box=e.box,e.test&&alert(L.welcomeTestServer),location.hash[1]&&oa(location.hash.slice(1)),z(void 0,!0),Ze("lobby"),$("#Intro").animate({opacity:1},1e3).animate({opacity:0},1e3),$("#intro-text").text(L.welcome),G(function(){$("#Intro").hide()},2e3),w.admin&&console.log("관리자 모드"),e.caj&&function(){if(!confirm(L.checkAgeAsk))return F("caj",{answer:"no"},!0);for(;;){for(var e=[],a=1;a<=3;){var r=prompt(L["checkAgeInput"+a]);if(r&&!isNaN(r=Number(r)))1==a&&(r<1e3||r>2999)||2==a&&(r<1||r>12)||3==a&&(r<1||r>31)?alert(r+"\n"+L.checkAgeNo):e[a++-1]=r;else if(--a<1)break}if(4==a){if(confirm(L.checkAgeSure+"\n"+e[0]+L.YEAR+" "+e[1]+L.MONTH+" "+e[2]+L.DATE))return F("caj",{answer:"yes",input:[e[1],e[2],e[0]]},!0)}else if(confirm(L.checkAgeCancel))return F("caj",{answer:"no"},!0)}}(),ve();break;case"conn":w.setUser(e.user.id,e.user),ae();break;case"disconn":w.setUser(e.id,null),ae();break;case"connRoom":w._preQuick&&(aa("success"),m.dialog.quick.hide(),delete w._preQuick),m.dialog.quick.hide(),w.setUser(e.user.id,e.user),(r=w.usersR[e.user.id]=e.user).id==w.id?N():na((r.profile.title||r.profile.name)+L.hasJoined),ae();break;case"disconnRoom":(r=w.usersR[e.id])&&(delete w.usersR[e.id],na((r.profile.title||r.profile.name)+L.hasLeft),ae());break;case"yell":ba(e.value),na(e.value,L.yell);break;case"dying":ba(L.dying),na(L.dying,L.yell);break;case"tail":na(e.a+"|"+e.rid+"@"+e.id+": "+(e.msg instanceof String?e.msg:JSON.stringify(e.msg)).replace(/</g,"&lt;").replace(/>/g,"&gt;"),"tail");break;case"chat":e.notice?na(L["error_"+e.code]):sa(e.profile||{title:L.robot},e.value,e.from,e.timestamp);break;case"drawCanvas":m.game.canvas&&function(e){K("drawCanvas",e)}(e);break;case"diffNotValid":m.game.canvas&&function(e){K("diffNotValid",e)}(e);case"roomStuck":c.close();break;case"preRoom":n=e.channel,l=e.id,p=w.URL.replace(/:(\d+)/,function(e,a){return":"+(Number(a)+416+Number(n)-1)})+"&"+n+"&"+l,c||(c=new x(p),N(L.connectToRoom+"\n<center><button id='ctr-close'>"+L.ctrCancel+"</button></center>"),$("#ctr-close").on("click",function(){N(),c&&c.close()}),c.onopen=function(e){console.log("room-conn",n,l)},c.onmessage=_onMessage,c.onclose=function(e){console.log("room-disc",n,l),c=void 0},c.onerror=function(e){console.warn(L.error,e)});break;case"room":Y(e),function(e){if(!w._players)return;if(!w.room)return;var a,r,o={}+"",t=w._players.split(",");t.length,w.room.players.length;for(a in t)t[a]==o&&0;for(a in w.room.players)w.room.players[a].robot&&0;if(e){for(a in t)t[a]!=o&&(w.users[t[a]].game.ready=!1);na(L.hasModified)}w._gaming!=w.room.gaming&&(w.room.gaming?(_e(),w._replay=!1,function(){var e,a;for(e in u={version:w.version,me:w.id,players:[],events:[],title:w.room.title,roundTime:w.room.time,round:w.room.round,mode:w.room.mode,limit:w.room.limit,game:w.room.game,opts:w.room.opts,readies:w.room.readies,time:(new Date).getTime()},w.room.players){var r;r={id:(a=w.users[w.room.players[e]]||w.room.players[e]).id,score:0},a.robot?(r.id=a.id,r.robot=!0,r.data={score:0},a={profile:ne(a.level)}):(r.data=a.data,r.equip=a.equip),r.title="#"+a.id,u.players.push(r)}w._record=!0}(w.room.game.title)):(w._spectate?(m.dialog.resultSave.hide(),w._spectate=!1,Ze("lobby")):(m.dialog.resultSave.show(),w.resulting=!0),clearInterval(w._tTime)));w._master!=w.room.master&&na(((r=w.users[w.room.master]).profile.title||r.profile.name)+L.hasMaster);w._players=w.room.players.toString(),w._master=w.room.master,w._gaming=w.room.gaming}(e.modify&&e.myRoom),z(e.myRoom),e.modify&&w.room&&e.myRoom&&(w._rTitle!=w.room.title&&X(".room-head-title"),w._rMode!=ze(w.room.mode,w.room.opts,!0)&&X(".room-head-mode"),w._rLimit!=w.room.limit&&X(".room-head-limit"),w._rRound!=w.room.round&&X(".room-head-round"),w._rTime!=w.room.time&&X(".room-head-time"));break;case"user":w.setUser(e.id,e),w.room&&z(w.room.id==e.place);break;case"friends":for(a in w._friends={},e.list)e.list[a].forEach(function(e){w._friends[e]={server:a}});ve();break;case"friend":w._friends[e.id]={server:"on"==e.stat&&e.s},w._friends[e.id]&&w.friends[e.id]&&na(("on"==e.stat?"&lt;<b>"+L["server_"+w._friends[e.id].server]+"</b>&gt; ":"")+L.friend+" "+w.friends[e.id]+L["fstat_"+e.stat]),ve();break;case"friendAdd":r=w.users[e.from].profile,a=(r.title||r.name)+"(#"+e.from.substr(0,5)+")",F("friendAddRes",{from:e.from,res:!w.opts.df&&confirm(a+L.attemptFriendAdd)},!0);break;case"friendAddRes":r=w.users[e.target].profile,na((a=(r.title||r.name)+"(#"+e.target.substr(0,5)+")")+L["friendAddRes_"+(e.res?"ok":"no")]),e.res&&(w.friends[e.target]=r.title||r.name,w._friends[e.target]={server:w.server},ve());break;case"friendEdit":w.friends=e.friends,ve();break;case"starting":N(L.gameLoading);break;case"roundReady":K("roundReady",e);break;case"turnStart":K("turnStart",e);break;case"turnError":i=e.code,s=e.value,m.game.display.empty().append($("<label>").addClass("game-fail-text").text((L["turnError_"+i]?L["turnError_"+i]+": ":"")+s)),aa("fail"),clearTimeout(w._fail),w._fail=G(function(){m.game.display.html(w._char)},1800);break;case"turnHint":K("turnHint",e);break;case"turnEnd":e.score=Number(e.score),e.bonus=Number(e.bonus),w.room&&(w._tid=e.target||w.room.game.seq[w.room.game.turn],w._tid&&(w._tid.robot&&(w._tid=w._tid.id),function(e,a){K("turnEnd",e,a)}(w._tid,e)),e.baby&&aa("success"));break;case"roundEnd":for(a in e.users)w.setUser(a,e.users[a]);w._resultRank=e.ranks,function(e,a){a||(a={});var r,o,t,i,s,n,l,d,c,p=$(".result-board").empty();for(r in $(".result-me-expl").empty(),m.game.display.html(L.roundEnd),w._resultPage=1,w._result=null,w._relay=!1,e)t=e[r],(o=w._replay?u.users[t.id]:w.users[t.id])||(o=f),o.data&&t.reward&&(t.reward.score=w._replay?0:Math.round(t.reward.score),n=We(l=o.data.score)>We(o.data.score-t.reward.score),p.append(i=$("<div>").addClass("result-board-item").append(s=$("<div>").addClass("result-board-rank").html(t.rank+1)).append(Ye(l).addClass("result-board-level")).append($("<div>").addClass("result-board-name").html(o.profile.title||o.profile.name)).append($("<div>").addClass("result-board-score").html(a.scores?L.avg+" "+ha(a.scores[t.id])+L.kpm:ha(t.score||0)+L.PTS)).append($("<div>").addClass("result-board-reward").html(t.reward.score?"+"+ha(t.reward.score):"-")).append($("<div>").addClass("result-board-lvup").css("display",n?"block":"none").append($("<i>").addClass("fa fa-arrow-up")).append($("<div>").html(L.lvUp)))),o.game.team&&s.addClass("team-"+o.game.team),t.id==w.id&&(t.exp=o.data.score-t.reward.score,t.level=We(t.exp),w._result=t,i.addClass("result-board-me"),$(".result-me-expl").append(b(t.reward._score,t.reward._money,t.reward._blog))));$(".result-me").css("opacity",0),w._coef=0,w._result&&(d=w._result.reward.score-w._result.reward._score,c=w._result.reward.money-w._result.reward._money,w._result._exp=w._result.exp,w._result._score=w._result.reward.score,w._result._bonus=d,w._result._boing=w._result.reward._score,w._result._addit=d,w._result._addp=c,d=d>0?"<label class='result-me-bonus'>(+"+ha(d)+")</label>":"",c=c>0?"<label class='result-me-bonus'>(+"+ha(c)+")</label>":"",na(L.scoreGain+": "+ha(w._result.reward.score)+", "+L.moneyGain+": "+ha(w._result.reward.money)),$(".result-me").css("opacity",1),$(".result-me-score").html(L.scoreGain+" +"+ha(w._result.reward.score)+d),$(".result-me-money").html(L.moneyGain+" +"+ha(w._result.reward.money)+c));function g(e){var a,r,o;w._result.goal=v[w._result.level-1],w._result.before=v[w._result.level-2]||0,w._result.reward.score>0&&((a=w._result.reward.score*w._coef)<.05&&w._coef&&(a=w._result.reward.score),w._result.reward.score-=a,w._result.exp+=a,r=We(w._result.exp),w._result.level!=r&&(w._result._boing-=w._result.goal-w._result._exp,w._result._exp=w._result.goal,aa("lvup")),w._result.level=r,G(g,50)),o=w._result.exp-w._result._exp,h("before",w._result._exp,w._result.before,w._result.goal),h("current",Math.min(o,w._result._boing),0,w._result.goal-w._result.before),h("bonus",Math.max(0,o-w._result._boing),0,w._result.goal-w._result.before),$(".result-me-level-body").html(w._result.level),$(".result-me-score-text").html(ha(Math.round(w._result.exp))+" / "+ha(w._result.goal))}function h(e,a,r,o){$(".result-me-"+e+"-bar").width((a-r)/(o-r)*100+"%")}function b(e,a,r){var o,t,i=$("<div>").append($("<h4>").html(L.scoreGain)).append(o=$("<div>")).append($("<h4>").html(L.moneyGain)).append(t=$("<div>"));function s(e,a,r){e.append($("<h5>").addClass("result-me-blog-head").html(a)).append($("<h5>").addClass("result-me-blog-body").html(r))}return s(o,L.scoreOrigin,e),s(t,L.moneyOrigin,a),r.forEach(function(r){var i,n,l,d=r.charAt(0),c=r.charAt(1),m=r.slice(2,5),u=Number(r.slice(5));"EXP"==m?(i=o,l=e):"MNY"==m&&(i=t,l=a),"g"==c?n="+"+(l*u).toFixed(1):"h"==c&&(n="+"+Math.floor(u)),s(i,L["bonusFrom_"+d],n)}),i}G(function(){M(m.dialog.result),w._result&&g(!0),m.dialog.result.css("opacity",0).animate({opacity:1},500),G(function(){w._coef=.05},500)},2e3),w._record=!1}(e.result,e.data);break;case"kickVote":w._kickTarget=w.users[e.target],w.id!=e.target&&w.id!=w.room.master&&(o=e.target,t=w.users[o].profile,$("#kick-vote-text").html((t.title||t.name)+L.kickVoteText),w.kickTime=10,w._kickTime=10,w._kickTimer=G(Fe,1e3),M(m.dialog.kickVote)),na((w._kickTarget.profile.title||w._kickTarget.profile.name)+L.kickVoting);break;case"kickDeny":na(U(w._kickTarget.profile,e));break;case"invited":F("inviteRes",{from:e.from,res:!w.opts.di&&confirm(e.from+L.invited)});break;case"inviteNo":na(((r=w.users[e.target]).profile.title||r.profile.name)+L.inviteDenied);break;case"okg":w._playTime>e.time?na(L.okgExpired):w._okg!=e.count&&na(L.okgNotice+" ("+L.okgCurrent+e.count+")"),w._playTime=e.time,w._okg=e.count;break;case"obtain":pa(e);break;case"expired":for(a in e.list)na(ca(e.list[a])+L.hasExpired);break;case"blocked":na(L.blocked);break;case"test":(w._test=!w._test)?(w._testt=I(function(){m.talk.val()!=w._ttv&&(F("test",{ev:"c",v:m.talk.val()},!0),w._ttv=m.talk.val())},100),document.onkeydown=function(e){F("test",{ev:"d",c:e.keyCode},!0)},document.onkeyup=function(e){F("test",{ev:"u",c:e.keyCode},!0)}):(clearInterval(w._testt),document.onkeydown=void 0,document.onkeyup=void 0);break;case"error":if(a=e.message||"",401==e.code);else if(403==e.code)N();else if(406==e.code){if(m.dialog.quick.is(":visible")){w._preQuick=!1;break}}else if(409==e.code)a=L["server_"+a];else{if(416==e.code)return void(confirm(L["error_"+e.code])&&(ea(),w._spectate=!0,w._gaming=!0,F("enter",{id:e.target,password:w._pw,spectate:!0},!0)));if(413==e.code)m.dialog.room.hide(),m.menu.setRoom.trigger("click");else if(429==e.code)Ze("lobby");else if(430==e.code){if(w.setRoom(e.message,null),m.dialog.quick.is(":visible")){w._preQuick=!1;break}}else if(431==e.code||432==e.code||433==e.code)m.dialog.room.show();else{if(444==e.code){if(-1!=(a=e.message).indexOf("생년월일")){alert("생년월일이 올바르게 입력되지 않아 게임 이용이 제한되었습니다. 잠시 후 다시 시도해 주세요.");break}if(!e.blockedUntil)break;var h="\n제한 시점: "+(b=new Date(parseInt(e.blockedUntil))).getFullYear()+"년 "+b.getMonth()+"1월 "+b.getDate()+"일 "+b.getHours()+"시 "+b.getMinutes()+"분까지";alert("[#444] "+L.error_444+a+h);break}if(446==e.code){if(a=e.reasonBlocked,!e.ipBlockedUntil)break;var b;h="\n제한 시점: "+(b=new Date(parseInt(e.ipBlockedUntil))).getFullYear()+"년 "+b.getMonth()+"1월 "+b.getDate()+"일 "+b.getHours()+"시 "+b.getMinutes()+"분까지";alert("[#446] "+L.error_446+a+h);break}if(447===e.code){alert("자동화 봇 방지를 위한 캡챠 인증에 실패했습니다. 메인 화면에서 다시 시도해 주세요.");break}}}alert("[#"+e.code+"] "+L["error_"+e.code]+a)}w._record&&je(e)}function U(e,a){var r=L.agree+" "+a.Y+", "+L.disagree+" "+a.N+L.kickCon;return a.Y>=a.N?r+=(e.title||e.name)+L.kicked:r+=(e.title||e.name)+L.kickDenied,r}function V(e,a){a.length&&(w._whisper=e,F("talk",{whisper:e,value:a},!0),sa({title:"→"+e},a,!0))}function H(e){w._shut.hasOwnProperty(e)?(delete w._shut[e],na(e+L.userNShut)):(w._shut[e]=!0,na(e+L.userShut))}function W(e,a){var r=(e=e.replace(/[^\sa-zA-Zㄱ-ㅎ0-9가-힣]/g,"")).match(/[ㄱ-ㅎ가-힣]/)?"ko":"en";if(e.length<1)return a({error:404});$.get("/dict/"+e+"?lang="+r,a)}function Y(e){var a,r,o,t;if(e.myRoom=w.place==e.room.id||e.target==w.id,e.myRoom){if($target=w.users[e.target],e.kickVote&&(na(U($target.profile,e.kickVote)),$target.id==e.id&&alert(L.hasKicked)),-1==e.room.players.indexOf(w.id))w.room&&w.room.gaming&&(ra(),w.practicing=!1,w._gaming=!1,m.box.room.height(360),Ze("lobby")),w.users[w.id].game.ready=!1,w.users[w.id].game.team=0,w.users[w.id].game.form="J",m.menu.spectate.removeClass("toggled"),m.menu.ready.removeClass("toggled"),w.room=null,w.resulting=!1,w._players=null,w._master=null,w.place=0,e.room.practice&&(delete w.users[0],w.room=w._room,w.place=w._place,w.master=w.__master,w._players=w.__players,delete w._room);else if(e.room.practice&&!w.practicing&&(w.practicing=!0,w._room=w.room,w._place=w.place,w.__master=w.master,w.__players=w._players),w.room&&(w._players=w.room.players.toString(),w._master=w.room.master,w._rTitle=w.room.title,w._rMode=ze(w.room.mode,w.room.opts,!0),w._rLimit=w.room.limit,w._rRound=w.room.round,w._rTime=w.room.time),w.room=e.room,w.place=w.room.id,w.master=w.room.master==w.id,e.spec&&e.target==w.id){if(w._spectate||(w._spectate=!0,De(),qe()),e.boards){for(a in w.selectedRound=1,e.prisoners)for(r in o=a.split(","),e.boards[o[0]])if((t=e.boards[o[0]][r])[0]==o[1]&&t[1]==o[2]&&t[2]==o[3]){t[4]=e.prisoners[a];break}C.Crossword.roundReady(e,!0),C.Crossword.turnStart(e,!0)}for(a in e.spec)w.users[a].game.score=e.spec[a]}e.modify||e.target!=w.id||ta()}if(e.target&&w.users[e.target]&&(-1==e.room.players.indexOf(e.target)?w.users[e.target].place=0:w.users[e.target].place=e.room.id),!e.room.practice)if(e.room.players.length)for(a in w.setRoom(e.room.id,e.room),e.room.readies)w.users[a]&&(w.users[a].game.ready=e.room.readies[a].r,w.users[a].game.team=e.room.readies[a].t);else w.setRoom(e.room.id,null)}function Q(){return w.place?w.room.gaming||w.resulting?"for-gaming":w.master?"for-master":"for-normal":"for-lobby"}function z(e,a){var r,o=Q();if(w._replay){if(void 0!==e&&!e)return;Se()}if(!w._replay&&("for-gaming"!=o||e)){for(r in w.practicing&&(o="for-gaming"),$(".kkutu-menu button").hide(),m.box)m.box[r].hide();var t;m.box.me.show(),m.box.chat.show().width(790).height(190),m.chat.height(120),"for-lobby"==o?(w._ar_first=!0,m.box.userList.show(),w._shop?(m.box.roomList.hide(),m.box.shop.show()):(m.box.roomList.show(),m.box.shop.hide()),ae(a||o!=w._only),function(e){var a,r=0;if(e)for(a in m.lobby.roomList.empty(),w.rooms)m.lobby.roomList.append(te(w.rooms[a])),r++;else for(a in $(".rooms-create").remove(),w.rooms)r++;m.lobby.roomListTitle.html(L.RoomList.replace("FA{bars}","<i class='fa fa-bars'></i>")+" ["+r+L.GAE+"]"),r?($(".rooms-gaming").css("display",w.opts.ow?"none":""),$(".rooms-locked").css("display",w.opts.ou?"none":"")):m.lobby.roomList.append(m.lobby.createBanner.clone().on("click",o));function o(e){m.menu.newRoom.trigger("click")}}(a||o!=w._only),Z(),w._jamsu&&(clearTimeout(w._jamsu),delete w._jamsu)):"for-master"==o||"for-normal"==o?($(".team-chosen").removeClass("team-chosen"),w.users[w.id].game.ready||"S"==w.users[w.id].game.form?(m.menu.ready.addClass("toggled"),$(".team-selector").addClass("team-unable")):(m.menu.ready.removeClass("toggled"),$(".team-selector").removeClass("team-unable"),$("#team-"+w.users[w.id].game.team).addClass("team-chosen"),w.opts.ar&&w._ar_first&&(m.menu.ready.addClass("toggled"),m.menu.ready.trigger("click"),w._ar_first=!1)),w._shop=!1,m.box.room.show().height(360),"for-master"==o&&m.dialog.inviteList.is(":visible")&&ae(),le(!1),Z()):"for-gaming"==o&&(w._gAnim&&(m.box.room.show(),w._gAnim=!1),w._shop=!1,w._ar_first=!0,m.box.me.hide(),m.box.game.show(),$(".ChatBox").width(1e3).height(140),m.chat.height(70),le(!0)),w._only=o,t=w.place,location.hash=t?"#"+t:"",$(".kkutu-menu ."+o).show()}}function X(e){$(e).addClass("room-head-modified"),G(function(){$(e).removeClass("room-head-modified")},3e3)}function Z(){var e,a=w.users[w.id],r=0,o=We(a.data.score),t=v[o-2]||0,i=v[o-1];for(e in a.data.record)r+=a.data.record[e][1];fa(".my-image",a.equip),$(".my-stat-level").replaceWith(Ye(a.data.score).addClass("my-stat-level")),$(".my-stat-name").html(a.profile.title||a.profile.name),$(".my-stat-record").html(L.globalWin+" "+r+L.W),$(".my-stat-ping").html(ha(a.money)+L.ping),$(".my-okg .graph-bar").width(w._playTime%6e5/6e3+"%"),$(".my-okg-text").html(ee(w._playTime)),$(".my-level").html(L.LEVEL+" "+o),$(".my-gauge .graph-bar").width((a.data.score-t)/(i-t)*190),$(".my-gauge-text").html(ha(a.data.score)+" / "+ha(i))}function ee(e){var a=Math.floor(e/6e4)%60,r=Math.floor(.001*e)%60,o=Math.floor(e/36e5),t=[];return o&&t.push(o+L.HOURS),a&&t.push(a+L.MINUTE),o||t.push(r+L.SECOND),t.join(" ")}function ae(e){var a,r,o,t=0;if(w.opts.su){for(a in o=[],w.users)t++,o.push(w.users[a]);o.sort(function(e,a){return a.data.score-e.data.score}),e=!0}else for(a in o=w.users,w.users)t++;if(m.lobby.userListTitle.html("<i class='fa fa-users'></i>&lt;<b>"+L["server_"+w.server]+"</b>&gt; "+L.UserList.replace("FA{users}","")+" ["+t+L.MN+"]"),e)for(a in m.lobby.userList.empty(),m.dialog.inviteList.empty(),o)(r=o[a]).robot||(m.lobby.userList.append(re(r)),0==r.place&&m.dialog.inviteList.append(re(r,!0)))}function re(e,a){var r;return oe(r=a?$("<div>").attr("id","invite-item-"+e.id).addClass("invite-item users-item").append($("<div>").addClass("jt-image users-image").css("background-image","url('"+e.profile.image+"')")).append(Ye(e.data.score).addClass("users-level")).append($("<div>").addClass("users-name").html(e.profile.title||e.profile.name)).on("click",function(e){$e($(e.currentTarget).attr("id").slice(12))}):$("<div>").attr("id","users-item-"+e.id).addClass("users-item").append($("<div>").addClass("jt-image users-image").css("background-image","url('"+e.profile.image+"')")).append(Ye(e.data.score).addClass("users-level")).append($("<div>").addClass("users-name ellipse").html(e.profile.title||e.profile.name)).on("click",function(e){be($(e.currentTarget).attr("id").slice(11))}),e),r}function oe(e,a){a.equip.NIK&&e.addClass("x-"+a.equip.NIK),"b1_gm"==a.equip.BDG&&e.addClass("x-gm")}function te(e){var r,o,t=ze(e.mode,e.opts);return r=$("<div>").attr("id","room-"+e.id).addClass("rooms-item").append(o=$("<div>").addClass("rooms-channel channel-"+e.channel).on("click",function(r){!function(e){var r=w.rooms[e],o=$("#ri-players").empty();w._roominfo=e,$("#RoomInfoDiag .dialog-title").html(e+L.sRoomInfo),$("#ri-title").html((r.password?"<i class='fa fa-lock'></i>&nbsp;":"")+r.title),$("#ri-mode").html(L["mode"+a[r.mode]]),$("#ri-round").html(r.round+", "+r.time+L.SECOND),$("#ri-limit").html(r.players.length+" / "+r.limit),r.players.forEach(function(e,a){var t,i,s=r.readies[e]||{};e=w.users[e]||f,r.players[a].robot?(e.profile={title:L.robot},e.equip={robot:!0}):s.t=s.t||0,o.append($("<div>").addClass("ri-player").append(i=$("<div>").addClass("moremi rip-moremi")).append(t=$("<div>").addClass("ellipse rip-title").html(e.profile.title||e.profile.name)).append($("<div>").addClass("rip-team team-"+s.t).html($("#team-"+s.t).html())).append($("<div>").addClass("rip-form").html(L["pform_"+s.f]))),e.id==r.master&&t.prepend($("<label>").addClass("rip-master").html("["+L.master+"]&nbsp;")),t.prepend(Ye(e.data.score).addClass("profile-level rip-level")),fa(i,e.equip)}),M(m.dialog.roomInfo),m.dialog.roomInfo.show()}(e.id)})).append($("<div>").addClass("rooms-number").html(e.id)).append($("<div>").addClass("rooms-title ellipse").text(ia(e.title))).append($("<div>").addClass("rooms-limit").html(e.players.length+" / "+e.limit)).append($("<div>").width(270).append($("<div>").addClass("rooms-mode").html(t.join(" / ").toString())).append($("<div>").addClass("rooms-round").html(L.rounds+" "+e.round)).append($("<div>").addClass("rooms-time").html(e.time+L.SECOND))).append($("<div>").addClass("rooms-lock").html(e.password?"<i class='fa fa-lock'></i>":"<i class='fa fa-unlock'></i>")).on("click",function(e){e.target!=o.get(0)&&oa($(e.currentTarget).attr("id").slice(5))}),e.gaming&&r.addClass("rooms-gaming"),e.password&&r.addClass("rooms-locked"),r}function ie(a){var r,o,t,i=$("<div>").attr("id","game-user-"+a.id).addClass("game-user").append(r=$("<div>").addClass("moremi game-user-image")).append($("<div>").addClass("game-user-title").append(Ye(a.data.score).addClass("game-user-level")).append(t=$("<div>").addClass("game-user-name ellipse").html(a.profile.title||a.profile.name)).append($("<div>").addClass("expl").html(L.LEVEL+" "+We(a.data.score)))).append(o=$("<div>").addClass("game-user-score"));return fa(r,a.equip),e.g.expl(i),oe(t,a),a.game.team&&o.addClass("team-"+a.game.team),i}function se(e){var a,r,o=$("<div>").attr("id","game-user-"+e.id).addClass("game-user").append($("<div>").addClass("game-user-title").append(Ye(e.data.score).addClass("game-user-level")).append(r=$("<div>").addClass("game-user-name ellipse").html(e.profile.title||e.profile.name))).append(a=$("<div>").addClass("game-user-score"));return e.id==w.id&&r.addClass("game-user-my-name"),oe(r,e),e.game.team&&a.addClass("team-"+e.game.team),o}function ne(e){return{title:L["aiLevel"+e]+" "+L.robot,image:"/img/kkutu/robot.png"}}function le(e){var r,o,t,i,s,l,d,c=n[a[w.room.mode]],g=p||c.big?se:ie,f=!1,h=!0;if(Xe($(".RoomBox .product-title"),w.room),Xe($(".GameBox .product-title"),w.room),e){for(r in t=$(".GameBox .game-body").empty(),w.room.game.seq)(o=w._replay?u.users[w.room.game.seq[r]]||w.room.game.seq[r]:w.users[w.room.game.seq[r]]||w.robots[w.room.game.seq[r].id]||w.room.game.seq[r]).robot&&!o.profile&&(o.profile=ne(o.level),w.robots[o.id]=o),t.append(g(o)),ce(o.id,o.game.score||0);clearTimeout(w._jamsu),delete w._jamsu}else{for(r in t=$(".room-users").empty(),b="S"==w.users[w.id].game.form,w.room.players)if((o=w.users[w.room.players[r]]||w.room.players[r]).game){var v=o.game.practice?"/"+L.stat_practice:"",b="S"==o.game.form&&"/"+L.stat_spectate;o.robot&&(o.profile=ne(o.level),w.robots[o.id]=o),t.append($("<div>").attr("id","room-user-"+o.id).addClass("room-user").append(l=$("<div>").addClass("moremi room-user-image")).append($("<div>").addClass("room-user-stat").append(i=$("<div>").addClass("room-user-ready")).append(s=$("<div>").addClass("room-user-team team-"+o.game.team).html($("#team-"+o.game.team).html()))).append($("<div>").addClass("room-user-title").append(Ye(o.data.score).addClass("room-user-level")).append(d=$("<div>").addClass("room-user-name").html(o.profile.title||o.profile.name))).on("click",function(e){be($(e.currentTarget).attr("id").slice(10))})),fa(l,o.equip),b&&s.hide(),o.id==w.room.master?i.addClass("room-user-master").html(L.master+v+(b||"")):b?i.addClass("room-user-spectate").html(L.stat_spectate+v):o.game.ready||o.robot?(i.addClass("room-user-readied").html(L.stat_ready),o.robot||(f=!0)):o.game.practice?(i.addClass("room-user-practice").html(L.stat_practice),h=!1):(i.html(L.stat_noready),h=!1),oe(d,o)}f&&w.room.master==w.id&&h?w._jamsu||(w._jamsu=G(de,5e3)):(clearTimeout(w._jamsu),delete w._jamsu)}m.dialog.profile.is(":visible")&&be(w._profiled)}function de(){na(L.subJamsu),w._jamsu=G(function(){F("leave"),alert(L.masterJamsu)},3e4)}function ce(e,a){var r;return(r=w["_s"+e])?(clearTimeout(r.timer),r.$obj=$("#game-user-"+e+" .game-user-score"),r.goal=a):r=w["_s"+e]={$obj:$("#game-user-"+e+" .game-user-score"),goal:a,now:0},me(r),$("#game-user-"+e)}function me(e){var a=(e.goal-e.now)*Math.min(1,.01*h);a<.1?a=e.goal-e.now:e.timer=G(me,h,e),e.now+=a,function(e,a){var r,o=a>99999?P(Math.round(.001*a),4)+"k":P(a,5);for(e.empty(),r=0;r<o.length;r++)e.append($("<div>").addClass("game-user-score-char").html(o[r]))}(e.$obj,Math.round(e.now))}function ue(e){var a=$("#dress-view"),r=w.users[w.id];fa(a,r.equip),$(".dress-type.selected").removeClass("selected"),$("#dress-type-all").addClass("selected"),$("#dress-exordial").val(r.exordial),ge(e||!0)}function pe(a,r,o,t,i){var s,n,l,d,c,m,u=[],p=!0===o;for(m in a.empty(),t||(t={}),t)w.box.hasOwnProperty(t[m])||(w.box[t[m]]={value:0});for(m in w.box)u.push({key:m,obj:da(m),value:w.box[m]});for(m in u.sort(function(e,a){return e.obj.name<a.obj.name?-1:1}),u)n=u[m].obj,l=u[m].value,"BDG"==(d=n.group).substr(0,3)&&(d="BDG"),c="Mhand"==d?t.Mlhand==u[m].key||t.Mrhand==u[m].key:t[d]==u[m].key,"number"==typeof l&&(l={value:l}),(l.hasOwnProperty("value")||c)&&(p||-1!=o.indexOf(n.group))&&(a.append(s=$("<div>").addClass("dress-item").append(Qe(n.image).addClass("dress-item-image").html("x"+l.value)).append(Ne(n,c,l.expire))),s.attr("id",r+"-"+n._id).on("click",i),c&&s.addClass("dress-equipped"));e.g.expl(a)}function ge(e){var a,r=w.users[w.id].equip||{},o=!0===e;w._avGroup=e,a=!!o||(e||"").split(","),pe($("#dress-goods"),"dress",a,r,function(e){var a,r=$(e.currentTarget),o=r.attr("id").slice(6),t=da(o);if(e.ctrlKey){if(r.hasClass("dress-equipped"))return va(426);if(!confirm(L.surePayback+ha(Math.round(.2*(t.cost||0)))+L.ping))return;$.post("/payback/"+o,function(e){if(e.error)return va(e.error);alert(L.painback),w.box=e.box,w.users[w.id].money=e.money,ue(w._avGroup),z(!1)})}else if(-1!=s.indexOf(t.group))"Mhand"==t.group&&(a=confirm(L.dressWhichHand)),function(e,a){var r=w.users[w.id],o=w.shop[e].group;"Mhand"==o&&(o=a?"Mlhand":"Mrhand");"BDG"==o.substr(0,3)&&(o="BDG");var t=r.equip[o]==e;confirm(L[t?"sureUnequip":"sureEquip"]+": "+L[e][0])&&$.post("/equip/"+e,{isLeft:a},function(e){if(e.error)return va(e.error);w.box=e.box,r.equip=e.equip,ue(w._avGroup),F("refresh"),z(!1)})}(o,a);else if("CNS"==t.group){if(!confirm(L.sureConsume))return;$.post("/consume/"+o,function(e){e.exp&&na(L.obtainExp+": "+ha(e.exp)),e.money&&na(L.obtainMoney+": "+ha(e.money)),e.gain.forEach(function(e){pa(e)}),w.box=e.box,w.users[w.id].data=e.data,F("refresh"),ue(w._avGroup),Z()})}})}function fe(){var e=$("#cf-tray"),a=$("#cf-dict"),r=$("#cf-reward"),o=$("#cf-goods"),t=$("#cf-cost");function i(){e.html($("<h4>").css("padding-top","8px").width("100%").html(L.cfTray))}function s(){var o,s={WPC:1,WPB:2,WPA:3},l="",d=0;e.empty(),$(".cf-tray-selected").removeClass("cf-tray-selected"),w._tray.forEach(function(a){o=da(a),l+=a.slice(4),d+=s[a.slice(1,4)],e.append($("<div>").addClass("jt-image").css("background-image","url("+o.image+")").attr("id","cf-tray-"+a).on("click",n)),$("#cf-\\"+a).addClass("cf-tray-selected")}),a.html(L.searching),r.empty(),m.dialog.cfCompose.removeClass("cf-composable"),t.html(""),W(l,function(e){var o=!1;if(e.error){if(3!=l.length)return a.html(L["wpFail_"+e.error]);o=!0,a.html(L.cfBlend)}!function(e,a,o){$.get("/cf/"+e+"?l="+a+"&b="+(o?"1":""),function(e){if(e.error)return va(e.error);r.empty(),e.data.forEach(function(e){var a=da(e.key),o=e.rate>=1?L.cfRewAlways:(100*e.rate).toFixed(1)+"%";r.append($("<div>").addClass("cf-rew-item").append($("<div>").addClass("jt-image cf-rew-image").css("background-image","url("+a.image+")")).append($("<div>").width(100).append($("<div>").width(100).html(a.name)).append($("<div>").addClass("cf-rew-value").html("x"+e.value))).append($("<div>").addClass("cf-rew-rate").html(o)))}),t.html(L.cfCost+": "+e.cost+L.ping)})}(l,d,o),m.dialog.cfCompose.addClass("cf-composable"),e.error||a.html(Ue(e.word,e.mean,e.theme,e.type.split(",")))}),""==l&&i()}function n(e){var a=$(e.currentTarget).attr("id").slice(8),r=w._tray.indexOf(a);-1!=r&&(w._tray.splice(r,1),s())}w._tray=[],a.empty(),r.empty(),t.html(""),m.dialog.cfCompose.removeClass("cf-composable"),pe(o,"cf",["PIX","PIY","PIZ"],null,function(e){var a,r=$(e.currentTarget).attr("id").slice(3),o=w.box[r],t=0;if(w._tray.length>=6)return va(435);for(a in w._tray)w._tray[a]==r&&t++;o-t>0?(w._tray.push(r),s()):va(434)}),i()}function he(e){var a=m.dialog.lbTable.empty(),r=e.data[0]?e.data[0].rank:0,o=(e.page||Math.floor(r/20))+1;e.data.forEach(function(e,r){var o=w.users[e.id];o=o?o.profile.title||o.profile.name:L.hidden,e.score=Number(e.score),a.append($("<tr>").attr("id","ranking-"+e.id).addClass("ranking-"+(e.rank+1)).append($("<td>").html(e.rank+1)).append($("<td>").append(Ye(e.score).addClass("ranking-image")).append($("<label>").css("padding-top",2).html(We(e.score)))).append($("<td>").html(o)).append($("<td>").html(ha(e.score))))}),$("#ranking-"+w.id).addClass("ranking-me"),m.dialog.lbPage.html(L.page+" "+o),m.dialog.lbPrev.attr("disabled",o<=1),m.dialog.lbNext.attr("disabled",e.data.length<15),m.dialog.lbMe.attr("disabled",!!w.guest),w._lbpage=o-1}function ve(){var e,a,r,o,t=0;for(e in m.dialog.commFriends.empty(),w.friends)t++,o=w.friends[e],a=w._friends[e]||{},r=(w.users[e]||{}).profile,m.dialog.commFriends.append($("<div>").addClass("cf-item").attr("id","cfi-"+e).append($("<div>").addClass("cfi-status cfi-stat-"+(a.server?"on":"off"))).append($("<div>").addClass("cfi-server").html(a.server?L["server_"+a.server]:"-")).append($("<div>").addClass("cfi-name ellipse").html(r?r.title||r.name:L.hidden)).append($("<div>").addClass("cfi-memo ellipse").text(o)).append($("<div>").addClass("cfi-menu").append($("<i>").addClass("fa fa-pencil").on("click",i)).append($("<i>").addClass("fa fa-remove").on("click",s))));function i(e){var a=$(e.currentTarget).parent().parent().attr("id").slice(4),r=w.friends[a],o=prompt(L.friendEditMemo,r);o&&F("friendEdit",{id:a,memo:o},!0)}function s(e){var a=$(e.currentTarget).parent().parent().attr("id").slice(4),r=w.friends[a];if(w._friends[a].server)return va(455);confirm(r+"(#"+a.substr(0,5)+")\n"+L.friendSureRemove)&&F("friendRemove",{id:a},!0)}$("#CommunityDiag .dialog-title").html(L.communityText+" ("+t+" / 100)")}function be(a){var r,o,t,i=w.users[a]||w.robots[a],s=$("#profile-record").empty();if(i){if($("#ProfileDiag .dialog-title").html((i.profile.title||i.profile.name)+L.sProfile),$(".profile-head").empty().append(r=$("<div>").addClass("moremi profile-moremi")).append($("<div>").addClass("profile-head-item").append(Qe(i.profile.image).addClass("profile-image")).append($("<div>").addClass("profile-title ellipse").html(i.profile.title||i.profile.name).append($("<label>").addClass("profile-tag").html(" #"+i.id.toString().substr(0,5))))).append($("<div>").addClass("profile-head-item").append(Ye(i.data.score).addClass("profile-level")).append($("<div>").addClass("profile-level-text").html(L.LEVEL+" "+(t=We(i.data.score)))).append($("<div>").addClass("profile-score-text").html(ha(i.data.score)+" / "+ha(v[t-1])+L.PTS))).append(o=$("<div>").addClass("profile-head-item profile-exordial ellipse").text(ia(i.exordial||"")).append($("<div>").addClass("expl").css({"white-space":"normal",width:300,"font-size":"11px"}).text(i.exordial))),i.robot)m.dialog.profileLevel.show(),m.dialog.profileLevel.prop("disabled",w.id!=w.room.master),$("#profile-place").html(w.room.id+L.roomNumber);else{for(t in m.dialog.profileLevel.hide(),$("#profile-place").html(i.place?i.place+L.roomNumber:L.lobby),i.data.record){var n=i.data.record[t];s.append($("<div>").addClass("profile-record-field").append($("<div>").addClass("profile-field-name").html(L["mode"+t])).append($("<div>").addClass("profile-field-record").html(n[0]+L.P+" "+n[1]+L.W)).append($("<div>").addClass("profile-field-score").html(ha(n[2])+L.PTS)))}fa(r,i.equip)}w._profiled=a,m.dialog.profileKick.hide(),m.dialog.profileShut.hide(),m.dialog.profileDress.hide(),m.dialog.profileWhisper.hide(),m.dialog.profileHandover.hide(),w.id==a?m.dialog.profileDress.show():i.robot||(m.dialog.profileShut.show(),m.dialog.profileWhisper.show()),w.room&&w.id!=a&&w.id==w.room.master&&(m.dialog.profileKick.show(),m.dialog.profileHandover.show()),M(m.dialog.profile),m.dialog.profile.show(),e.g.expl(o)}else na(L.error_405)}function $e(e){var a;("AI"==e||(a=w.users[e].profile.title||w.users[e].profile.name,confirm(a+L.sureInvite)))&&F("invite",{target:e})}function ke(e){w._replay||w.lastFail!=w.id||w.id!=e?w.failCombo=0:(w.failCombo++,1==w.failCombo&&na(L.trollWarning),w.failCombo>1&&(F("leave"),va(437))),w.lastFail=e}function _e(){var e;for(e in w.room.players)(w._replay?u.users[w.room.players[e]]||w.room.players[e]:w.users[w.room.players[e]]||w.robots[w.room.players[e].id]).game.score=0,delete w["_s"+w.room.players[e]];delete w.lastFail,w.failCombo=0,w._spectate=-1==w.room.game.seq.indexOf(w.id),w._gAnim=!0,m.box.room.show().height(360).animate({height:1},500),m.box.game.height(1).animate({height:410},500),ea(),m.dialog.resultSave.attr("disabled",!1),De(),m.game.display.html(L.soon),aa("game_start"),ta(),G(function(){m.box.room.height(360).hide(),m.chat.scrollTop(999999999)},500)}function ye(){var e;for(e in w.room.game.seq)w.room.game.seq[e].robot&&(w.room.game.seq[e].game.score=0);for(e in u.users={},u.players){var a=u.players[e].id,r=u.readies[a]||{},o=w.users[a]||w.robots[a],t=a;u.players[e].robot?(o=u.users[a]={robot:!0},(t=u.players[e]).game={}):o=u.users[a]={},w.room.players.push(t),o.id=t,o.profile=u.players[e],o.data=o.profile.data,o.equip=o.profile.equip,o.game={score:0,team:r.t}}w._rf=0}function we(e){var a,r,o=w.room.events[--w._rf];if(o){a=o.time;do{if(!(o=w.room.events[--w._rf]))break}while(a-o.time<1e3);for(r=w._rf-1,ye(),a=w.muteEff,w.muteEff=!0,i=0;i<r;i++)xe();$(".deltaScore").remove(),w.muteEff=a,xe()}}function Ce(e){var a=w._rpause=!w._rpause;$(e.target).html(a?L.replayResume:L.replayPause)}function Le(e){clearTimeout(w._rt),xe()}function Te(){w.$gpt.html(w._gpp+" ("+(.001*w._eventTime).toFixed(1)+L.SECOND+" / "+(.001*w._gtt).toFixed(1)+L.SECOND+")")}function xe(e){var a,r=w.room.events[w._rf];if(clearTimeout(w._rt),e||w._rf++,r){if(w._rpause)return w._rf--,w._rt=G(xe,100);(a=r.data).hint&&(a.hint={_id:a.hint}),"chat"==a.type&&(a.timestamp=u.time+r.time),J(a),w._eventTime=r.time,Te(),w.room.events.length>w._rf?w._rt=G(xe,w.room.events[w._rf].time-r.time):Se()}else Se()}function Se(){delete w.room,w._replay=!1,m.box.room.height(360),clearTimeout(w._rt),z(),Ze("lobby")}function je(e){if(!w._replay&&u){var a,r=e;if(e.hasOwnProperty("type")&&"room"!=e.type&&"obtain"!=e.type){for(a in e={},r)e[a]=r[a];e.profile&&(e.profile={id:e.profile.id,title:"#"+e.profile.id}),e.user&&(e.user={id:e.user.profile.id,profile:{id:e.user.profile.id,title:"#"+e.user.profile.id},data:{score:0},equip:{}}),u.events.push({data:e,time:(new Date).getTime()-u.time})}}}function De(){w._relay=!1,N(),m.game.here.hide(),m.dialog.result.hide(),m.dialog.dress.hide(),m.dialog.charFactory.hide(),$(".jjoriping,.rounds,.game-body").removeClass("cw"),$(".jjoriping,.rounds").removeClass("dg"),$(".rounds").removeClass("painter"),m.game.display.empty(),m.game.chain.hide(),m.game.hints.empty().hide(),m.game.tools.hide(),m.game.cwcmd.hide(),m.game.bb.hide(),m.game.round.empty(),m.game.history.empty(),m.game.items.show().css("opacity",0),$(".jjo-turn-time .graph-bar").width(0).css({float:"","text-align":"","background-color":""}),$(".jjo-round-time .graph-bar").width(0).css({float:"","text-align":""}).removeClass("round-extreme"),$(".game-user-bomb").removeClass("game-user-bomb")}function qe(e){var a;for(m.game.round.empty(),a=0;a<w.room.round;a++)m.game.round.append($l=$("<label>").html(w.room.game.title[a])),a+1==e&&$l.addClass("rounds-current")}function Oe(){K("turnGoing")}function Re(e){return w._replay?u.users[e].game.score:(w.users[e]||w.robots[e]).game.score}function Be(e,a){w._replay?u.users[e].game.score+=a:(w.users[e]||w.robots[e]).game.score+=a}function Ae(e,a){return e.append(a),G(function(){a.remove()},2e3),e}function Pe(e){var a,t,s,n=$(".result-board").empty();if(w._resultPage=2,!e)return m.dialog.resultOK.trigger("click");for(i in e.list)r=e.list[i],o=w.users[r.id]||{profile:{title:L.hidden}},s=r.id==w.id,n.append(a=$("<div>").addClass("result-board-item").append($("<div>").addClass("result-board-rank").html(r.rank+1)).append(Ye(r.score).addClass("result-board-level")).append($("<div>").addClass("result-board-name").html(o.profile.title||o.profile.name)).append($("<div>").addClass("result-board-score").html(ha(r.score)+L.PTS)).append($("<div>").addClass("result-board-reward").html("")).append(t=$("<div>").addClass("result-board-lvup").css("display",s?"block":"none").append($("<i>").addClass("fa fa-arrow-up")).append($("<div>").html(e.prev-r.rank)))),s&&(e.prev-r.rank<=0&&t.hide(),a.addClass("result-board-me"))}function Fe(){$(".kick-vote-time .graph-bar").width(w.kickTime/w._kickTime*300),--w.kickTime>0?w._kickTimer=G(Fe,1e3):m.dialog.kickVoteY.trigger("click")}function Ne(e,a,r){var o,t,i=$("<div>").addClass("expl dress-expl").append($("<div>").addClass("dress-item-title").html(ca(e._id)+(a?L.equipped:""))).append($("<div>").addClass("dress-item-group").html(L["GROUP_"+e.group])).append($("<div>").addClass("dress-item-expl").html(ma(e._id))),s=$("<div>").addClass("dress-item-opts");for(o in e.term&&i.append($("<div>").addClass("dress-item-term").html(Math.floor(e.term/86400)+L.DATE+" "+L.ITEM_TERM)),r&&i.append($("<div>").addClass("dress-item-term").html(new Date(1e3*r).toLocaleString()+L.ITEM_TERMED)),e.options)if("gif"!=o){var n=o.charAt(0);t=e.options[o],"g"==n?t="+"+(100*t).toFixed(1)+"%p":"h"==n&&(t="+"+t),s.append($("<label>").addClass("item-opts-head").html(L["OPTS_"+o])).append($("<label>").addClass("item-opts-body").html(t)).append($("<br>"))}return t&&i.append(s),i}function Me(e){var a;$.get("/shop",function(r){for(a in w.shop={},r.goods)w.shop[r.goods[a]._id]=r.goods[a];e&&e(r)})}function Ee(e){var a,r,o=$(e.currentTarget).attr("id").slice(6),t=w.shop[o],i=w.users[w.id],s=i.money,n=s-t.cost,l=L.surePurchase,d={};for(r in w.box&&w.box[o]&&(l=L.alreadyGot+" "+l),M(m.dialog.purchase,!0),$("#purchase-ping-before").html(ha(s)+L.ping),$("#purchase-ping-cost").html(ha(t.cost)+L.ping),$("#purchase-item-name").html(L[o][0]),a=$("#purchase-ping-after").html(ha(n)+L.ping),$("#purchase-item-desc").html(n<0?L.notEnoughMoney:l),i.equip)d[r]=i.equip[r];d["Mhand"==t.group?["Mlhand","Mrhand"][Math.floor(2*Math.random())]:t.group]=o,fa("#moremi-after",d),w._sgood=o,m.dialog.purchaseOK.attr("disabled",n<0),n<0?a.addClass("purchase-not-enough"):a.removeClass("purchase-not-enough")}function Ie(e){e<1||($("#Middle").css("padding-top",e),G(function(){$("#Middle").css("padding-top",0),G(Ie,50,.7*e)},50))}function Ge(e,r,o,t){var i,s,l,d,c,u=a[w.room.mode],p="KKT"==u,f="KAP"==u,h=g[i=e.length],v=0,b=w.turnTime/96,k=w.turnTime/12;if(m.game.display.empty(),h?(s="As"+w._speed,h=h.split("")):"en"==n[u].lang&&i<10?s="As"+w._speed:(s="Al",Ie(i)),l="K"+w._speed,h){for(d in h)"0"!=h[d]&&(m.game.display.append(c=$("<div>").addClass("display-text").css({float:f?"right":"left","margin-top":-6,"font-size":36}).hide().html(f?e.charAt(i-v-1):e.charAt(v))),v++,G(function(e,a){var r={"margin-top":0};aa(a),e.html()==w.mission?(aa("mission"),e.css({color:"#66FF66"}),r["font-size"]=24):r["font-size"]=20,e.show().animate(r,100)},Number(d)*b,c,s));d=m.game.display.children("div").get(0),$(d).css(f?"margin-right":"margin-left",.5*(m.game.display.width()-20*i))}else if(v="",f)for(d=0;d<i;d++)G(function(e){aa(s),e==w.mission?(aa("mission"),v="<label style='color: #66FF66;'>"+e+"</label>"+v):v=e+v,m.game.display.html(v)},Number(d)*k/i,e[i-d-1]);else for(d=0;d<i;d++)G(function(e){aa(s),e==w.mission?(aa("mission"),v+="<label style='color: #66FF66;'>"+e+"</label>"):v+=e,m.game.display.html(v)},Number(d)*k/i,e[d]);G(function(){for(d=0;d<3;d++)G(function(e){if(p){if(1==e)return;aa("kung")}(h?m.game.display.children(".display-text"):m.game.display).css("font-size",21).animate({"font-size":20},b)},d*b*2,d);G(Je,4*b,e,r,o,t),p||aa(l)},k)}function Ke(a){var r,o=Ue("",a);m.game.hints.append(r=$("<div>").addClass("hint-item").append($("<label>").html(o)).append($("<div>").addClass("expl").css({"white-space":"normal",width:200}).html(o.html()))),p||r.width(0).animate({width:215}),e.g.expl(r)}function Je(a,r,o,t){var i,s,n,l=t?t.split(","):[],d={};m.game.history.prepend(i=$("<div>").addClass("ellipse history-item").width(0).animate({width:200}).html(a)),(s=m.game.history.children()).length>6&&s.last().remove(),n=Ue(a,r,o,l),l.forEach(function(e){d[e]||L["class_"+e]&&(d[e]=!0,i.append($("<label>").addClass("history-class").html(L["class_"+e])))}),i.append(s=$("<div>").addClass("history-mean ellipse").append(n)).append($("<div>").addClass("expl").css({width:200,"white-space":"normal"}).html("<h5 style='color: #BBBBBB;'>"+n.html()+"</h5>")),e.g.expl(i)}function Ue(e,a,r,o){if(!a||-1==a.indexOf("＂"))return t=a,$("<label>").addClass("word").html(t);var t,i=$("<label>").addClass("word"),s=a.split(/＂[0-9]+＂/).slice(1).map(function(e){return-1==e.indexOf("［")?[[e]]:e.split(/［[0-9]+］/).slice(1).map(function(e){return e.split(/（[0-9]+）/).slice(1)})}),n=(o&&o.map(function(e){return L["class_"+e]}),r?r.split(",").map(function(e){return L["theme_"+e]}):[]),l=s.length>1;return s.forEach(function(e,a){var r=$("<label>").addClass("word-m1"),o=e.length>1;l&&r.append($("<label>").addClass("word-head word-m1-head").html(a+1)),e.forEach(function(e,a){var t=$("<label>").addClass("word-m2"),i=e.length,s=i>1,l=n.splice(0,i);o&&t.append($("<label>").addClass("word-head word-m2-head").html(a+1)),e.forEach(function(e,a){var r=$("<label>").addClass("word-m3"),o=l.shift();s&&r.append($("<label>").addClass("word-head word-m3-head").html(a+1)),o&&r.append($("<label>").addClass("word-theme").html(o)),r.append($("<label>").addClass("word-m3-body").html(e.replace(/\$\$[^\$]+\$\$/g,function(e){return"<equ>"+e.slice(2,e.length-2).replace(/\^\{([^\}]+)\}/g,"<sup>$1</sup>").replace(/_\{([^\}]+)\}/g,"<sub>$1</sub>").replace(/\\geq/g,"≥")+"</equ>"}).replace(/\*\*([^\*]+)\*\*/g,"<sup>$1</sup>").replace(/\*([^\*]+)\*/g,"<sub>$1</sub>"))),t.append(r)}),r.append(t)}),i.append(r)}),i}function Ve(e,a,r){var o=e+(a?"("+a+")":"");return r&&(o+="<label class='jjo-display-word-length'>("+r+")</label>"),o}function He(e){return Math.round((.3*!(e%5)+1)*(.4*!(e%15)+1)*(.5*!(e%45)+1)*(120+60*Math.floor(e/5)+120*Math.floor(e*e/225)+180*Math.floor(e*e/2025)))}function We(e){var a,r=v.length;for(a=0;a<r&&!(e<v[a]);a++);return a+1}function Ye(e){var a=We(e)-1,r=a%25*-100,o=-100*Math.floor(.04*a);return $("<div>").css({float:"left","background-image":"url('/img/kkutu/lv/newlv.png')","background-position":r+"% "+o+"%","background-size":"2560%"})}function Qe(e){return $("<div>").addClass("jt-image").css("background-image","url('"+e+"')")}function ze(e,r,o){var t,i=[L["mode"+a[e]]];for(t in l)r[l[t].name.toLowerCase()]&&i.push(L["opt"+l[t].name]);return o&&i.push(r.injpick.join("|")),o?i.toString():i}function Xe(r,o){var t,i=ze(o.mode,o.opts),s=n[a[o.mode]];r.empty().append($("<h5>").addClass("room-head-number").html("["+(o.practice?L.practice:o.id)+"]")).append($("<h5>").addClass("room-head-title").text(ia(o.title))).append(t=$("<h5>").addClass("room-head-mode").html(i.join(" / "))).append($("<h5>").addClass("room-head-limit").html((p?"":L.players+" ")+o.players.length+" / "+o.limit)).append($("<h5>").addClass("room-head-round").html(L.rounds+" "+o.round)).append($("<h5>").addClass("room-head-time").html(o.time+L.SECOND)),-1!=s.opts.indexOf("ijp")&&(t.append($("<div>").addClass("expl").html("<h5>"+o.opts.injpick.map(function(e){return L["theme_"+e]})+"</h5>")),e.g.expl(r))}function Ze(e,a){return w.bgm&&w.bgm.stop(),w.bgm=aa(e,!0)}function ea(){w.bgm&&(w.bgm.stop(),delete w.bgm)}function aa(e,a){var r,o,t=a&&w.muteBGM||!a&&w.muteEff;return o=_[e]||_.missing,window.hasOwnProperty("AudioBuffer")&&o instanceof AudioBuffer?((r=T.createBufferSource()).startedAt=T.currentTime,r.loop=a,r.buffer=t?T.createBuffer(2,o.length,T.sampleRate):o,r.connect(T.destination)):(o.readyState&&(o.audio.currentTime=0),o.audio.loop=a||!1,o.audio.volume=t?0:1,r=o),y[e]&&y[e].stop(),y[e]=r,r.key=e,r.start(),r}function ra(){var e;for(e in y)y[e].stop()}function oa(e){var a;w.rooms[e]&&(w.rooms[e].password&&!(a=prompt(L.putPassword))||(w._pw=a,F("enter",{id:e,password:a})))}function ta(){var e=$("#Chat,#chat-log-board"),a=e.children(".chat-item").last().get(0);a&&"HR"==a.tagName||(e.append($("<hr>").addClass("chat-item")),m.chat.scrollTop(999999999))}function ia(e){return e.replace(k,"♥♥")}function sa(e,a,r,o){var t,i,s,n,l=o?new Date(o):new Date,d=w.users[e.id]?w.users[e.id].equip:{};if(!w._shut[e.title||e.name]){if(r){if(w.opts.dw)return;if(w._wblock[r])return}a=ia(a),aa("k"),la(),!p&&w.room&&(t=(w.room.gaming?2:0)+($(".jjoriping").hasClass("cw")?1:0),function(e,a,r){$("#cb-"+a).remove();var o,t,i=(2&r?$("#game-user-"+a):$("#room-user-"+a)).offset(),s=2==r?"chat-balloon-bot":"chat-balloon-tip",n=$("<div>").addClass("chat-balloon").attr("id","cb-"+a).append($("<div>").addClass("jt-image "+s))[2==r?"prepend":"append"]($("<h4>").text(e));i&&(m.balloons.append(n),1==r?(o=0,t=220):2==r?(o=35-n.height(),t=-2):3==r?(o=5,t=210):(o=40,t=110),n.css({top:i.top+o,left:i.left+t}),G(function(){n.animate({opacity:0},500,function(){n.remove()})},2500))}(a,e.id,t)),m.chat.append(s=$("<div>").addClass("chat-item").append(t=$("<div>").addClass("chat-head ellipse").text(e.title||e.name)).append(i=$("<div>").addClass("chat-body").text(a)).append($("<div>").addClass("chat-stamp").text(l.toLocaleTimeString()))),o&&t.prepend($("<i>").addClass("fa fa-video-camera")),t.on("click",function(a){be(e.id)}),m.chatLog.append(s=s.clone()),s.append($("<div>").addClass("expl").css("font-weight","normal").html("#"+(e.id||"").substr(0,5))),(n=a.match(/https?:\/\/[\w\.\?\/&#%=-_\+]+/g))&&(a=i.html(),n.forEach(function(e){a=a.replace(e,"<a href='#' style='color: #2222FF;' onclick='if(confirm(\""+L.linkWarning+'")) window.open("'+e+"\");'>"+e+"</a>")}),i.html(a)),r&&(!0!==r&&(w._recentFrom=r),i.html("<label style='color: #7777FF; font-weight: bold;'>&lt;"+L.whisper+"&gt;</label>"+i.html())),oe(t,{equip:d}),m.chat.scrollTop(999999999)}}function na(e,a){var r=new Date;aa("k"),la(),$("#Chat,#chat-log-board").append($("<div>").addClass("chat-item chat-notice").append($("<div>").addClass("chat-head").text(a||L.notice)).append($("<div>").addClass("chat-body").html(e)).append($("<div>").addClass("chat-stamp").text(r.toLocaleTimeString()))),m.chat.scrollTop(999999999),"tail"==a&&console.warn(r.toLocaleString(),e)}function la(){var e=$("#Chat .chat-item"),a=$("#chat-log-board .chat-item");e.length>99&&e.first().remove(),a.length>199&&a.first().remove()}function da(e){var a;return a="$"==e.charAt()?w.shop[e.slice(0,4)]:w.shop[e],{_id:e,group:a.group,term:a.term,name:ca(e),cost:a.cost,image:ua(e,a),desc:ma(e),options:a.options}}function ca(e){return"$"==e.charAt()?L[e.slice(0,4)][0]+" - "+e.slice(4):L[e][0]}function ma(e){return"$"==e.charAt()?L[e.slice(0,4)][1]:L[e][1]}function ua(e,a){var r,o;if(e){if("$"==e.charAt())return function(e,a){var r,o=document.createElement("canvas"),t=o.getContext("2d");switch(o.width=o.height=50,t.font="24px NBGothic",t.textAlign="center",t.textBaseline="middle",e){case"WPC":case"WPB":case"WPA":r=["WPC","WPB","WPA"].indexOf(e),t.beginPath(),t.arc(25,25,25,0,2*Math.PI),t.fillStyle=["#DDDDDD","#A6C5FF","#FFEF31"][r],t.fill(),t.fillStyle=["#000000","#4465C3","#E69D12"][r],t.fillText(a,25,25)}return o.toDataURL()}(e.slice(1,4),e.slice(4))}else"string"==typeof a&&(a={_id:"def",group:a,options:{}});return o=(r=w.shop[e]||a).options.hasOwnProperty("gif")?".gif":".png","BDG"==r.group.slice(0,3)?"/img/kkutu/moremi/badge/"+r._id+o:"M"==r.group.charAt(0)?"/img/kkutu/moremi/"+r.group.slice(1)+"/"+r._id+o:"/img/kkutu/shop/"+r._id+".png"}function pa(e){m.dialog.obtain.is(":visible")?w._obtain.push(e):(ga(e),M(m.dialog.obtain,!0))}function ga(e){aa("success"),$("#obtain-image").css("background-image","url("+ua(e.key)+")"),$("#obtain-name").html(ca(e.key))}function fa(e,a){var r,o,i=$(e).empty(),s={Mlhand:"Mhand",Mrhand:"Mhand"};for(r in a||(a={}),t)o="M"+t[r],i.append($("<img>").addClass("moremies moremi-"+o.slice(1)).attr("src",ua(a[o],s[o]||o)).css({width:"100%",height:"100%"}));(o=a.BDG)&&i.append($("<img>").addClass("moremies moremi-badge").attr("src",ua(o)).css({width:"100%",height:"100%"})),i.children(".moremi-back").after($("<img>").addClass("moremies moremi-body").attr("src",a.robot?"/img/kkutu/moremi/robot.png":"/img/kkutu/moremi/body.png").css({width:"100%",height:"100%"})),i.children(".moremi-rhand").css("transform","scaleX(-1)")}function ha(e){var a=/(^[+-]?\d+)(\d{3})/;if(null===e)return"?";for(e=e.toString();a.test(e);)e=e.replace(a,"$1,$2");return e}function va(e){return alert(L["error_"+e])}function ba(e){m.yell.show().css("opacity",1).html(e),G(function(){m.yell.animate({opacity:0},3e3),G(function(){m.yell.hide()},3e3)},1e3)}delete window.WebSocket,delete window.setInterval}()})();
=======
(function(){/**
Rule the words! KKuTu Online
Copyright (C) 2017 JJoriping(op@jjo.kr)

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program. If not, see <http://www.gnu.org/licenses/>.
*/


function onSpace(a){32==a.keyCode&&($stage.chatBtn.trigger("click"),a.preventDefault())}function drawList(){var a=$data._list.slice($data.chain),b=$data.room.opts.proverb?1:5,c="",d=a[0].length;d>=20&&(c="18px"),d>=50&&(c="15px"),$stage.game.display.css("font-size",c),a[0]="<label style='color: #FFFF44;'>"+a[0]+"</label>",$stage.game.display.html(a.slice(0,b).join(" ")),$stage.game.chain.show().html($data.chain),$(".jjo-turn-time .graph-bar").width("100%").html(a.slice(b,2*b).join(" ")).css({"text-align":"center","background-color":"#70712D"})}function restGoing(a){$(".jjo-turn-time .graph-bar").html(a+L.afterRun),a>0&&addTimeout(restGoing,1e3,a-1)}function drawSpeed(a){var b;for(b in a)$("#game-user-"+b+" .game-user-score").empty().append($("<div>").css({float:"none",color:"#4444FF","text-align":"center"}).html(a[b]+"<label style='font-size: 11px;'>"+L.kpm+"</label>"))}function zeroPadding(a,b){var c=a.toString();return"000000000000000".slice(0,Math.max(0,b-c.length))+c}function send(a,b,c){var d,e={type:a},f=c?ws:rws||ws;for(d in b)e[d]=b[d];if("test"!=a&&spamCount++>10){if(++spamWarning>=3)return f.close();spamCount=5}f.send(JSON.stringify(e))}function loading(a){a?$("#Intro").is(":visible")?($stage.loading.hide(),$("#intro-text").html(a)):$stage.loading.show().html(a):$stage.loading.hide()}function showDialog(a,b){var c=[$(window).width(),$(window).height()];return!b&&a.is(":visible")?(a.hide(),!1):($(".dialog-front").removeClass("dialog-front"),a.show().addClass("dialog-front").css({left:.5*(c[0]-a.width()),top:.5*(c[1]-a.height())}),!0)}function applyOptions(a){$data.opts=a,$data.muteBGM=$data.opts.mb,$data.muteEff=$data.opts.me,$("#mute-bgm").attr("checked",$data.muteBGM),$("#mute-effect").attr("checked",$data.muteEff),$("#deny-invite").attr("checked",$data.opts.di),$("#deny-whisper").attr("checked",$data.opts.dw),$("#deny-friend").attr("checked",$data.opts.df),$("#auto-ready").attr("checked",$data.opts.ar),$("#sort-user").attr("checked",$data.opts.su),$("#only-waiting").attr("checked",$data.opts.ow),$("#only-unlock").attr("checked",$data.opts.ou),$data.bgm&&($data.muteBGM?($data.bgm.volume=0,$data.bgm.stop()):($data.bgm.volume=1,$data.bgm=playBGM($data.bgm.key,!0)))}function checkInput(){}function addInterval(a,b,c,d,e,f,g){var h=_setInterval(a,b,c,d,e,f,g);return $data._timers.push(h),h}function addTimeout(a,b,c,d,e,f,g){var h=_setTimeout(a,b,c,d,e,f,g);return $data._timers.push(h),h}function clearTrespasses(){return}function route(a,b,c,d,e,f){if($data.room){var g=RULE[MODE[$data.room.mode]];if(!g)return null;$lib[g.rule][a].call(this,b,c,d,e,f)}}function connectToRoom(a,b){var c=$data.URL.replace(/:(\d+)/,function(b,c){return":"+(Number(c)+416+Number(a)-1)})+"&"+a+"&"+b;rws||(rws=new _WebSocket(c),loading(L.connectToRoom+"\n<center><button id='ctr-close'>"+L.ctrCancel+"</button></center>"),$("#ctr-close").on("click",function(){loading(),rws&&rws.close()}),rws.onopen=function(c){console.log("room-conn",a,b)},rws.onmessage=_onMessage,rws.onclose=function(c){console.log("room-disc",a,b),rws=void 0},rws.onerror=function(a){console.warn(L.error,a)})}function checkAge(){if(!confirm(L.checkAgeAsk))return send("caj",{answer:"no"},!0);for(;;){for(var a=[],b=1;b<=3;){var c=prompt(L["checkAgeInput"+b]);if(c&&!isNaN(c=Number(c)))1==b&&(c<1e3||c>2999)?alert(c+"\n"+L.checkAgeNo):2==b&&(c<1||c>12)?alert(c+"\n"+L.checkAgeNo):3==b&&(c<1||c>31)?alert(c+"\n"+L.checkAgeNo):a[b++-1]=c;else if(--b<1)break}if(4==b){if(confirm(L.checkAgeSure+"\n"+a[0]+L.YEAR+" "+a[1]+L.MONTH+" "+a[2]+L.DATE))return send("caj",{answer:"yes",input:[a[1],a[2],a[0]]},!0)}else if(confirm(L.checkAgeCancel))return send("caj",{answer:"no"},!0)}}function onMessage(a){function b(a){ws.send(JSON.stringify({type:"recaptcha",token:a}))}var c,d;switch(a.type){case"recaptcha":var e=$("#intro-text");e.empty(),e.html("게스트는 캡챠 인증이 필요합니다.<br/>로그인을 하시면 캡챠 인증을 건너뛰실 수 있습니다.<br/><br/>"),e.append($('<div class="g-recaptcha" id="recaptcha" style="display: table; margin: 0 auto;"></div>')),grecaptcha.render("recaptcha",{sitekey:a.siteKey,callback:b});break;case"welcome":$data.id=a.id,$data.guest=a.guest,$data.admin=a.admin,$data.users=a.users,$data.robots={},$data.rooms=a.rooms,$data.place=0,$data.friends=a.friends,$data._friends={},$data._playTime=a.playTime,$data._okg=a.okg,$data._gaming=!1,$data.nickname=a.nickname,$data.exordial=a.exordial,$data.box=a.box,a.test&&alert(L.welcomeTestServer),location.hash[1]&&tryJoin(location.hash.slice(1)),updateUI(void 0,!0),welcome(),a.caj&&checkAge(),updateCommunity();break;case"conn":$data.setUser(a.user.id,a.user),updateUserList();break;case"disconn":$data.setUser(a.id,null),updateUserList();break;case"connRoom":$data._preQuick&&(playSound("success"),$stage.dialog.quick.hide(),delete $data._preQuick),$stage.dialog.quick.hide(),$data.setUser(a.user.id,a.user),d=$data.usersR[a.user.id]=a.user,d.id==$data.id?loading():notice(getDisplayName(d)+L.hasJoined),updateUserList();break;case"disconnRoom":d=$data.usersR[a.id],d&&(delete $data.usersR[a.id],notice(getDisplayName(d)+L.hasLeft),updateUserList());break;case"yell":yell(a.value),notice(a.value,L.yell);break;case"dying":yell(L.dying),notice(L.dying,L.yell);break;case"tail":notice(a.a+"|"+a.rid+"@"+a.id+": "+(a.msg instanceof String?a.msg:JSON.stringify(a.msg)).replace(/</g,"&lt;").replace(/>/g,"&gt;"),"tail");break;case"chat":a.notice?notice(L["error_"+a.code]):chat(a.profile||{title:L.robot},a.value,a.from,a.timestamp);break;case"roomStuck":rws.close();break;case"preRoom":connectToRoom(a.channel,a.id);break;case"room":processRoom(a),checkRoom(a.modify&&a.myRoom),updateUI(a.myRoom),a.modify&&$data.room&&a.myRoom&&($data._rTitle!=$data.room.title&&animModified(".room-head-title"),$data._rMode!=getOptions($data.room.mode,$data.room.opts,!0)&&animModified(".room-head-mode"),$data._rLimit!=$data.room.limit&&animModified(".room-head-limit"),$data._rRound!=$data.room.round&&animModified(".room-head-round"),$data._rTime!=$data.room.time&&animModified(".room-head-time"));break;case"updateUser":a.nickname&&($data.users[a.id].nickname=$data.users[a.id].profile.title=$data.users[a.id].profile.name=a.nickname),a.exordial&&($data.users[a.id].exordial=a.exordial),$data.room?updateUI($data.room.id==a.place):updateUI(void 0,!0);break;case"user":delete a.type,$data.setUser(a.id,a),$data.room&&updateUI($data.room.id==a.place);break;case"friends":$data._friends={};for(c in a.list)a.list[c].forEach(function(a){$data._friends[a]={server:c}});updateCommunity();break;case"friend":$data._friends[a.id]={server:"on"==a.stat&&a.s},$data._friends[a.id]&&$data.friends[a.id]&&notice(("on"==a.stat?"&lt;<b>"+L["server_"+$data._friends[a.id].server]+"</b>&gt; ":"")+L.friend+" "+$data.friends[a.id]+L["fstat_"+a.stat]),updateCommunity();break;case"friendAdd":d=$data.users[a.from].profile,c=(d.title||d.name)+"(#"+a.from.substr(0,5)+")",send("friendAddRes",{from:a.from,res:!$data.opts.df&&confirm(c+L.attemptFriendAdd)},!0);break;case"friendAddRes":d=$data.users[a.target].profile,c=(d.title||d.name)+"(#"+a.target.substr(0,5)+")",notice(c+L["friendAddRes_"+(a.res?"ok":"no")]),a.res&&($data.friends[a.target]=d.title||d.name,$data._friends[a.target]={server:$data.server},updateCommunity());break;case"friendEdit":$data.friends=a.friends,updateCommunity();break;case"starting":loading(L.gameLoading);break;case"roundReady":route("roundReady",a);break;case"turnStart":route("turnStart",a);break;case"turnError":turnError(a.code,a.value);break;case"turnHint":route("turnHint",a);break;case"turnEnd":a.score=Number(a.score),a.bonus=Number(a.bonus),$data.room&&($data._tid=a.target||$data.room.game.seq[$data.room.game.turn],$data._tid&&($data._tid.robot&&($data._tid=$data._tid.id),turnEnd($data._tid,a)),a.baby&&playSound("success"));break;case"roundEnd":for(c in a.users)$data.setUser(c,a.users[c]);$data._resultRank=a.ranks,roundEnd(a.result,a.data);break;case"kickVote":$data._kickTarget=$data.users[a.target],$data.id!=a.target&&$data.id!=$data.room.master&&kickVoting(a.target),notice(getDisplayName($data._kickTarget)+L.kickVoting);break;case"kickDeny":notice(getKickText($data._kickTarget.profile,a));break;case"invited":send("inviteRes",{from:a.from,res:!$data.opts.di&&confirm(a.from+L.invited)});break;case"inviteNo":d=$data.users[a.target],notice(getDisplayName(d)+L.inviteDenied);break;case"okg":$data._playTime>a.time?notice(L.okgExpired):$data._okg!=a.count&&notice(L.okgNotice+" ("+L.okgCurrent+a.count+")"),$data._playTime=a.time,$data._okg=a.count;break;case"obtain":queueObtain(a);break;case"expired":for(c in a.list)notice(iName(a.list[c])+L.hasExpired);break;case"blocked":notice(L.blocked);break;case"test":($data._test=!$data._test)?($data._testt=addInterval(function(){$stage.talk.val()!=$data._ttv&&(send("test",{ev:"c",v:$stage.talk.val()},!0),$data._ttv=$stage.talk.val())},100),document.onkeydown=function(a){send("test",{ev:"d",c:a.keyCode},!0)},document.onkeyup=function(a){send("test",{ev:"u",c:a.keyCode},!0)}):(clearInterval($data._testt),document.onkeydown=void 0,document.onkeyup=void 0);break;case"error":if(c=a.message||"",401==a.code);else if(403==a.code)loading();else if(406==a.code){if($stage.dialog.quick.is(":visible")){$data._preQuick=!1;break}}else if(409==a.code)c=L["server_"+c];else{if(416==a.code)return void(confirm(L["error_"+a.code])&&(stopBGM(),$data._spectate=!0,$data._gaming=!0,send("enter",{id:a.target,password:$data._pw,spectate:!0},!0)));if(413==a.code)$stage.dialog.room.hide(),$stage.menu.setRoom.trigger("click");else if(429==a.code)playBGM("lobby");else if(430==a.code){if($data.setRoom(a.message,null),$stage.dialog.quick.is(":visible")){$data._preQuick=!1;break}}else if(431==a.code||432==a.code||433==a.code)$stage.dialog.room.show();else{if(444==a.code){if(c=a.message,-1!=c.indexOf("생년월일")){alert("생년월일이 올바르게 입력되지 않아 게임 이용이 제한되었습니다. 잠시 후 다시 시도해 주세요.");break}if(!a.blockedUntil)break;var f=new Date(parseInt(a.blockedUntil)),g="\n제한 시점: "+f.getFullYear()+"년 "+f.getMonth()+"1월 "+f.getDate()+"일 "+f.getHours()+"시 "+f.getMinutes()+"분까지";alert("[#444] "+L.error_444+c+g);break}if(446==a.code){if(c=a.reasonBlocked,!a.ipBlockedUntil)break;var f=new Date(parseInt(a.ipBlockedUntil)),g="\n제한 시점: "+f.getFullYear()+"년 "+f.getMonth()+"1월 "+f.getDate()+"일 "+f.getHours()+"시 "+f.getMinutes()+"분까지";alert("[#446] "+L.error_446+c+g);break}if(447===a.code){alert("자동화 봇 방지를 위한 캡챠 인증에 실패했습니다. 메인 화면에서 다시 시도해 주세요.");break}}}alert("[#"+a.code+"] "+L["error_"+a.code]+c)}$data._record&&recordEvent(a)}function welcome(){playBGM("lobby"),$("#Intro").animate({opacity:1},1e3).animate({opacity:0},1e3),$("#intro-text").text(L.welcome),addTimeout(function(){$("#Intro").hide()},2e3),$data.admin&&console.log("관리자 모드")}function getKickText(a,b){var c=L.agree+" "+b.Y+", "+L.disagree+" "+b.N+L.kickCon;return b.Y>=b.N?c+=(a.title||a.name)+L.kicked:c+=(a.title||a.name)+L.kickDenied,c}function runCommand(a){var b,c,d={"/ㄱ":L.cmd_r,"/청소":L.cmd_cls,"/ㄹ":L.cmd_f,"/ㄷ":L.cmd_e,"/ㄷㄷ":L.cmd_ee,"/무시":L.cmd_wb,"/차단":L.cmd_shut,"/id":L.cmd_id};switch(a[0].toLowerCase()){case"/ㄱ":case"/r":$data.room&&($data.room.master==$data.id?$stage.menu.start.trigger("click"):$stage.menu.ready.trigger("click"));break;case"/청소":case"/cls":clearChat();break;case"/ㄹ":case"/f":showDialog($stage.dialog.chatLog),$stage.chatLog.scrollTop(999999999);break;case"/귓":case"/ㄷ":case"/e":sendWhisper(a[1],a.slice(2).join(" "));break;case"/답":case"/ㄷㄷ":case"/ee":$data._recentFrom?sendWhisper($data._recentFrom,a.slice(1).join(" ")):notice(L.error_425);break;case"/무시":case"/wb":toggleWhisperBlock(a[1]);break;case"/차단":case"/shut":toggleShutBlock(a.slice(1).join(" "));break;case"/id":if(a[1]){c=0,a[1]=a.slice(1).join(" ");for(b in $data.users)getDisplayName($data.users[b])==a[1]&&notice("["+ ++c+"] "+b);c||notice(L.error_405)}else notice(L.myId+$data.id);break;default:for(b in d)notice(d[b],b)}}function sendWhisper(a,b){b.length&&($data._whisper=a,send("talk",{whisper:a,value:b},!0),chat({title:"→"+a},b,!0))}function toggleWhisperBlock(a){$data._wblock.hasOwnProperty(a)?(delete $data._wblock[a],notice(a+L.wnblocked)):($data._wblock[a]=!0,notice(a+L.wblocked))}function toggleShutBlock(a){$data._shut.hasOwnProperty(a)?(delete $data._shut[a],notice(a+L.userNShut)):($data._shut[a]=!0,notice(a+L.userShut))}function tryDict(a,b){var a=a.replace(/[^\sa-zA-Zㄱ-ㅎ0-9가-힣]/g,""),c=a.match(/[ㄱ-ㅎ가-힣]/)?"ko":"en";if(a.length<1)return b({error:404});$.get("/dict/"+a+"?lang="+c,b)}function processRoom(a){var b,c,d,e;if(a.myRoom=$data.place==a.room.id||a.target==$data.id,a.myRoom){if($target=$data.users[a.target],a.kickVote&&(notice(getKickText($target.profile,a.kickVote)),$target.id==a.id&&alert(L.hasKicked)),-1==a.room.players.indexOf($data.id))$data.room&&$data.room.gaming&&(stopAllSounds(),$data.practicing=!1,$data._gaming=!1,$stage.box.room.height(360),playBGM("lobby")),$data.users[$data.id].game.ready=!1,$data.users[$data.id].game.team=0,$data.users[$data.id].game.form="J",$stage.menu.spectate.removeClass("toggled"),$stage.menu.ready.removeClass("toggled"),$data.room=null,$data.resulting=!1,$data._players=null,$data._master=null,$data.place=0,a.room.practice&&(delete $data.users[0],$data.room=$data._room,$data.place=$data._place,$data.master=$data.__master,$data._players=$data.__players,delete $data._room);else if(a.room.practice&&!$data.practicing&&($data.practicing=!0,$data._room=$data.room,$data._place=$data.place,$data.__master=$data.master,$data.__players=$data._players),$data.room&&($data._players=$data.room.players.toString(),$data._master=$data.room.master,$data._rTitle=$data.room.title,$data._rMode=getOptions($data.room.mode,$data.room.opts,!0),$data._rLimit=$data.room.limit,$data._rRound=$data.room.round,$data._rTime=$data.room.time),$data.room=a.room,$data.place=$data.room.id,$data.master=$data.room.master==$data.id,a.spec&&a.target==$data.id){if($data._spectate||($data._spectate=!0,clearBoard(),drawRound()),a.boards){$data.selectedRound=1;for(b in a.prisoners){d=b.split(",");for(c in a.boards[d[0]])if(e=a.boards[d[0]][c],e[0]==d[1]&&e[1]==d[2]&&e[2]==d[3]){e[4]=a.prisoners[b];break}}$lib.Crossword.roundReady(a,!0),$lib.Crossword.turnStart(a,!0)}for(b in a.spec)$data.users[b].game.score=a.spec[b]}a.modify||a.target!=$data.id||forkChat()}if(a.target&&$data.users[a.target]&&(-1==a.room.players.indexOf(a.target)?$data.users[a.target].place=0:$data.users[a.target].place=a.room.id),!a.room.practice)if(a.room.players.length){$data.setRoom(a.room.id,a.room);for(b in a.room.readies)$data.users[b]&&($data.users[b].game.ready=a.room.readies[b].r,$data.users[b].game.team=a.room.readies[b].t)}else $data.setRoom(a.room.id,null)}function getOnly(){return $data.place?$data.room.gaming||$data.resulting?"for-gaming":$data.master?"for-master":"for-normal":"for-lobby"}function updateUI(a,b){var c,d=getOnly();if($data._replay){if(void 0!==a&&!a)return;replayStop()}if(!$data._replay&&("for-gaming"!=d||a)){$data.practicing&&(d="for-gaming"),$(".kkutu-menu button").hide();for(c in $stage.box)$stage.box[c].hide();$stage.box.me.show(),$stage.box.chat.show().width(790).height(190),$stage.chat.height(120),"for-lobby"==d?($data._ar_first=!0,$stage.box.userList.show(),$data._shop?($stage.box.roomList.hide(),$stage.box.shop.show()):($stage.box.roomList.show(),$stage.box.shop.hide()),updateUserList(b||d!=$data._only),updateRoomList(b||d!=$data._only),updateMe(),$data._jamsu&&(clearTimeout($data._jamsu),delete $data._jamsu)):"for-master"==d||"for-normal"==d?($(".team-chosen").removeClass("team-chosen"),$data.users[$data.id].game.ready||"S"==$data.users[$data.id].game.form?($stage.menu.ready.addClass("toggled"),$(".team-selector").addClass("team-unable")):($stage.menu.ready.removeClass("toggled"),$(".team-selector").removeClass("team-unable"),$("#team-"+$data.users[$data.id].game.team).addClass("team-chosen"),$data.opts.ar&&$data._ar_first&&($stage.menu.ready.addClass("toggled"),$stage.menu.ready.trigger("click"),$data._ar_first=!1)),$data._shop=!1,$stage.box.room.show().height(360),"for-master"==d&&$stage.dialog.inviteList.is(":visible")&&updateUserList(),updateRoom(!1),updateMe()):"for-gaming"==d&&($data._gAnim&&($stage.box.room.show(),$data._gAnim=!1),$data._shop=!1,$data._ar_first=!0,$stage.box.me.hide(),$stage.box.game.show(),$(".ChatBox").width(1e3).height(140),$stage.chat.height(70),updateRoom(!0)),$data._only=d,setLocation($data.place),$(".kkutu-menu ."+d).show()}}function animModified(a){$(a).addClass("room-head-modified"),addTimeout(function(){$(a).removeClass("room-head-modified")},3e3)}function checkRoom(a){if($data._players&&$data.room){var b,c,d={}+"",e=$data._players.split(","),f=e.length,g=$data.room.players.length;for(b in e)e[b]==d&&f--;for(b in $data.room.players)$data.room.players[b].robot&&g--;if(a){for(b in e)e[b]!=d&&($data.users[e[b]].game.ready=!1);notice(L.hasModified)}$data._gaming!=$data.room.gaming&&($data.room.gaming?(gameReady(),$data._replay=!1,startRecord($data.room.game.title)):($data._spectate?($stage.dialog.resultSave.hide(),$data._spectate=!1,playBGM("lobby")):($stage.dialog.resultSave.show(),$data.resulting=!0),clearInterval($data._tTime))),$data._master!=$data.room.master&&(c=$data.users[$data.room.master],notice(getDisplayName(c)+L.hasMaster)),$data._players=$data.room.players.toString(),$data._master=$data.room.master,$data._gaming=$data.room.gaming}}function updateMe(){var a,b=$data.users[$data.id],c=0,d=getLevel(b.data.score),e=EXP[d-2]||0,f=EXP[d-1];for(a in b.data.record)c+=b.data.record[a][1];renderMoremi(".my-image",b.equip),$(".my-stat-level").replaceWith(getLevelImage(b.data.score).addClass("my-stat-level")),$(".my-stat-name").html(getDisplayName(b)),$(".my-stat-record").html(L.globalWin+" "+c+L.W),$(".my-stat-ping").html(commify(b.money)+L.ping),$(".my-okg .graph-bar").width($data._playTime%6e5/6e3+"%"),$(".my-okg-text").html(prettyTime($data._playTime)),$(".my-level").html(L.LEVEL+" "+d),$(".my-gauge .graph-bar").width((b.data.score-e)/(f-e)*190),$(".my-gauge-text").html(commify(b.data.score)+" / "+commify(f))}function prettyTime(a){var b=Math.floor(a/6e4)%60,c=Math.floor(.001*a)%60,d=Math.floor(a/36e5),e=[];return d&&e.push(d+L.HOURS),b&&e.push(b+L.MINUTE),d||e.push(c+L.SECOND),e.join(" ")}function updateUserList(a){var b,c,d,e=0;if($data.opts.su){d=[];for(b in $data.users)e++,d.push($data.users[b]);d.sort(function(a,b){return b.data.score-a.data.score}),a=!0}else{d=$data.users;for(b in $data.users)e++}if($stage.lobby.userListTitle.html("<i class='fa fa-users'></i>&lt;<b>"+L["server_"+$data.server]+"</b>&gt; "+L.UserList.replace("FA{users}","")+" ["+e+L.MN+"]"),a){$stage.lobby.userList.empty(),$stage.dialog.inviteList.empty();for(b in d)c=d[b],c.robot||($stage.lobby.userList.append(userListBar(c)),0==c.place&&$stage.dialog.inviteList.append(userListBar(c,!0)))}}function userListBar(a,b){var c;return c=b?$("<div>").attr("id","invite-item-"+a.id).addClass("invite-item users-item").append($("<div>").addClass("jt-image users-image").css("background-image","url('"+a.profile.image+"')")).append(getLevelImage(a.data.score).addClass("users-level")).append($("<div>").addClass("users-name").html(getDisplayName(a))).on("click",function(a){requestInvite($(a.currentTarget).attr("id").slice(12))}):$("<div>").attr("id","users-item-"+a.id).addClass("users-item").append($("<div>").addClass("jt-image users-image").css("background-image","url('"+a.profile.image+"')")).append(getLevelImage(a.data.score).addClass("users-level")).append($("<div>").addClass("users-name ellipse").html(getDisplayName(a))).on("click",function(a){requestProfile($(a.currentTarget).attr("id").slice(11))}),addonNickname(c,a),c}function addonNickname(a,b){b.equip.NIK&&a.addClass("x-"+b.equip.NIK),"b1_gm"==b.equip.BDG&&a.addClass("x-gm")}function updateRoomList(a){function b(a){$stage.menu.newRoom.trigger("click")}var c,d=0;if(a){$stage.lobby.roomList.empty();for(c in $data.rooms)$stage.lobby.roomList.append(roomListBar($data.rooms[c])),d++}else{$(".rooms-create").remove();for(c in $data.rooms)d++}$stage.lobby.roomListTitle.html(L.RoomList.replace("FA{bars}","<i class='fa fa-bars'></i>")+" ["+d+L.GAE+"]"),d?($(".rooms-gaming").css("display",$data.opts.ow?"none":""),$(".rooms-locked").css("display",$data.opts.ou?"none":"")):$stage.lobby.roomList.append($stage.lobby.createBanner.clone().on("click",b))}function roomListBar(a){var b,c,d=getOptions(a.mode,a.opts);return b=$("<div>").attr("id","room-"+a.id).addClass("rooms-item").append(c=$("<div>").addClass("rooms-channel channel-"+a.channel).on("click",function(b){requestRoomInfo(a.id)})).append($("<div>").addClass("rooms-number").html(a.id)).append($("<div>").addClass("rooms-title ellipse").text(badWords(a.title))).append($("<div>").addClass("rooms-limit").html(a.players.length+" / "+a.limit)).append($("<div>").width(270).append($("<div>").addClass("rooms-mode").html(d.join(" / ").toString())).append($("<div>").addClass("rooms-round").html(L.rounds+" "+a.round)).append($("<div>").addClass("rooms-time").html(a.time+L.SECOND))).append($("<div>").addClass("rooms-lock").html(a.password?"<i class='fa fa-lock'></i>":"<i class='fa fa-unlock'></i>")).on("click",function(a){a.target!=c.get(0)&&tryJoin($(a.currentTarget).attr("id").slice(5))}),a.gaming&&b.addClass("rooms-gaming"),a.password&&b.addClass("rooms-locked"),b}function normalGameUserBar(a){var b,c,d,e=$("<div>").attr("id","game-user-"+a.id).addClass("game-user").append(b=$("<div>").addClass("moremi game-user-image")).append($("<div>").addClass("game-user-title").append(getLevelImage(a.data.score).addClass("game-user-level")).append(d=$("<div>").addClass("game-user-name ellipse").html(getDisplayName(a))).append($("<div>").addClass("expl").html(L.LEVEL+" "+getLevel(a.data.score)))).append(c=$("<div>").addClass("game-user-score"));return renderMoremi(b,a.equip),global.expl(e),addonNickname(d,a),a.game.team&&c.addClass("team-"+a.game.team),e}function miniGameUserBar(a){var b,c,d=$("<div>").attr("id","game-user-"+a.id).addClass("game-user").append($("<div>").addClass("game-user-title").append(getLevelImage(a.data.score).addClass("game-user-level")).append(c=$("<div>").addClass("game-user-name ellipse").html(getDisplayName(a)))).append(b=$("<div>").addClass("game-user-score"));return a.id==$data.id&&c.addClass("game-user-my-name"),addonNickname(c,a),a.game.team&&b.addClass("team-"+a.game.team),d}function getAIProfile(a){return{title:L["aiLevel"+a]+" "+L.robot,image:"/img/kkutu/robot.png"}}function updateRoom(a){var b,c,d,e,f,g,h,i,j=RULE[MODE[$data.room.mode]],k=mobile||j.big?miniGameUserBar:normalGameUserBar,l=!1,m=!0;if(setRoomHead($(".RoomBox .product-title"),$data.room),setRoomHead($(".GameBox .product-title"),$data.room),a){d=$(".GameBox .game-body").empty();for(b in $data.room.game.seq)c=$data._replay?$rec.users[$data.room.game.seq[b]]||$data.room.game.seq[b]:$data.users[$data.room.game.seq[b]]||$data.robots[$data.room.game.seq[b].id]||$data.room.game.seq[b],c.robot&&!c.profile&&(c.profile=getAIProfile(c.level),$data.robots[c.id]=c),d.append(k(c)),updateScore(c.id,c.game.score||0);clearTimeout($data._jamsu),delete $data._jamsu}else{d=$(".room-users").empty(),i="S"==$data.users[$data.id].game.form;for(b in $data.room.players)if(c=$data.users[$data.room.players[b]]||$data.room.players[b],c.game){var n=c.game.practice?"/"+L.stat_practice:"",i="S"==c.game.form&&"/"+L.stat_spectate;c.robot&&(c.profile=getAIProfile(c.level),$data.robots[c.id]=c),d.append($("<div>").attr("id","room-user-"+c.id).addClass("room-user").append(g=$("<div>").addClass("moremi room-user-image")).append($("<div>").addClass("room-user-stat").append(e=$("<div>").addClass("room-user-ready")).append(f=$("<div>").addClass("room-user-team team-"+c.game.team).html($("#team-"+c.game.team).html()))).append($("<div>").addClass("room-user-title").append(getLevelImage(c.data.score).addClass("room-user-level")).append(h=$("<div>").addClass("room-user-name").html(getDisplayName(c)))).on("click",function(a){requestProfile($(a.currentTarget).attr("id").slice(10))})),renderMoremi(g,c.equip),i&&f.hide(),c.id==$data.room.master?e.addClass("room-user-master").html(L.master+n+(i||"")):i?e.addClass("room-user-spectate").html(L.stat_spectate+n):c.game.ready||c.robot?(e.addClass("room-user-readied").html(L.stat_ready),c.robot||(l=!0)):c.game.practice?(e.addClass("room-user-practice").html(L.stat_practice),m=!1):(e.html(L.stat_noready),m=!1),addonNickname(h,c)}l&&$data.room.master==$data.id&&m?$data._jamsu||($data._jamsu=addTimeout(onMasterSubJamsu,5e3)):(clearTimeout($data._jamsu),delete $data._jamsu)}$stage.dialog.profile.is(":visible")&&requestProfile($data._profiled)}function onMasterSubJamsu(){notice(L.subJamsu),$data._jamsu=addTimeout(function(){send("leave"),alert(L.masterJamsu)},3e4)}function updateScore(a,b){var c;return(c=$data["_s"+a])?(clearTimeout(c.timer),c.$obj=$("#game-user-"+a+" .game-user-score"),c.goal=b):c=$data["_s"+a]={$obj:$("#game-user-"+a+" .game-user-score"),goal:b,now:0},animateScore(c),$("#game-user-"+a)}function animateScore(a){var b=(a.goal-a.now)*Math.min(1,.01*TICK);b<.1?b=a.goal-a.now:a.timer=addTimeout(animateScore,TICK,a),a.now+=b,drawScore(a.$obj,Math.round(a.now))}function drawScore(a,b){var c,d=b>99999?zeroPadding(Math.round(.001*b),4)+"k":zeroPadding(b,5);for(a.empty(),c=0;c<d.length;c++)a.append($("<div>").addClass("game-user-score-char").html(d[c]))}function drawMyDress(a){var b=$("#dress-view"),c=$data.users[$data.id];renderMoremi(b,c.equip),$(".dress-type.selected").removeClass("selected"),$("#dress-type-all").addClass("selected"),$("#dress-nickname").val(c.nickname),$("#dress-exordial").val(c.exordial),drawMyGoods(a||!0)}function renderGoods(a,b,c,d,e){var f,g,h,i,j,k,l=[],m=!0===c;a.empty(),d||(d={});for(k in d)$data.box.hasOwnProperty(d[k])||($data.box[d[k]]={value:0});for(k in $data.box)l.push({key:k,obj:iGoods(k),value:$data.box[k]});l.sort(function(a,b){return a.obj.name<b.obj.name?-1:1});for(k in l)g=l[k].obj,h=l[k].value,i=g.group,"BDG"==i.substr(0,3)&&(i="BDG"),j="Mhand"==i?d.Mlhand==l[k].key||d.Mrhand==l[k].key:d[i]==l[k].key,"number"==typeof h&&(h={value:h}),(h.hasOwnProperty("value")||j)&&(m||-1!=c.indexOf(g.group))&&(a.append(f=$("<div>").addClass("dress-item").append(getImage(g.image).addClass("dress-item-image").html("x"+h.value)).append(explainGoods(g,j,h.expire))),f.attr("id",b+"-"+g._id).on("click",e),j&&f.addClass("dress-equipped"));global.expl(a)}function drawMyGoods(a){var b,c=$data.users[$data.id].equip||{},d=!0===a;$data._avGroup=a,b=!!d||(a||"").split(","),renderGoods($("#dress-goods"),"dress",b,c,function(a){var b,c=$(a.currentTarget),d=c.attr("id").slice(6),e=iGoods(d);if(a.ctrlKey){if(c.hasClass("dress-equipped"))return fail(426);if(!confirm(L.surePayback+commify(Math.round(.2*(e.cost||0)))+L.ping))return;$.post("/payback/"+d,function(a){if(a.error)return fail(a.error);alert(L.painback),$data.box=a.box,$data.users[$data.id].money=a.money,drawMyDress($data._avGroup),updateUI(!1)})}else if(-1!=AVAIL_EQUIP.indexOf(e.group))"Mhand"==e.group&&(b=confirm(L.dressWhichHand)),requestEquip(d,b);else if("CNS"==e.group){if(!confirm(L.sureConsume))return;$.post("/consume/"+d,function(a){a.exp&&notice(L.obtainExp+": "+commify(a.exp)),a.money&&notice(L.obtainMoney+": "+commify(a.money)),a.gain.forEach(function(a){queueObtain(a)}),$data.box=a.box,$data.users[$data.id].data=a.data,send("refresh"),drawMyDress($data._avGroup),updateMe()})}})}function requestEquip(a,b){var c=$data.users[$data.id],d=$data.shop[a].group;"Mhand"==d&&(d=b?"Mlhand":"Mrhand"),"BDG"==d.substr(0,3)&&(d="BDG");var e=c.equip[d]==a;confirm(L[e?"sureUnequip":"sureEquip"]+": "+L[a][0])&&$.post("/equip/"+a,{isLeft:b},function(a){if(a.error)return fail(a.error);$data.box=a.box,c.equip=a.equip,drawMyDress($data._avGroup),send("refresh"),updateUI(!1)})}function drawCharFactory(){function a(){e.html($("<h4>").css("padding-top","8px").width("100%").html(L.cfTray))}function b(){var b,h={WPC:1,WPB:2,WPA:3},j="",k=0;e.empty(),$(".cf-tray-selected").removeClass("cf-tray-selected"),$data._tray.forEach(function(a){b=iGoods(a),j+=a.slice(4),k+=h[a.slice(1,4)],e.append($("<div>").addClass("jt-image").css("background-image","url("+b.image+")").attr("id","cf-tray-"+a).on("click",d)),$("#cf-\\"+a).addClass("cf-tray-selected")}),f.html(L.searching),g.empty(),$stage.dialog.cfCompose.removeClass("cf-composable"),i.html(""),tryDict(j,function(a){var b=!1;if(a.error){if(3!=j.length)return f.html(L["wpFail_"+a.error]);b=!0,f.html(L.cfBlend)}c(j,k,b),$stage.dialog.cfCompose.addClass("cf-composable"),a.error||f.html(processWord(a.word,a.mean,a.theme,a.type.split(",")))}),""==j&&a()}function c(a,b,c){$.get("/cf/"+a+"?l="+b+"&b="+(c?"1":""),function(a){if(a.error)return fail(a.error);g.empty(),a.data.forEach(function(a){var b=iGoods(a.key),c=a.rate>=1?L.cfRewAlways:(100*a.rate).toFixed(1)+"%";g.append($("<div>").addClass("cf-rew-item").append($("<div>").addClass("jt-image cf-rew-image").css("background-image","url("+b.image+")")).append($("<div>").width(100).append($("<div>").width(100).html(b.name)).append($("<div>").addClass("cf-rew-value").html("x"+a.value))).append($("<div>").addClass("cf-rew-rate").html(c)))}),i.html(L.cfCost+": "+a.cost+L.ping)})}function d(a){var c=$(a.currentTarget).attr("id").slice(8),d=$data._tray.indexOf(c);-1!=d&&($data._tray.splice(d,1),b())}var e=$("#cf-tray"),f=$("#cf-dict"),g=$("#cf-reward"),h=$("#cf-goods"),i=$("#cf-cost");$data._tray=[],f.empty(),g.empty(),i.html(""),$stage.dialog.cfCompose.removeClass("cf-composable"),renderGoods(h,"cf",["PIX","PIY","PIZ"],null,function(a){var c,d=$(a.currentTarget),e=d.attr("id").slice(3),f=$data.box[e],g=0;if($data._tray.length>=6)return fail(435);for(c in $data._tray)$data._tray[c]==e&&g++;f-g>0?($data._tray.push(e),b()):fail(434)}),a()}function drawLeaderboard(a){var b=$stage.dialog.lbTable.empty(),c=a.data[0]?a.data[0].rank:0,d=(a.page||Math.floor(c/20))+1;a.data.forEach(function(a,c){var d=$data.users[a.id];d=d?d.profile.title||d.profile.name:L.hidden,a.score=Number(a.score),b.append($("<tr>").attr("id","ranking-"+a.id).addClass("ranking-"+(a.rank+1)).append($("<td>").html(a.rank+1)).append($("<td>").append(getLevelImage(a.score).addClass("ranking-image")).append($("<label>").css("padding-top",2).html(getLevel(a.score)))).append($("<td>").html(d)).append($("<td>").html(commify(a.score))))}),$("#ranking-"+$data.id).addClass("ranking-me"),$stage.dialog.lbPage.html(L.page+" "+d),$stage.dialog.lbPrev.attr("disabled",d<=1),$stage.dialog.lbNext.attr("disabled",a.data.length<15),$stage.dialog.lbMe.attr("disabled",!!$data.guest),$data._lbpage=d-1}function updateCommunity(){function a(a){var b=$(a.currentTarget).parent().parent().attr("id").slice(4),c=$data.friends[b],d=prompt(L.friendEditMemo,c);d&&send("friendEdit",{id:b,memo:d},!0)}function b(a){var b=$(a.currentTarget).parent().parent().attr("id").slice(4),c=$data.friends[b];if($data._friends[b].server)return fail(455);confirm(c+"(#"+b.substr(0,5)+")\n"+L.friendSureRemove)&&send("friendRemove",{id:b},!0)}var c,d,e,f,g=0;$stage.dialog.commFriends.empty();for(c in $data.friends)g++,f=$data.friends[c],d=$data._friends[c]||{},e=($data.users[c]||{}).profile,$stage.dialog.commFriends.append($("<div>").addClass("cf-item").attr("id","cfi-"+c).append($("<div>").addClass("cfi-status cfi-stat-"+(d.server?"on":"off"))).append($("<div>").addClass("cfi-server").html(d.server?L["server_"+d.server]:"-")).append($("<div>").addClass("cfi-name ellipse").html(e?e.title||e.name:L.hidden)).append($("<div>").addClass("cfi-memo ellipse").text(f)).append($("<div>").addClass("cfi-menu").append($("<i>").addClass("fa fa-pencil").on("click",a)).append($("<i>").addClass("fa fa-remove").on("click",b))));$("#CommunityDiag .dialog-title").html(L.communityText+" ("+g+" / 100)")}function requestRoomInfo(a){var b=$data.rooms[a],c=$("#ri-players").empty();$data._roominfo=a,$("#RoomInfoDiag .dialog-title").html(a+L.sRoomInfo),$("#ri-title").html((b.password?"<i class='fa fa-lock'></i>&nbsp;":"")+b.title),$("#ri-mode").html(L["mode"+MODE[b.mode]]),
$("#ri-round").html(b.round+", "+b.time+L.SECOND),$("#ri-limit").html(b.players.length+" / "+b.limit),b.players.forEach(function(a,d){var e,f,g=b.readies[a]||{};a=$data.users[a]||NULL_USER,b.players[d].robot?(a.profile={title:L.robot},a.equip={robot:!0}):g.t=g.t||0,c.append($("<div>").addClass("ri-player").append(f=$("<div>").addClass("moremi rip-moremi")).append(e=$("<div>").addClass("ellipse rip-title").html(getDisplayName(a))).append($("<div>").addClass("rip-team team-"+g.t).html($("#team-"+g.t).html())).append($("<div>").addClass("rip-form").html(L["pform_"+g.f]))),a.id==b.master&&e.prepend($("<label>").addClass("rip-master").html("["+L.master+"]&nbsp;")),e.prepend(getLevelImage(a.data.score).addClass("profile-level rip-level")),renderMoremi(f,a.equip)}),showDialog($stage.dialog.roomInfo),$stage.dialog.roomInfo.show()}function requestProfile(a){var b,c,d,e=$data.users[a]||$data.robots[a],f=$("#profile-record").empty();if(!e)return void notice(L.error_405);if($("#ProfileDiag .dialog-title").html(getDisplayName(e)+L.sProfile),$(".profile-head").empty().append(b=$("<div>").addClass("moremi profile-moremi")).append($("<div>").addClass("profile-head-item").append(getImage(e.profile.image).addClass("profile-image")).append($("<div>").addClass("profile-title ellipse").html(getDisplayName(e)).append($("<label>").addClass("profile-tag").html(" #"+e.id.toString().substr(0,5))))).append($("<div>").addClass("profile-head-item").append(getLevelImage(e.data.score).addClass("profile-level")).append($("<div>").addClass("profile-level-text").html(L.LEVEL+" "+(d=getLevel(e.data.score)))).append($("<div>").addClass("profile-score-text").html(commify(e.data.score)+" / "+commify(EXP[d-1])+L.PTS))).append(c=$("<div>").addClass("profile-head-item profile-exordial ellipse").text(badWords(e.exordial||"")).append($("<div>").addClass("expl").css({"white-space":"normal",width:300,"font-size":"11px"}).text(e.exordial))),e.robot)$stage.dialog.profileLevel.show(),$stage.dialog.profileLevel.prop("disabled",$data.id!=$data.room.master),$("#profile-place").html($data.room.id+L.roomNumber);else{$stage.dialog.profileLevel.hide(),$("#profile-place").html(e.place?e.place+L.roomNumber:L.lobby);for(d in e.data.record){var g=e.data.record[d];f.append($("<div>").addClass("profile-record-field").append($("<div>").addClass("profile-field-name").html(L["mode"+d])).append($("<div>").addClass("profile-field-record").html(g[0]+L.P+" "+g[1]+L.W)).append($("<div>").addClass("profile-field-score").html(commify(g[2])+L.PTS)))}renderMoremi(b,e.equip)}$data._profiled=a,$stage.dialog.profileKick.hide(),$stage.dialog.profileShut.hide(),$stage.dialog.profileDress.hide(),$stage.dialog.profileWhisper.hide(),$stage.dialog.profileHandover.hide(),$data.id==a?$stage.dialog.profileDress.show():e.robot||($stage.dialog.profileShut.show(),$stage.dialog.profileWhisper.show()),$data.room&&$data.id!=a&&$data.id==$data.room.master&&($stage.dialog.profileKick.show(),$stage.dialog.profileHandover.show()),showDialog($stage.dialog.profile),$stage.dialog.profile.show(),global.expl(c)}function requestInvite(a){var b;("AI"==a||(b=getDisplayName($data.users[a]),confirm(b+L.sureInvite)))&&send("invite",{target:a})}function checkFailCombo(a){$data._replay||$data.lastFail!=$data.id||$data.id!=a?$data.failCombo=0:($data.failCombo++,1==$data.failCombo&&notice(L.trollWarning),$data.failCombo>1&&(send("leave"),fail(437))),$data.lastFail=a}function clearGame(){$data._spaced&&$lib.Typing.spaceOff(),clearInterval($data._tTime),$data._relay=!1}function gameReady(){var a,b;for(a in $data.room.players)b=$data._replay?$rec.users[$data.room.players[a]]||$data.room.players[a]:$data.users[$data.room.players[a]]||$data.robots[$data.room.players[a].id],b.game.score=0,delete $data["_s"+$data.room.players[a]];delete $data.lastFail,$data.failCombo=0,$data._spectate=-1==$data.room.game.seq.indexOf($data.id),$data._gAnim=!0,$stage.box.room.show().height(360).animate({height:1},500),$stage.box.game.height(1).animate({height:410},500),stopBGM(),$stage.dialog.resultSave.attr("disabled",!1),clearBoard(),$stage.game.display.html(L.soon),playSound("game_start"),forkChat(),addTimeout(function(){$stage.box.room.height(360).hide(),$stage.chat.scrollTop(999999999)},500)}function replayPrevInit(){var a;for(a in $data.room.game.seq)$data.room.game.seq[a].robot&&($data.room.game.seq[a].game.score=0);$rec.users={};for(a in $rec.players){var b=$rec.players[a].id,c=$rec.readies[b]||{},d=$data.users[b]||$data.robots[b],e=b;$rec.players[a].robot?(d=$rec.users[b]={robot:!0},e=$rec.players[a],e.game={}):d=$rec.users[b]={},$data.room.players.push(e),d.id=e,d.profile=$rec.players[a],d.data=d.profile.data,d.equip=d.profile.equip,d.game={score:0,team:c.t}}$data._rf=0}function replayReady(){var a;replayStop(),$data._replay=!0,$data.room={title:$rec.title,players:[],events:[],time:$rec.roundTime,round:$rec.round,mode:$rec.mode,limit:$rec.limit,game:$rec.game,opts:$rec.opts,readies:$rec.readies},replayPrevInit();for(a in $rec.events)$data.room.events.push($rec.events[a]);$stage.box.userList.hide(),$stage.box.roomList.hide(),$stage.box.game.show(),$stage.dialog.replay.hide(),gameReady(),updateRoom(!0),$data.$gp=$(".GameBox .product-title").empty().append($data.$gpt=$("<div>").addClass("game-replay-title")).append($data.$gpc=$("<div>").addClass("game-replay-controller").append($("<button>").html(L.replayNext).on("click",replayNext)).append($("<button>").html(L.replayPause).on("click",replayPause)).append($("<button>").html(L.replayPrev).on("click",replayPrev))),$data._gpp=L.replay+" - "+new Date($rec.time).toLocaleString(),$data._gtt=$data.room.events[$data.room.events.length-1].time,$data._eventTime=0,$data._rt=addTimeout(replayTick,2e3),$data._rprev=0,$data._rpause=!1,replayStatus()}function replayPrev(a){var b,c,d=$data.room.events[--$data._rf];if(d){b=d.time;do{if(!(d=$data.room.events[--$data._rf]))break}while(b-d.time<1e3);for(c=$data._rf-1,replayPrevInit(),b=$data.muteEff,$data.muteEff=!0,i=0;i<c;i++)replayTick();$(".deltaScore").remove(),$data.muteEff=b,replayTick()}}function replayPause(a){var b=$data._rpause=!$data._rpause;$(a.target).html(b?L.replayResume:L.replayPause)}function replayNext(a){clearTimeout($data._rt),replayTick()}function replayStatus(){$data.$gpt.html($data._gpp+" ("+(.001*$data._eventTime).toFixed(1)+L.SECOND+" / "+(.001*$data._gtt).toFixed(1)+L.SECOND+")")}function replayTick(a){var b,c=$data.room.events[$data._rf];return clearTimeout($data._rt),a||$data._rf++,c?$data._rpause?($data._rf--,$data._rt=addTimeout(replayTick,100)):(b=c.data,b.hint&&(b.hint={_id:b.hint}),"chat"==b.type&&(b.timestamp=$rec.time+c.time),onMessage(b),$data._eventTime=c.time,replayStatus(),void($data.room.events.length>$data._rf?$data._rt=addTimeout(replayTick,$data.room.events[$data._rf].time-c.time):replayStop())):void replayStop()}function replayStop(){delete $data.room,$data._replay=!1,$stage.box.room.height(360),clearTimeout($data._rt),updateUI(),playBGM("lobby")}function startRecord(a){var b,c;$rec={version:$data.version,me:$data.id,players:[],events:[],title:$data.room.title,roundTime:$data.room.time,round:$data.room.round,mode:$data.room.mode,limit:$data.room.limit,game:$data.room.game,opts:$data.room.opts,readies:$data.room.readies,time:(new Date).getTime()};for(b in $data.room.players){var d;c=$data.users[$data.room.players[b]]||$data.room.players[b],d={id:c.id,score:0},c.robot?(d.id=c.id,d.robot=!0,d.data={score:0},c={profile:getAIProfile(c.level)}):(d.data=c.data,d.equip=c.equip),d.title="#"+c.id,$rec.players.push(d)}$data._record=!0}function stopRecord(){$data._record=!1}function recordEvent(a){if(!$data._replay&&$rec){var b,c=a;if(a.hasOwnProperty("type")&&"room"!=a.type&&"obtain"!=a.type){a={};for(b in c)a[b]=c[b];a.profile&&(a.profile={id:a.profile.id,title:"#"+a.profile.id}),a.user&&(a.user={id:a.user.profile.id,profile:{id:a.user.profile.id,title:"#"+a.user.profile.id},data:{score:0},equip:{}}),$rec.events.push({data:a,time:(new Date).getTime()-$rec.time})}}}function clearBoard(){$data._relay=!1,loading(),$stage.game.here.hide(),$stage.dialog.result.hide(),$stage.dialog.dress.hide(),$stage.dialog.charFactory.hide(),$(".jjoriping,.rounds,.game-body").removeClass("cw"),$stage.game.display.empty(),$stage.game.chain.hide(),$stage.game.hints.empty().hide(),$stage.game.cwcmd.hide(),$stage.game.bb.hide(),$stage.game.round.empty(),$stage.game.history.empty(),$stage.game.items.show().css("opacity",0),$(".jjo-turn-time .graph-bar").width(0).css({float:"","text-align":"","background-color":""}),$(".jjo-round-time .graph-bar").width(0).css({float:"","text-align":""}).removeClass("round-extreme"),$(".game-user-bomb").removeClass("game-user-bomb")}function drawRound(a){var b;for($stage.game.round.empty(),b=0;b<$data.room.round;b++)$stage.game.round.append($l=$("<label>").html($data.room.game.title[b])),b+1==a&&$l.addClass("rounds-current")}function turnGoing(){route("turnGoing")}function turnHint(a){route("turnHint",a)}function turnError(a,b){$stage.game.display.empty().append($("<label>").addClass("game-fail-text").text((L["turnError_"+a]?L["turnError_"+a]+": ":"")+b)),playSound("fail"),clearTimeout($data._fail),$data._fail=addTimeout(function(){$stage.game.display.html($data._char)},1800)}function getScore(a){return $data._replay?$rec.users[a].game.score:($data.users[a]||$data.robots[a]).game.score}function addScore(a,b){$data._replay?$rec.users[a].game.score+=b:($data.users[a]||$data.robots[a]).game.score+=b}function drawObtainedScore(a,b){return a.append(b),addTimeout(function(){b.remove()},2e3),a}function turnEnd(a,b){route("turnEnd",a,b)}function roundEnd(a,b){function c(a){var b,e,f;$data._result.goal=EXP[$data._result.level-1],$data._result.before=EXP[$data._result.level-2]||0,$data._result.reward.score>0&&(b=$data._result.reward.score*$data._coef,b<.05&&$data._coef&&(b=$data._result.reward.score),$data._result.reward.score-=b,$data._result.exp+=b,e=getLevel($data._result.exp),$data._result.level!=e&&($data._result._boing-=$data._result.goal-$data._result._exp,$data._result._exp=$data._result.goal,playSound("lvup")),$data._result.level=e,addTimeout(c,50)),f=$data._result.exp-$data._result._exp,d("before",$data._result._exp,$data._result.before,$data._result.goal),d("current",Math.min(f,$data._result._boing),0,$data._result.goal-$data._result.before),d("bonus",Math.max(0,f-$data._result._boing),0,$data._result.goal-$data._result.before),$(".result-me-level-body").html($data._result.level),$(".result-me-score-text").html(commify(Math.round($data._result.exp))+" / "+commify($data._result.goal))}function d(a,b,c,d){$(".result-me-"+a+"-bar").width((b-c)/(d-c)*100+"%")}b||(b={});var e,f,g,h,i,j,k,l,m,n=$(".result-board").empty();$(".result-me-expl").empty(),$stage.game.display.html(L.roundEnd),$data._resultPage=1,$data._result=null;for(e in a)g=a[e],f=$data._replay?$rec.users[g.id]:$data.users[g.id],f||(f=NULL_USER),f.data&&g.reward&&(g.reward.score=$data._replay?0:Math.round(g.reward.score),j=getLevel(k=f.data.score)>getLevel(f.data.score-g.reward.score),n.append(h=$("<div>").addClass("result-board-item").append(i=$("<div>").addClass("result-board-rank").html(g.rank+1)).append(getLevelImage(k).addClass("result-board-level")).append($("<div>").addClass("result-board-name").html(getDisplayName(f))).append($("<div>").addClass("result-board-score").html(b.scores?L.avg+" "+commify(b.scores[g.id])+L.kpm:commify(g.score||0)+L.PTS)).append($("<div>").addClass("result-board-reward").html(g.reward.score?"+"+commify(g.reward.score):"-")).append($("<div>").addClass("result-board-lvup").css("display",j?"block":"none").append($("<i>").addClass("fa fa-arrow-up")).append($("<div>").html(L.lvUp)))),f.game.team&&i.addClass("team-"+f.game.team),g.id==$data.id&&(g.exp=f.data.score-g.reward.score,g.level=getLevel(g.exp),$data._result=g,h.addClass("result-board-me"),$(".result-me-expl").append(function(a,b,c){function d(a,b,c){a.append($("<h5>").addClass("result-me-blog-head").html(b)).append($("<h5>").addClass("result-me-blog-body").html(c))}var e,f,g=$("<div>").append($("<h4>").html(L.scoreGain)).append(e=$("<div>")).append($("<h4>").html(L.moneyGain)).append(f=$("<div>"));return d(e,L.scoreOrigin,a),d(f,L.moneyOrigin,b),c.forEach(function(c){var g,h,i,j=c.charAt(0),k=c.charAt(1),l=c.slice(2,5),m=Number(c.slice(5));"EXP"==l?(g=e,i=a):"MNY"==l&&(g=f,i=b),"g"==k?h="+"+(i*m).toFixed(1):"h"==k&&(h="+"+Math.floor(m)),d(g,L["bonusFrom_"+j],h)}),g}(g.reward._score,g.reward._money,g.reward._blog))));$(".result-me").css("opacity",0),$data._coef=0,$data._result&&(l=$data._result.reward.score-$data._result.reward._score,m=$data._result.reward.money-$data._result.reward._money,$data._result._exp=$data._result.exp,$data._result._score=$data._result.reward.score,$data._result._bonus=l,$data._result._boing=$data._result.reward._score,$data._result._addit=l,$data._result._addp=m,l=l>0?"<label class='result-me-bonus'>(+"+commify(l)+")</label>":"",m=m>0?"<label class='result-me-bonus'>(+"+commify(m)+")</label>":"",notice(L.scoreGain+": "+commify($data._result.reward.score)+", "+L.moneyGain+": "+commify($data._result.reward.money)),$(".result-me").css("opacity",1),$(".result-me-score").html(L.scoreGain+" +"+commify($data._result.reward.score)+l),$(".result-me-money").html(L.moneyGain+" +"+commify($data._result.reward.money)+m)),addTimeout(function(){showDialog($stage.dialog.result),$data._result&&c(!0),$stage.dialog.result.css("opacity",0).animate({opacity:1},500),addTimeout(function(){$data._coef=.05},500)},2e3),stopRecord()}function drawRanking(a){var b,c,d,e=$(".result-board").empty();if($data._resultPage=2,!a)return $stage.dialog.resultOK.trigger("click");for(i in a.list)r=a.list[i],o=$data.users[r.id]||{profile:{title:L.hidden}},d=r.id==$data.id,e.append(b=$("<div>").addClass("result-board-item").append($("<div>").addClass("result-board-rank").html(r.rank+1)).append(getLevelImage(r.score).addClass("result-board-level")).append($("<div>").addClass("result-board-name").html(getDisplayName(o))).append($("<div>").addClass("result-board-score").html(commify(r.score)+L.PTS)).append($("<div>").addClass("result-board-reward").html("")).append(c=$("<div>").addClass("result-board-lvup").css("display",d?"block":"none").append($("<i>").addClass("fa fa-arrow-up")).append($("<div>").html(a.prev-r.rank)))),d&&(a.prev-r.rank<=0&&c.hide(),b.addClass("result-board-me"))}function kickVoting(a){var b=$data.users[a].profile;$("#kick-vote-text").html((b.title||b.name)+L.kickVoteText),$data.kickTime=10,$data._kickTime=10,$data._kickTimer=addTimeout(kickVoteTick,1e3),showDialog($stage.dialog.kickVote)}function kickVoteTick(){$(".kick-vote-time .graph-bar").width($data.kickTime/$data._kickTime*300),--$data.kickTime>0?$data._kickTimer=addTimeout(kickVoteTick,1e3):$stage.dialog.kickVoteY.trigger("click")}function loadShop(){var a=$("#shop-shelf");a.html(L.LOADING),processShop(function(b){if(a.empty(),$data.guest&&(b.error=423),b.error)return $stage.menu.shop.trigger("click"),fail(b.error);b.goods.sort(function(a,b){return b.updatedAt-a.updatedAt}).forEach(function(b,c,d){if(!(b.cost<0)){var e=iImage(!1,b);a.append($("<div>").attr("id","goods_"+b._id).addClass("goods").append($("<div>").addClass("jt-image goods-image").css("background-image","url("+e+")")).append($("<div>").addClass("goods-title").html(iName(b._id))).append($("<div>").addClass("goods-cost").html(commify(b.cost)+L.ping)).append(explainGoods(b,!1)).on("click",onGoods))}}),global.expl(a)}),$(".shop-type.selected").removeClass("selected"),$("#shop-type-all").addClass("selected")}function filterShop(a){var b,c,d,e=!0===a;e||(a=a.split(","));for(d in $data.shop)c=$data.shop[d],c.cost<0||(b=$("#goods_"+d).show(),e||-1==a.indexOf(c.group)&&b.hide())}function explainGoods(a,b,c){var d,e,f=$("<div>").addClass("expl dress-expl").append($("<div>").addClass("dress-item-title").html(iName(a._id)+(b?L.equipped:""))).append($("<div>").addClass("dress-item-group").html(L["GROUP_"+a.group])).append($("<div>").addClass("dress-item-expl").html(iDesc(a._id))),g=$("<div>").addClass("dress-item-opts");a.term&&f.append($("<div>").addClass("dress-item-term").html(Math.floor(a.term/86400)+L.DATE+" "+L.ITEM_TERM)),c&&f.append($("<div>").addClass("dress-item-term").html(new Date(1e3*c).toLocaleString()+L.ITEM_TERMED));for(d in a.options)if("gif"!=d){var h=d.charAt(0);e=a.options[d],"g"==h?e="+"+(100*e).toFixed(1)+"%p":"h"==h&&(e="+"+e),g.append($("<label>").addClass("item-opts-head").html(L["OPTS_"+d])).append($("<label>").addClass("item-opts-body").html(e)).append($("<br>"))}return e&&f.append(g),f}function processShop(a){var b;$.get("/shop",function(c){$data.shop={};for(b in c.goods)$data.shop[c.goods[b]._id]=c.goods[b];a&&a(c)})}function onGoods(a){var b,c,d=$(a.currentTarget).attr("id").slice(6),e=$data.shop[d],f=$data.users[$data.id],g=f.money,h=g-e.cost,i=L.surePurchase,j={};$data.box&&$data.box[d]&&(i=L.alreadyGot+" "+i),showDialog($stage.dialog.purchase,!0),$("#purchase-ping-before").html(commify(g)+L.ping),$("#purchase-ping-cost").html(commify(e.cost)+L.ping),$("#purchase-item-name").html(L[d][0]),b=$("#purchase-ping-after").html(commify(h)+L.ping),$("#purchase-item-desc").html(h<0?L.notEnoughMoney:i);for(c in f.equip)j[c]=f.equip[c];j["Mhand"==e.group?["Mlhand","Mrhand"][Math.floor(2*Math.random())]:e.group]=d,renderMoremi("#moremi-after",j),$data._sgood=d,$stage.dialog.purchaseOK.attr("disabled",h<0),h<0?b.addClass("purchase-not-enough"):b.removeClass("purchase-not-enough")}function vibrate(a){a<1||($("#Middle").css("padding-top",a),addTimeout(function(){$("#Middle").css("padding-top",0),addTimeout(vibrate,50,.7*a)},50))}function pushDisplay(a,b,c,d){var e,f,g,h,i,j=MODE[$data.room.mode],k="KKT"==j,l="KAP"==j,m=BEAT[e=a.length],n=0,o=$data.turnTime/96,p=$data.turnTime/12;if($stage.game.display.empty(),m?(f="As"+$data._speed,m=m.split("")):"en"==RULE[j].lang&&e<10?f="As"+$data._speed:(f="Al",vibrate(e)),g="K"+$data._speed,m){for(h in m)"0"!=m[h]&&($stage.game.display.append(i=$("<div>").addClass("display-text").css({float:l?"right":"left","margin-top":-6,"font-size":36}).hide().html(l?a.charAt(e-n-1):a.charAt(n))),n++,addTimeout(function(a,b){var c={"margin-top":0};playSound(b),a.html()==$data.mission?(playSound("mission"),a.css({color:"#66FF66"}),c["font-size"]=24):c["font-size"]=20,a.show().animate(c,100)},Number(h)*o,i,f));h=$stage.game.display.children("div").get(0),$(h).css(l?"margin-right":"margin-left",.5*($stage.game.display.width()-20*e))}else if(n="",l)for(h=0;h<e;h++)addTimeout(function(a){playSound(f),a==$data.mission?(playSound("mission"),n="<label style='color: #66FF66;'>"+a+"</label>"+n):n=a+n,$stage.game.display.html(n)},Number(h)*p/e,a[e-h-1]);else for(h=0;h<e;h++)addTimeout(function(a){playSound(f),a==$data.mission?(playSound("mission"),n+="<label style='color: #66FF66;'>"+a+"</label>"):n+=a,$stage.game.display.html(n)},Number(h)*p/e,a[h]);addTimeout(function(){for(h=0;h<3;h++)addTimeout(function(a){if(k){if(1==a)return;playSound("kung")}(m?$stage.game.display.children(".display-text"):$stage.game.display).css("font-size",21).animate({"font-size":20},o)},h*o*2,h);addTimeout(pushHistory,4*o,a,b,c,d),k||playSound(g)},p)}function pushHint(a){var b,c=processWord("",a);$stage.game.hints.append(b=$("<div>").addClass("hint-item").append($("<label>").html(c)).append($("<div>").addClass("expl").css({"white-space":"normal",width:200}).html(c.html()))),mobile||b.width(0).animate({width:215}),global.expl(b)}function pushHistory(a,b,c,d){var e,f,g,h=d?d.split(","):[],i={};$stage.game.history.prepend(e=$("<div>").addClass("ellipse history-item").width(0).animate({width:200}).html(a)),f=$stage.game.history.children(),f.length>6&&f.last().remove(),g=processWord(a,b,c,h),h.forEach(function(a){i[a]||L["class_"+a]&&(i[a]=!0,e.append($("<label>").addClass("history-class").html(L["class_"+a])))}),e.append(f=$("<div>").addClass("history-mean ellipse").append(g)).append($("<div>").addClass("expl").css({width:200,"white-space":"normal"}).html("<h5 style='color: #BBBBBB;'>"+g.html()+"</h5>")),global.expl(e)}function processNormal(a,b){return $("<label>").addClass("word").html(b)}function processWord(a,b,c,d){function e(a){return a.replace(/\$\$[^\$]+\$\$/g,function(a){return"<equ>"+a.slice(2,a.length-2).replace(/\^\{([^\}]+)\}/g,"<sup>$1</sup>").replace(/_\{([^\}]+)\}/g,"<sub>$1</sub>").replace(/\\geq/g,"≥")+"</equ>"}).replace(/\*\*([^\*]+)\*\*/g,"<sup>$1</sup>").replace(/\*([^\*]+)\*/g,"<sub>$1</sub>")}if(!b||-1==b.indexOf("＂"))return processNormal(a,b);var f=$("<label>").addClass("word"),g=b.split(/＂[0-9]+＂/).slice(1).map(function(a){return-1==a.indexOf("［")?[[a]]:a.split(/［[0-9]+］/).slice(1).map(function(a){return a.split(/（[0-9]+）/).slice(1)})}),h=(d&&d.map(function(a){return L["class_"+a]}),c?c.split(",").map(function(a){return L["theme_"+a]}):[]),i=g.length>1;return g.forEach(function(a,b){var c=$("<label>").addClass("word-m1"),d=a.length>1;i&&c.append($("<label>").addClass("word-head word-m1-head").html(b+1)),a.forEach(function(a,b){var f=$("<label>").addClass("word-m2"),g=a.length,i=g>1,j=h.splice(0,g);d&&f.append($("<label>").addClass("word-head word-m2-head").html(b+1)),a.forEach(function(a,b){var c=$("<label>").addClass("word-m3"),d=j.shift();i&&c.append($("<label>").addClass("word-head word-m3-head").html(b+1)),d&&c.append($("<label>").addClass("word-theme").html(d)),c.append($("<label>").addClass("word-m3-body").html(e(a))),f.append(c)}),c.append(f)}),f.append(c)}),f}function getCharText(a,b,c){var d=a+(b?"("+b+")":"");return c&&(d+="<label class='jjo-display-word-length'>("+c+")</label>"),d}function getRequiredScore(a){return Math.round((.3*!(a%5)+1)*(.4*!(a%15)+1)*(.5*!(a%45)+1)*(120+60*Math.floor(a/5)+120*Math.floor(a*a/225)+180*Math.floor(a*a/2025)))}function getLevel(a){var b,c=EXP.length;for(b=0;b<c&&!(a<EXP[b]);b++);return b+1}function getLevelImage(a){var b=getLevel(a)-1,c=b%25*-100,d=-100*Math.floor(.04*b);return $("<div>").css({float:"left","background-image":"url('/img/kkutu/lv/newlv.png')","background-position":c+"% "+d+"%","background-size":"2560%"})}function getImage(a){return $("<div>").addClass("jt-image").css("background-image","url('"+a+"')")}function getOptions(a,b,c){var d,e,f=[L["mode"+MODE[a]]];for(d in OPTIONS)e=OPTIONS[d].name.toLowerCase(),b[e]&&f.push(L["opt"+OPTIONS[d].name]);return c&&f.push(b.injpick.join("|")),c?f.toString():f}function setRoomHead(a,b){var c,d=getOptions(b.mode,b.opts),e=RULE[MODE[b.mode]];a.empty().append($("<h5>").addClass("room-head-number").html("["+(b.practice?L.practice:b.id)+"]")).append($("<h5>").addClass("room-head-title").text(badWords(b.title))).append(c=$("<h5>").addClass("room-head-mode").html(d.join(" / "))).append($("<h5>").addClass("room-head-limit").html((mobile?"":L.players+" ")+b.players.length+" / "+b.limit)).append($("<h5>").addClass("room-head-round").html(L.rounds+" "+b.round)).append($("<h5>").addClass("room-head-time").html(b.time+L.SECOND)),-1!=e.opts.indexOf("ijp")&&(c.append($("<div>").addClass("expl").html("<h5>"+b.opts.injpick.map(function(a){return L["theme_"+a]})+"</h5>")),global.expl(a))}function loadSounds(a,b){$data._lsRemain=a.length,a.forEach(function(a){getAudio(a.key,a.value,b)})}function getAudio(a,b,c){function d(c){$sound[a]=new f(b),e()}function e(){0==--$data._lsRemain?c&&c():loading(L.loadRemain+$data._lsRemain)}function f(a){var b=this;this.audio=new Audio(a),this.audio.load(),this.start=function(){b.audio.play()},this.stop=function(){b.audio.currentTime=0,b.audio.pause()}}var g=new XMLHttpRequest;g.open("GET",b),g.responseType="arraybuffer",g.onload=function(b){audioContext?audioContext.decodeAudioData(b.target.response,function(b){$sound[a]=b,e()},d):d()},g.send()}function playBGM(a,b){return $data.bgm&&$data.bgm.stop(),$data.bgm=playSound(a,!0)}function stopBGM(){$data.bgm&&($data.bgm.stop(),delete $data.bgm)}function playSound(a,b){var c,d,e=b&&$data.muteBGM||!b&&$data.muteEff;return d=$sound[a]||$sound.missing,window.hasOwnProperty("AudioBuffer")&&d instanceof AudioBuffer?(c=audioContext.createBufferSource(),c.startedAt=audioContext.currentTime,c.loop=b,c.buffer=e?audioContext.createBuffer(2,d.length,audioContext.sampleRate):d,c.connect(audioContext.destination)):(d.readyState&&(d.audio.currentTime=0),d.audio.loop=b||!1,d.audio.volume=e?0:1,c=d),$_sound[a]&&$_sound[a].stop(),$_sound[a]=c,c.key=a,c.start(),c}function stopAllSounds(){var a;for(a in $_sound)$_sound[a].stop()}function tryJoin(a){var b;$data.rooms[a]&&($data.rooms[a].password&&!(b=prompt(L.putPassword))||($data._pw=b,send("enter",{id:a,password:b})))}function clearChat(){$("#Chat").empty()}function forkChat(){var a=$("#Chat,#chat-log-board"),b=a.children(".chat-item").last().get(0);b&&"HR"==b.tagName||(a.append($("<hr>").addClass("chat-item")),$stage.chat.scrollTop(999999999))}function badWords(a){return a.replace(BAD,"♥♥")}function chatBalloon(a,b,c){$("#cb-"+b).remove();var d,e,f=(2&c?$("#game-user-"+b):$("#room-user-"+b)).offset(),g=2==c?"chat-balloon-bot":"chat-balloon-tip",h=$("<div>").addClass("chat-balloon").attr("id","cb-"+b).append($("<div>").addClass("jt-image "+g))[2==c?"prepend":"append"]($("<h4>").text(a));f&&($stage.balloons.append(h),1==c?(d=0,e=220):2==c?(d=35-h.height(),e=-2):3==c?(d=5,e=210):(d=40,e=110),h.css({top:f.top+d,left:f.left+e}),addTimeout(function(){h.animate({opacity:0},500,function(){h.remove()})},2500))}function chat(a,b,c,d){var e,f,g,h,i=d?new Date(d):new Date,j=$data.users[a.id]?$data.users[a.id].equip:{};if(!$data._shut[a.title||a.name]){if(c){if($data.opts.dw)return;if($data._wblock[c])return}b=badWords(b),playSound("k"),stackChat(),!mobile&&$data.room&&(e=($data.room.gaming?2:0)+($(".jjoriping").hasClass("cw")?1:0),chatBalloon(b,a.id,e)),$stage.chat.append(g=$("<div>").addClass("chat-item").append(e=$("<div>").addClass("chat-head ellipse").text(a.title||a.name)).append(f=$("<div>").addClass("chat-body").text(b)).append($("<div>").addClass("chat-stamp").text(i.toLocaleTimeString()))),d&&e.prepend($("<i>").addClass("fa fa-video-camera")),e.on("click",function(b){requestProfile(a.id)}),$stage.chatLog.append(g=g.clone()),g.append($("<div>").addClass("expl").css("font-weight","normal").html("#"+(a.id||"").substr(0,5))),(h=b.match(/https?:\/\/[\w\.\?\/&#%=-_\+]+/g))&&(b=f.html(),h.forEach(function(a){b=b.replace(a,"<a href='#' style='color: #2222FF;' onclick='if(confirm(\""+L.linkWarning+'")) window.open("'+a+"\");'>"+a+"</a>")}),f.html(b)),c&&(!0!==c&&($data._recentFrom=c),f.html("<label style='color: #7777FF; font-weight: bold;'>&lt;"+L.whisper+"&gt;</label>"+f.html())),addonNickname(e,{equip:j}),$stage.chat.scrollTop(999999999)}}function notice(a,b){var c=new Date;playSound("k"),stackChat(),$("#Chat,#chat-log-board").append($("<div>").addClass("chat-item chat-notice").append($("<div>").addClass("chat-head").text(b||L.notice)).append($("<div>").addClass("chat-body").html(a)).append($("<div>").addClass("chat-stamp").text(c.toLocaleTimeString()))),$stage.chat.scrollTop(999999999),"tail"==b&&console.warn(c.toLocaleString(),a)}function stackChat(){var a=$("#Chat .chat-item"),b=$("#chat-log-board .chat-item");a.length>99&&a.first().remove(),b.length>199&&b.first().remove()}function iGoods(a){var b;return b="$"==a.charAt()?$data.shop[a.slice(0,4)]:$data.shop[a],{_id:a,group:b.group,term:b.term,name:iName(a),cost:b.cost,image:iImage(a,b),desc:iDesc(a),options:b.options}}function iName(a){return"$"==a.charAt()?L[a.slice(0,4)][0]+" - "+a.slice(4):L[a][0]}function iDesc(a){return"$"==a.charAt()?L[a.slice(0,4)][1]:L[a][1]}function iImage(a,b){var c,d;if(a){if("$"==a.charAt())return iDynImage(a.slice(1,4),a.slice(4))}else"string"==typeof b&&(b={_id:"def",group:b,options:{}});return c=$data.shop[a]||b,d=c.options.hasOwnProperty("gif")?".gif":".png","BDG"==c.group.slice(0,3)?"/img/kkutu/moremi/badge/"+c._id+d:"M"==c.group.charAt(0)?"/img/kkutu/moremi/"+c.group.slice(1)+"/"+c._id+d:"/img/kkutu/shop/"+c._id+".png"}function iDynImage(a,b){var c,d=document.createElement("canvas"),e=d.getContext("2d");switch(d.width=d.height=50,e.font="24px NBGothic",e.textAlign="center",e.textBaseline="middle",a){case"WPC":case"WPB":case"WPA":c=["WPC","WPB","WPA"].indexOf(a),e.beginPath(),e.arc(25,25,25,0,2*Math.PI),e.fillStyle=["#DDDDDD","#A6C5FF","#FFEF31"][c],e.fill(),e.fillStyle=["#000000","#4465C3","#E69D12"][c],e.fillText(b,25,25)}return d.toDataURL()}function queueObtain(a){$stage.dialog.obtain.is(":visible")?$data._obtain.push(a):(drawObtain(a),showDialog($stage.dialog.obtain,!0))}function drawObtain(a){playSound("success"),$("#obtain-image").css("background-image","url("+iImage(a.key)+")"),$("#obtain-name").html(iName(a.key))}function getDisplayName(a){return a.nickname||a.profile.title||a.profile.name}function renderMoremi(a,b){var c,d,e=$(a).empty(),f={Mlhand:"Mhand",Mrhand:"Mhand"};b||(b={});for(c in MOREMI_PART)d="M"+MOREMI_PART[c],e.append($("<img>").addClass("moremies moremi-"+d.slice(1)).attr("src",iImage(b[d],f[d]||d)).css({width:"100%",height:"100%"}));(d=b.BDG)&&e.append($("<img>").addClass("moremies moremi-badge").attr("src",iImage(d)).css({width:"100%",height:"100%"})),e.children(".moremi-back").after($("<img>").addClass("moremies moremi-body").attr("src",b.robot?"/img/kkutu/moremi/robot.png":"/img/kkutu/moremi/body.png").css({width:"100%",height:"100%"})),e.children(".moremi-rhand").css("transform","scaleX(-1)")}function commify(a){var b=/(^[+-]?\d+)(\d{3})/;if(null===a)return"?";for(a=a.toString();b.test(a);)a=a.replace(b,"$1,$2");return a}function setLocation(a){location.hash=a?"#"+a:""}function fail(a){return alert(L["error_"+a])}function yell(a){$stage.yell.show().css("opacity",1).html(a),addTimeout(function(){$stage.yell.animate({opacity:0},3e3),addTimeout(function(){$stage.yell.hide()},3e3)},1e3)}var MODE,BEAT=[null,"10000000","10001000","10010010","10011010","11011010","11011110","11011111","11111111"],NULL_USER={profile:{title:L.null},data:{score:0}},MOREMI_PART,AVAIL_EQUIP,RULE,OPTIONS,MAX_LEVEL=360,TICK=30,EXP=[],BAD=new RegExp(["느으*[^가-힣]*금마?","니[^가-힣]*(엄|앰|엠)","(ㅄ|ㅅㅂ|ㅂㅅ)","미친(년|놈)?","(병|븅|빙)[^가-힣]*신","보[^가-힣]*지","(새|섀|쌔|썌)[^가-힣]*(기|끼)","섹[^가-힣]*스","(시|씨|쉬|쒸)이*입?[^가-힣]*(발|빨|벌|뻘|팔|펄)","십[^가-힣]*새","씹","(애|에)[^가-힣]*미","자[^가-힣]*지","존[^가-힣]*나","좆|죶","지랄","창[^가-힣]*(녀|년|놈)","fuck","sex"].join("|"),"g"),ws,rws,$stage,$sound={},$_sound={},$data={},$lib={Classic:{},Jaqwi:{},Crossword:{},Typing:{},Hunmin:{},Daneo:{},Sock:{}},$rec,mobile,audioContext=!!window.hasOwnProperty("AudioContext")&&new AudioContext,_WebSocket=window.WebSocket,_setInterval=setInterval,_setTimeout=setTimeout;$(document).ready(function(){function a(a,b,c){var d=a.position();$(window).on("mousemove",function(e){var f=e.pageX-b,g=e.pageY-c;a.css("left",d.left+f),a.css("top",d.top+g)})}function b(a){$(window).off("mousemove")}function c(a,b){var c,d;for(c in OPTIONS)d=OPTIONS[c].name.toLowerCase(),-1==a.indexOf(c)?$("#"+b+"-"+d+"-panel").hide():$("#"+b+"-"+d+"-panel").show()}function d(a){var b,c,d={};for(b in OPTIONS)c=OPTIONS[b].name.toLowerCase(),$("#"+a+"-"+c).is(":checked")&&(d[c]=!0);return d}function e(a,b,c,d){var e;if(!d){if(a.gaming)return!1;if(a.password)return!1;if(a.players.length>=a.limit)return!1}if(a.mode!=b)return!1;for(e in c)if(!a.opts[e])return!1;return!0}function f(a){$(".team-selector").hasClass("team-unable")||send("team",{value:$(a.currentTarget).attr("id").slice(5)})}function g(){$stage.dialog.replayView.attr("disabled",!0)}function h(){ws=new _WebSocket($data.URL),ws.onopen=function(a){loading()},ws.onmessage=_onMessage=function(a){onMessage(JSON.parse(a.data))},ws.onclose=function(a){var b=L.closed+" (#"+a.code+")";rws&&rws.close(),stopAllSounds(),alert(b),$.get("/kkutu_notice.html",function(a){loading(a)})},ws.onerror=function(a){console.warn(L.error,a)}}var i;for($data.PUBLIC="true"==$("#PUBLIC").html(),$data.URL=$("#URL").html(),$data.NICKNAME_LIMIT=JSON.parse($("#NICKNAME_LIMIT").text()),$data.NICKNAME_LIMIT.REGEX.unshift(null),
$data.NICKNAME_LIMIT.REGEX=new(Function.prototype.bind.apply(RegExp,$data.NICKNAME_LIMIT.REGEX)),$data.version=$("#version").html(),$data.server=location.href.match(/\?.*server=(\d+)/)[1],$data.shop={},$data._okg=0,$data._playTime=0,$data._kd="",$data._timers=[],$data._obtain=[],$data._wblock={},$data._shut={},$data.usersR={},EXP.push(getRequiredScore(1)),i=2;i<MAX_LEVEL;i++)EXP.push(EXP[i-2]+getRequiredScore(i));if(EXP[MAX_LEVEL-1]=1/0,EXP.push(1/0),$stage={loading:$("#Loading"),lobby:{userListTitle:$(".UserListBox .product-title"),userList:$(".UserListBox .product-body"),roomListTitle:$(".RoomListBox .product-title"),roomList:$(".RoomListBox .product-body"),createBanner:$("<div>").addClass("rooms-item rooms-create").append($("<div>").html(L.newRoom))},chat:$("#Chat"),chatLog:$("#chat-log-board"),talk:$("#Talk"),chatBtn:$("#ChatBtn"),menu:{help:$("#HelpBtn"),setting:$("#SettingBtn"),community:$("#CommunityBtn"),newRoom:$("#NewRoomBtn"),setRoom:$("#SetRoomBtn"),quickRoom:$("#QuickRoomBtn"),spectate:$("#SpectateBtn"),shop:$("#ShopBtn"),dict:$("#DictionaryBtn"),wordPlus:$("#WordPlusBtn"),invite:$("#InviteBtn"),practice:$("#PracticeBtn"),ready:$("#ReadyBtn"),start:$("#StartBtn"),exit:$("#ExitBtn"),notice:$("#NoticeBtn"),replay:$("#ReplayBtn"),leaderboard:$("#LeaderboardBtn")},dialog:{setting:$("#SettingDiag"),settingServer:$("#setting-server"),settingOK:$("#setting-ok"),community:$("#CommunityDiag"),commFriends:$("#comm-friends"),commFriendAdd:$("#comm-friend-add"),room:$("#RoomDiag"),roomOK:$("#room-ok"),quick:$("#QuickDiag"),quickOK:$("#quick-ok"),result:$("#ResultDiag"),resultOK:$("#result-ok"),resultSave:$("#result-save"),practice:$("#PracticeDiag"),practiceOK:$("#practice-ok"),dict:$("#DictionaryDiag"),dictInjeong:$("#dict-injeong"),dictSearch:$("#dict-search"),wordPlus:$("#WordPlusDiag"),wordPlusOK:$("#wp-ok"),invite:$("#InviteDiag"),inviteList:$(".invite-board"),inviteRobot:$("#invite-robot"),roomInfo:$("#RoomInfoDiag"),roomInfoJoin:$("#room-info-join"),profile:$("#ProfileDiag"),profileShut:$("#profile-shut"),profileHandover:$("#profile-handover"),profileKick:$("#profile-kick"),profileLevel:$("#profile-level"),profileDress:$("#profile-dress"),profileWhisper:$("#profile-whisper"),kickVote:$("#KickVoteDiag"),kickVoteY:$("#kick-vote-yes"),kickVoteN:$("#kick-vote-no"),purchase:$("#PurchaseDiag"),purchaseOK:$("#purchase-ok"),purchaseNO:$("#purchase-no"),replay:$("#ReplayDiag"),replayView:$("#replay-view"),leaderboard:$("#LeaderboardDiag"),lbTable:$("#ranking tbody"),lbPage:$("#lb-page"),lbNext:$("#lb-next"),lbMe:$("#lb-me"),lbPrev:$("#lb-prev"),dress:$("#DressDiag"),dressOK:$("#dress-ok"),charFactory:$("#CharFactoryDiag"),cfCompose:$("#cf-compose"),injPick:$("#InjPickDiag"),injPickAll:$("#injpick-all"),injPickNo:$("#injpick-no"),injPickOK:$("#injpick-ok"),chatLog:$("#ChatLogDiag"),obtain:$("#ObtainDiag"),obtainOK:$("#obtain-ok"),help:$("#HelpDiag")},box:{chat:$(".ChatBox"),userList:$(".UserListBox"),roomList:$(".RoomListBox"),shop:$(".ShopBox"),room:$(".RoomBox"),game:$(".GameBox"),me:$(".MeBox")},game:{display:$(".jjo-display"),hints:$(".GameBox .hints"),cwcmd:$(".GameBox .cwcmd"),bb:$(".GameBox .bb"),items:$(".GameBox .items"),chain:$(".GameBox .chain"),round:$(".rounds"),here:$(".game-input").hide(),hereText:$("#game-input"),history:$(".history"),roundBar:$(".jjo-round-time .graph-bar"),turnBar:$(".jjo-turn-time .graph-bar")},yell:$("#Yell").hide(),balloons:$("#Balloons")},void 0==_WebSocket)return loading(L.websocketUnsupport),void alert(L.websocketUnsupport);for($data._soundList=[{key:"k",value:"/media/kkutu/k.mp3"},{key:"lobby",value:"/media/kkutu/LobbyBGM.mp3"},{key:"jaqwi",value:"/media/kkutu/JaqwiBGM.mp3"},{key:"jaqwiF",value:"/media/kkutu/JaqwiFastBGM.mp3"},{key:"game_start",value:"/media/kkutu/game_start.mp3"},{key:"round_start",value:"/media/kkutu/round_start.mp3"},{key:"fail",value:"/media/kkutu/fail.mp3"},{key:"timeout",value:"/media/kkutu/timeout.mp3"},{key:"lvup",value:"/media/kkutu/lvup.mp3"},{key:"Al",value:"/media/kkutu/Al.mp3"},{key:"success",value:"/media/kkutu/success.mp3"},{key:"missing",value:"/media/kkutu/missing.mp3"},{key:"mission",value:"/media/kkutu/mission.mp3"},{key:"kung",value:"/media/kkutu/kung.mp3"},{key:"horr",value:"/media/kkutu/horr.mp3"}],i=0;i<=10;i++)$data._soundList.push({key:"T"+i,value:"/media/kkutu/T"+i+".mp3"},{key:"K"+i,value:"/media/kkutu/K"+i+".mp3"},{key:"As"+i,value:"/media/kkutu/As"+i+".mp3"});loadSounds($data._soundList,function(){processShop(h)}),delete $data._soundList,MOREMI_PART=$("#MOREMI_PART").html().split(","),AVAIL_EQUIP=$("#AVAIL_EQUIP").html().split(","),RULE=JSON.parse($("#RULE").html()),OPTIONS=JSON.parse($("#OPTIONS").html()),MODE=Object.keys(RULE),mobile="true"==$("#mobile").html(),mobile&&(TICK=200),$data._timePercent=function(){return 100-($data._turnSound.audio?$data._turnSound.audio.currentTime:audioContext.currentTime-$data._turnSound.startedAt)/$data.turnTime*1e5+"%"},$data.setRoom=function(a,b){var c="for-lobby"==getOnly();null==b?(delete $data.rooms[a],c&&$("#room-"+a).remove()):(c&&!$data.rooms[a]&&$stage.lobby.roomList.append($("<div>").attr("id","room-"+a)),$data.rooms[a]=b,c&&$("#room-"+a).replaceWith(roomListBar(b)))},$data.setUser=function(a,b){var c,d=getOnly(),e="for-lobby"==d||"for-master"==d;if($data._replay)return void($rec.users[a]=b);null==b?(delete $data.users[a],e&&$("#users-item-"+a+",#invite-item-"+a).remove()):(e&&!$data.users[a]&&(c=userListBar(b,"for-master"==d),"for-master"==d?$stage.dialog.inviteList.append(c):$stage.lobby.userList.append(c)),$data.users[a]=b,e&&(c?$("#"+c.attr("id")).replaceWith(c):$("#"+("for-lobby"==d?"users-item-":"invite-item")+a).replaceWith(userListBar(b,"for-master"==d))))},$(document).on("paste",function(a){if($data.room&&$data.room.gaming)return a.preventDefault(),!1}),$stage.talk.on("drop",function(a){if($data.room&&$data.room.gaming)return a.preventDefault(),!1}),$data.opts=$.cookie("kks"),$data.opts&&applyOptions(JSON.parse($data.opts)),$(".dialog-head .dialog-title").on("mousedown",function(b){var c=$(b.currentTarget).parents(".dialog");$(".dialog-front").removeClass("dialog-front"),c.addClass("dialog-front"),a(c,b.pageX,b.pageY)}).on("mouseup",function(a){b()}),$stage.chatBtn.on("click",function(a){checkInput();var b=mobile&&$stage.game.here.is(":visible")?$stage.game.hereText.val():$stage.talk.val();if(b){var c={value:b.trim()};"/"==c.value[0]?(c.cmd=c.value.split(" "),runCommand(c.cmd)):(($stage.game.here.is(":visible")||$data._relay)&&(c.relay=!0),send("talk",c)),$data._whisper?($stage.talk.val("/e "+$data._whisper+" "),delete $data._whisper):$stage.talk.val(""),$stage.game.hereText.val("")}}).hotkey($stage.talk,13).hotkey($stage.game.hereText,13),$("#cw-q-input").on("keydown",function(a){if(13==a.keyCode){var b=$(a.currentTarget),c=b.val(),d={relay:!0,data:$data._sel,value:c};if(!c)return;send("talk",d),b.val("")}}).on("focusout",function(a){$(".cw-q-body").empty(),$stage.game.cwcmd.css("opacity",0)}),$("#room-limit").on("change",function(a){var b=$(a.currentTarget),c=b.val();c<2||c>8?b.css("color","#FF4444"):b.css("color","")}),$("#room-round").on("change",function(a){var b=$(a.currentTarget),c=b.val();c<1||c>10?b.css("color","#FF4444"):b.css("color","")}),$stage.game.here.on("click",function(a){mobile||$stage.talk.focus()}),$stage.talk.on("keyup",function(a){$stage.game.hereText.val($stage.talk.val())}),$(window).on("beforeunload",function(a){if($data.room)return L.sureExit}),$(".result-me-gauge .graph-bar").addClass("result-me-before-bar"),$(".result-me-gauge").append($("<div>").addClass("graph-bar result-me-current-bar")).append($("<div>").addClass("graph-bar result-me-bonus-bar"));for(i in $stage.dialog)$stage.dialog[i].children(".dialog-head").hasClass("no-close")||$stage.dialog[i].children(".dialog-head").append($("<div>").addClass("closeBtn").on("click",function(a){$(a.currentTarget).parent().parent().hide()}).hotkey(!1,27));for($stage.menu.help.on("click",function(a){$("#help-board").attr("src","/help"),showDialog($stage.dialog.help)}),$stage.menu.setting.on("click",function(a){showDialog($stage.dialog.setting)}),$stage.menu.community.on("click",function(a){if($data.guest)return fail(451);showDialog($stage.dialog.community)}),$stage.dialog.commFriendAdd.on("click",function(a){var b=prompt(L.friendAddNotice);if(b)return $data.users[b]?void send("friendAdd",{target:b},!0):fail(450)}),$stage.menu.newRoom.on("click",function(a){var b;$stage.dialog.quick.hide(),$data.typeRoom="enter",showDialog(b=$stage.dialog.room),b.find(".dialog-title").html(L.newRoom)}),$stage.menu.setRoom.on("click",function(a){var b,c,d,e=RULE[MODE[$data.room.mode]];$data.typeRoom="setRoom",$("#room-title").val($data.room.title),$("#room-limit").val($data.room.limit),$("#room-mode").val($data.room.mode).trigger("change"),$("#room-round").val($data.room.round),$("#room-time").val($data.room.time/e.time);for(c in OPTIONS)d=OPTIONS[c].name.toLowerCase(),$("#room-"+d).attr("checked",$data.room.opts[d]);$data._injpick=$data.room.opts.injpick,showDialog(b=$stage.dialog.room),b.find(".dialog-title").html(L.setRoom)}),$("#quick-mode, #QuickDiag .game-option").on("change",function(a){var b,f,g=$("#quick-mode").val(),h=0;"quick-mode"==a.currentTarget.id&&$("#QuickDiag .game-option").prop("checked",!1),f=d("quick"),c(RULE[MODE[g]].opts,"quick");for(b in $data.rooms)e($data.rooms[b],g,f,!0)&&h++;$("#quick-status").html(L.quickStatus+" "+h)}),$stage.menu.quickRoom.on("click",function(a){$stage.dialog.room.hide(),showDialog($stage.dialog.quick),$stage.dialog.quick.is(":visible")&&($("#QuickDiag>.dialog-body").find("*").prop("disabled",!1),$("#quick-mode").trigger("change"),$("#quick-queue").html(""),$stage.dialog.quickOK.removeClass("searching").html(L.OK))}),$stage.dialog.quickOK.on("click",function(a){function b(){var a,b=[];if(!$stage.dialog.quick.is(":visible"))return void clearTimeout($data._quickT);$("#quick-queue").html(L.quickQueue+" "+prettyTime(1e3*$data._quickn++));for(a in $data.rooms)e($data.rooms[a],c,f)&&b.push(a);b.length&&(a=b[Math.floor(Math.random()*b.length)],$data._preQuick=!0,$("#room-"+a).trigger("click"))}var c=$("#quick-mode").val(),f=d("quick");if("for-lobby"==getOnly()){if($stage.dialog.quickOK.hasClass("searching"))return $stage.dialog.quick.hide(),b(),void $stage.menu.quickRoom.trigger("click");$("#QuickDiag>.dialog-body").find("*").prop("disabled",!0),$stage.dialog.quickOK.addClass("searching").html("<i class='fa fa-spinner fa-spin'></i> "+L.NO).prop("disabled",!1),$data._quickn=0,$data._quickT=addInterval(b,1e3)}}),$("#room-mode").on("change",function(a){var b=$("#room-mode").val(),d=RULE[MODE[b]];$("#game-mode-expl").html(L["modex"+b]),c(d.opts,"room"),$data._injpick=[],-1!=d.opts.indexOf("ijp")?$("#room-injpick-panel").show():$("#room-injpick-panel").hide(),"Typing"==d.rule&&$("#room-round").val(3),$("#room-time").children("option").each(function(a,b){$(b).html(Number($(b).val())*d.time+L.SECOND)})}).trigger("change"),$stage.menu.spectate.on("click",function(a){$stage.menu.spectate.hasClass("toggled")?(send("form",{mode:"J"}),$stage.menu.spectate.removeClass("toggled")):(send("form",{mode:"S"}),$stage.menu.spectate.addClass("toggled"))}),$stage.menu.shop.on("click",function(a){($data._shop=!$data._shop)?(loadShop(),$stage.menu.shop.addClass("toggled")):$stage.menu.shop.removeClass("toggled"),updateUI()}),$(".shop-type").on("click",function(a){var b=$(a.currentTarget),c=b.attr("id").slice(10);$(".shop-type.selected").removeClass("selected"),b.addClass("selected"),filterShop("all"==c||b.attr("value"))}),$stage.menu.dict.on("click",function(a){showDialog($stage.dialog.dict)}),$stage.menu.wordPlus.on("click",function(a){showDialog($stage.dialog.wordPlus)}),$stage.menu.invite.on("click",function(a){showDialog($stage.dialog.invite),updateUserList(!0)}),$stage.menu.practice.on("click",function(a){RULE[MODE[$data.room.mode]].ai?($("#PracticeDiag .dialog-title").html(L.practice),$("#ai-team").val(0).prop("disabled",!0),showDialog($stage.dialog.practice)):send("practice",{level:-1})}),$stage.menu.ready.on("click",function(a){send("ready")}),$stage.menu.start.on("click",function(a){send("start")}),$stage.menu.exit.on("click",function(a){if($data.room.gaming){if(!confirm(L.sureExit))return;clearGame()}send("leave")}),$stage.menu.replay.on("click",function(a){$data._replay&&replayStop(),showDialog($stage.dialog.replay),g(),$stage.dialog.replay.is(":visible")&&$("#replay-file").trigger("change")}),$stage.menu.leaderboard.on("click",function(a){$data._lbpage=0,$stage.dialog.leaderboard.is(":visible")?$stage.dialog.leaderboard.hide():$.get("/ranking",function(a){drawLeaderboard(a),showDialog($stage.dialog.leaderboard)})}),$stage.dialog.lbPrev.on("click",function(a){$(a.currentTarget).attr("disabled",!0),$.get("/ranking?p="+($data._lbpage-1),function(a){drawLeaderboard(a)})}),$stage.dialog.lbMe.on("click",function(a){$(a.currentTarget).attr("disabled",!0),$.get("/ranking?id="+$data.id,function(a){drawLeaderboard(a)})}),$stage.dialog.lbNext.on("click",function(a){$(a.currentTarget).attr("disabled",!0),$.get("/ranking?p="+($data._lbpage+1),function(a){drawLeaderboard(a)})}),$stage.dialog.settingServer.on("click",function(a){location.href="/"}),$stage.dialog.settingOK.on("click",function(a){applyOptions({mb:$("#mute-bgm").is(":checked"),me:$("#mute-effect").is(":checked"),di:$("#deny-invite").is(":checked"),dw:$("#deny-whisper").is(":checked"),df:$("#deny-friend").is(":checked"),ar:$("#auto-ready").is(":checked"),su:$("#sort-user").is(":checked"),ow:$("#only-waiting").is(":checked"),ou:$("#only-unlock").is(":checked")}),$.cookie("kks",JSON.stringify($data.opts)),$stage.dialog.setting.hide()}),$stage.dialog.profileLevel.on("click",function(a){$("#PracticeDiag .dialog-title").html(L.robot),$("#ai-team").prop("disabled",!1),showDialog($stage.dialog.practice)}),$stage.dialog.practiceOK.on("click",function(a){var b=$("#practice-level").val(),c=$("#ai-team").val();$stage.dialog.practice.hide(),$("#PracticeDiag .dialog-title").html()==L.robot?send("setAI",{target:$data._profiled,level:b,team:c}):send("practice",{level:b})}),$stage.dialog.roomOK.on("click",function(a){var b,c,d={injpick:$data._injpick};for(b in OPTIONS)c=OPTIONS[b].name.toLowerCase(),d[c]=$("#room-"+c).is(":checked");send($data.typeRoom,{title:$("#room-title").val().trim()||$("#room-title").attr("placeholder").trim(),password:$("#room-pw").val(),limit:$("#room-limit").val(),mode:$("#room-mode").val(),round:$("#room-round").val(),time:$("#room-time").val(),opts:d}),$stage.dialog.room.hide()}),$stage.dialog.resultOK.on("click",function(a){if(1==$data._resultPage&&$data._resultRank)return void drawRanking($data._resultRank[$data.id]);$data.practicing&&($data.room.gaming=!0,send("leave")),$data.resulting=!1,$stage.dialog.result.hide(),delete $data._replay,delete $data._resultRank,$stage.box.room.height(360),playBGM("lobby"),forkChat(),updateUI()}),$stage.dialog.resultSave.on("click",function(a){var b=new Date($rec.time),c=new Blob([JSON.stringify($rec)],{type:"text/plain"}),d=URL.createObjectURL(c),e="KKuTu"+b.getFullYear()+"-"+(b.getMonth()+1)+"-"+b.getDate()+" "+b.getHours()+"-"+b.getMinutes()+"-"+b.getSeconds()+".kkt",f=$("<a>").attr({download:e,href:d}).on("click",function(a){f.remove()});$("#Jungle").append(f),f[0].click()}),$stage.dialog.dictInjeong.on("click",function(a){var b=$(a.currentTarget);b.is(":disabled")||$("#dict-theme").val()&&(b.prop("disabled",!0),$("#dict-output").html(L.searching),$.get("/injeong/"+$("#dict-input").val()+"?theme="+$("#dict-theme").val(),function(a){if(addTimeout(function(){b.prop("disabled",!1)},2e3),a.error)return $("#dict-output").html(a.error+": "+L["wpFail_"+a.error]);$("#dict-output").html(L.wpSuccess+"("+a.message+")")}))}),$stage.dialog.dictSearch.on("click",function(a){var b=$(a.currentTarget);b.is(":disabled")||(b.prop("disabled",!0),$("#dict-output").html(L.searching),tryDict($("#dict-input").val(),function(a){if(addTimeout(function(){b.prop("disabled",!1)},500),a.error)return $("#dict-output").html(a.error+": "+L["wpFail_"+a.error]);$("#dict-output").html(processWord(a.word,a.mean,a.theme,a.type.split(",")))}))}).hotkey($("#dict-input"),13),$stage.dialog.wordPlusOK.on("click",function(a){var b;$stage.dialog.wordPlusOK.hasClass("searching")||(b=$("#wp-input").val())&&(b=b.replace(/[^a-z가-힣]/g,""),b.length<2||($("#wp-input").val(""),$(a.currentTarget).addClass("searching").html("<i class='fa fa-spin fa-spinner'></i>"),send("wp",{value:b})))}).hotkey($("#wp-input"),13),$stage.dialog.inviteRobot.on("click",function(a){requestInvite("AI")}),$stage.box.me.on("click",function(a){requestProfile($data.id)}),$stage.dialog.roomInfoJoin.on("click",function(a){$stage.dialog.roomInfo.hide(),tryJoin($data._roominfo)}),$stage.dialog.profileHandover.on("click",function(a){confirm(L.sureHandover)&&send("handover",{target:$data._profiled})}),$stage.dialog.profileKick.on("click",function(a){send("kick",{robot:$data.robots.hasOwnProperty($data._profiled),target:$data._profiled})}),$stage.dialog.profileShut.on("click",function(a){var b=$data.users[$data._profiled];b&&toggleShutBlock(b.profile.title||b.profile.name)}),$stage.dialog.profileWhisper.on("click",function(a){var b=$data.users[$data._profiled];$stage.talk.val("/e "+(b.profile.title||b.profile.name).replace(/\s/g,"")+" ").focus()}),$stage.dialog.profileDress.on("click",function(a){return $data.guest?fail(421):$data._gaming?fail(438):void(showDialog($stage.dialog.dress)&&$.get("/box",function(a){if(a.error)return fail(a.error);$data.box=a,drawMyDress()}))}),$stage.dialog.dressOK.on("click",function(a){const b={};if($(a.currentTarget).attr("disabled",!0),$("#dress-nickname").val()&&$("#dress-nickname").val()!==$data.nickname&&(b.nickname=$("#dress-nickname").val()),void 0!==$("#dress-exordial").val()&&$("#dress-exordial").val()!==$data.exordial&&(b.exordial=$("#dress-exordial").val()),b.nickname&&$data.NICKNAME_LIMIT.REGEX.test(b.nickname)&&(b.nickname=confirm(L.confirmNickPolicy)?b.nickname.replace($data.NICKNAME_LIMIT.REGEX,""):void 0),!b.nickname&&void 0===b.exordial)return $stage.dialog.dressOK.attr("disabled",!1),void $stage.dialog.dress.hide();confirm($data.NICKNAME_LIMIT.TERM>0?L.confirmNickChangeLimit.replace("{V1}",$data.NICKNAME_LIMIT.TERM):L.confirmNickChange)&&$.post("/profile",b,function(a){if(a.error)return fail(a.error);const c=[];b.nickname&&($("#account-info").text($data.users[$data.id].nickname=$data.users[$data.id].profile.title=$data.users[$data.id].profile.name=$data.nickname=b.nickname),c.push(L.nickChanged.replace("{V1}",b.nickname))),void 0!==b.exordial&&c.push(L.exorChanged.replace("{V1}",$data.users[$data.id].exordial=$data.exordial=b.exordial)),send("updateProfile",b,!0),alert(c.join("\n"))}),$stage.dialog.dressOK.attr("disabled",!1),$stage.dialog.dress.hide()}),$("#DressDiag .dress-type").on("click",function(a){var b=$(a.currentTarget),c=b.attr("id").slice(11);$(".dress-type.selected").removeClass("selected"),b.addClass("selected"),drawMyGoods("all"==c||b.attr("value"))}),$("#dress-cf").on("click",function(a){if($data._gaming)return fail(438);showDialog($stage.dialog.charFactory)&&drawCharFactory()}),$stage.dialog.cfCompose.on("click",function(a){if(!$stage.dialog.cfCompose.hasClass("cf-composable"))return fail(436);confirm(L.cfSureCompose)&&$.post("/cf",{tray:$data._tray.join("|")},function(a){var b;if(a.error)return fail(a.error);send("refresh"),alert(L.cfComposed),$data.users[$data.id].money=a.money,$data.box=a.box;for(b in a.gain)queueObtain(a.gain[b]);drawMyDress($data._avGroup),updateMe(),drawCharFactory()})}),$("#room-injeong-pick").on("click",function(a){var b,c=RULE[MODE[$("#room-mode").val()]];$("#injpick-list>div").hide(),"ko"==c.lang?($data._ijkey="#ko-pick-",$("#ko-pick-list").show()):"en"==c.lang&&($data._ijkey="#en-pick-",$("#en-pick-list").show()),$stage.dialog.injPickNo.trigger("click");for(b in $data._injpick)$($data._ijkey+$data._injpick[b]).prop("checked",!0);showDialog($stage.dialog.injPick)}),$stage.dialog.injPickAll.on("click",function(a){$("#injpick-list input").prop("checked",!0)}),$stage.dialog.injPickNo.on("click",function(a){$("#injpick-list input").prop("checked",!1)}),$stage.dialog.injPickOK.on("click",function(a){var b=$($data._ijkey+"list"),c=[];$data._injpick=b.find("input").each(function(a,b){var d=$(b),e=d.attr("id").slice(8);d.is(":checked")&&c.push(e)}),$data._injpick=c,$stage.dialog.injPick.hide()}),$stage.dialog.kickVoteY.on("click",function(a){send("kickVote",{agree:!0}),clearTimeout($data._kickTimer),$stage.dialog.kickVote.hide()}),$stage.dialog.kickVoteN.on("click",function(a){send("kickVote",{agree:!1}),clearTimeout($data._kickTimer),$stage.dialog.kickVote.hide()}),$stage.dialog.purchaseOK.on("click",function(a){$.post("/buy/"+$data._sgood,function(a){var b=$data.users[$data.id];if(a.error)return fail(a.error);alert(L.purchased),b.money=a.money,b.box=a.box,updateMe()}),$stage.dialog.purchase.hide()}),$stage.dialog.purchaseNO.on("click",function(a){$stage.dialog.purchase.hide()}),$stage.dialog.obtainOK.on("click",function(a){var b=$data._obtain.shift();b?drawObtain(b):$stage.dialog.obtain.hide()}),i=0;i<5;i++)$("#team-"+i).on("click",f);$("#replay-file").on("change",function(a){var b=a.target.files[0],c=new FileReader,d=$("#replay-date").html("-"),e=$("#replay-version").html("-"),f=$("#replay-players").html("-");$rec=!1,$stage.dialog.replayView.attr("disabled",!0),b&&(c.readAsText(b),c.onload=function(a){var b,c;try{c=JSON.parse(a.target.result),d.html(new Date(c.time).toLocaleString()),e.html(c.version),f.empty();for(b in c.players){var g,h=c.players[b];f.append(g=$("<div>").addClass("replay-player-bar ellipse").html(h.title).prepend(getLevelImage(h.data.score).addClass("users-level"))),h.id==c.me&&g.css("font-weight","bold")}$rec=c,$stage.dialog.replayView.attr("disabled",!1)}catch(a){return console.warn(a),alert(L.replayError)}})}),$stage.dialog.replayView.on("click",function(a){replayReady()}),addInterval(function(){spamCount>0?spamCount=0:spamWarning>0&&(spamWarning-=.03)},1e3)}),$lib.Classic.roundReady=function(a){$data.room.game.title.length;clearBoard(),$data._roundTime=1e3*$data.room.time,$stage.game.display.html(getCharText(a.char,a.subChar)),$stage.game.chain.show().html($data.chain=0),$data.room.opts.mission&&$stage.game.items.show().css("opacity",1).html($data.mission=a.mission),"KAP"==MODE[$data.room.mode]&&$(".jjoDisplayBar .graph-bar").css({float:"right","text-align":"left"}),drawRound(a.round),playSound("round_start"),recordEvent("roundReady",{data:a})},$lib.Classic.turnStart=function(a){$data.room.game.turn=a.turn,a.seq&&($data.room.game.seq=a.seq),($data._tid=$data.room.game.seq[a.turn])&&($data._tid.robot&&($data._tid=$data._tid.id),a.id=$data._tid,$stage.game.display.html($data._char=getCharText(a.char,a.subChar,a.wordLength)),$("#game-user-"+a.id).addClass("game-user-current"),$data._replay||($stage.game.here.css("display",a.id==$data.id?"block":"none"),a.id==$data.id&&(mobile?$stage.game.hereText.val("").focus():$stage.talk.focus())),$stage.game.items.html($data.mission=a.mission),ws.onmessage=_onMessage,clearInterval($data._tTime),clearTrespasses(),$data._chars=[a.char,a.subChar],$data._speed=a.speed,$data._tTime=addInterval(turnGoing,TICK),$data.turnTime=a.turnTime,$data._turnTime=a.turnTime,$data._roundTime=a.roundTime,$data._turnSound=playSound("T"+a.speed),recordEvent("turnStart",{data:a}))},$lib.Classic.turnGoing=function(){$data.room||clearInterval($data._tTime),$data._turnTime-=TICK,$data._roundTime-=TICK,$stage.game.turnBar.width($data._timePercent()).html((.001*$data._turnTime).toFixed(1)+L.SECOND),$stage.game.roundBar.width($data._roundTime/$data.room.time*.1+"%").html((.001*$data._roundTime).toFixed(1)+L.SECOND),$stage.game.roundBar.hasClass("round-extreme")||$data._roundTime<=5e3&&$stage.game.roundBar.addClass("round-extreme")},$lib.Classic.turnEnd=function(a,c){var d,e=$("<div>").addClass("deltaScore").html(c.score>0?"+"+(c.score-c.bonus):c.score),f=$(".game-user-current");$data._turnSound&&$data._turnSound.stop(),addScore(a,c.score),clearInterval($data._tTime),c.ok?(checkFailCombo(),clearTimeout($data._fail),$stage.game.here.hide(),$stage.game.chain.html(++$data.chain),pushDisplay(c.value,c.mean,c.theme,c.wc)):(checkFailCombo(a),e.addClass("lost"),$(".game-user-current").addClass("game-user-bomb"),$stage.game.here.hide(),playSound("timeout")),c.hint&&(c.hint=c.hint._id,d=c.hint.indexOf($data._chars[0]),-1==d&&(d=c.hint.indexOf($data._chars[1])),"KAP"==MODE[$data.room.mode]?$stage.game.display.empty().append($("<label>").css("color","#AAAAAA").html(c.hint.slice(0,d))).append($("<label>").html(c.hint.slice(d))):$stage.game.display.empty().append($("<label>").html(c.hint.slice(0,d+1))).append($("<label>").css("color","#AAAAAA").html(c.hint.slice(d+1)))),c.bonus&&(mobile?e.html("+"+(b.score-b.bonus)+"+"+b.bonus):addTimeout(function(){var a=$("<div>").addClass("deltaScore bonus").html("+"+c.bonus);drawObtainedScore(f,a)},500)),drawObtainedScore(f,e).removeClass("game-user-current"),updateScore(a,getScore(a))},$lib.Jaqwi.roundReady=function(a){var b=L.jqTheme+": "+L["theme_"+a.theme];clearBoard(),$data._roundTime=1e3*$data.room.time,$data._fastTime=1e4,$stage.game.display.html(b),$stage.game.items.hide(),$stage.game.hints.show(),$(".jjo-turn-time .graph-bar").width("100%").html(b).css("text-align","center"),drawRound(a.round),playSound("round_start"),clearInterval($data._tTime)},$lib.Jaqwi.turnStart=function(a){$(".game-user-current").removeClass("game-user-current"),$(".game-user-bomb").removeClass("game-user-bomb"),$data.room.game.seq.indexOf($data.id)>=0&&$stage.game.here.show(),$stage.game.display.html($data._char=a.char),clearInterval($data._tTime),$data._tTime=addInterval(turnGoing,TICK),playBGM("jaqwi")},$lib.Jaqwi.turnGoing=function(){var a,b,c=$stage.game.roundBar;$data.room||clearInterval($data._tTime),$data._roundTime-=TICK,b=$data._spectate?L.stat_spectate:(.001*$data._roundTime).toFixed(1)+L.SECOND,c.width($data._roundTime/$data.room.time*.1+"%").html(b),c.hasClass("round-extreme")||$data._roundTime<=$data._fastTime&&(a=$data.bgm.currentTime/$data.bgm.duration,$data.bgm.paused?stopBGM():playBGM("jaqwiF"),$data.bgm.currentTime=$data.bgm.duration*a,c.addClass("round-extreme"))},$lib.Jaqwi.turnHint=function(a){playSound("mission"),pushHint(a.hint)},$lib.Jaqwi.turnEnd=function(a,b){var c=$("<div>").addClass("deltaScore").html("+"+b.score),d=$("#game-user-"+a);b.giveup?d.addClass("game-user-bomb"):b.answer?($stage.game.here.hide(),$stage.game.display.html($("<label>").css("color","#FFFF44").html(b.answer)),stopBGM(),playSound("horr")):(a==$data.id&&$stage.game.here.hide(),addScore(a,b.score),$data._roundTime>1e4&&($data._roundTime=1e4),drawObtainedScore(d,c),updateScore(a,getScore(a)).addClass("game-user-current"),playSound("success"))},$lib.Crossword.roundReady=function(a,b){var c=a.seq?a.seq.indexOf($data.id):-1;clearBoard(),$(".jjoriping,.rounds,.game-body").addClass("cw"),$data._roundTime=1e3*$data.room.time,$data._fastTime=3e4,$data.selectedRound=-1==c?1:c%$data.room.round+1,$stage.game.items.hide(),$stage.game.cwcmd.show().css("opacity",0),drawRound($data.selectedRound),b||playSound("round_start"),clearInterval($data._tTime)},$lib.Crossword.turnEnd=function(a,b){var c,d,e=$("<div>").addClass("deltaScore").html("+"+b.score),f=$("#game-user-"+a);b.score?(d=b.pos.join(","),a==$data.id?($stage.game.cwcmd.css("opacity",0),playSound("success")):($data._sel&&b.pos.join(",")==$data._sel.join(",")&&$stage.game.cwcmd.css("opacity",0),playSound("mission")),$data._bdb[d][4]=b.value,$data._bdb[d][5]=a,b.pos[0]==$data.selectedRound-1?$lib.Crossword.drawDisplay():(c=$($stage.game.round.children("label").get(b.pos[0])).addClass("round-effect"),addTimeout(function(){c.removeClass("round-effect")},800)),addScore(a,b.score),updateScore(a,getScore(a)),drawObtainedScore(f,e)):(stopBGM(),$stage.game.round.empty(),playSound("horr"))},$lib.Crossword.drawDisplay=function(){var a,b,c,d,e,f,g,h,i,j=$data._boards[$data.selectedRound-1],k=$stage.game.display.empty(),l={};for(b in j)for(d=Number(j[b][0]),e=Number(j[b][1]),f="1"==j[b][2],g=Number(j[b][3]),h=j[b][4],k.append(a=$("<div>").addClass("cw-bar").attr("id","cw-"+d+"-"+e+"-"+j[b][2]).css({top:12.5*e+"%",left:12.5*d+"%",width:12.5*(f?1:g)+"%",height:12.5*(f?g:1)+"%"})),h&&a.addClass("cw-open"),j[b][5]==$data.id?a.addClass("cw-my-open"):a.on("click",$lib.Crossword.onBar).on("mouseleave",$lib.Crossword.onSwap),c=0;c<g;c++)i=d+"-"+e,h&&(l[i]=h.charAt(c)),a.append($("<div>").addClass("cw-cell").attr("id","cwc-"+i).html(l[i]||"")),f?e++:d++},$lib.Crossword.onSwap=function(a){$stage.game.display.prepend($(a.currentTarget))},$lib.Crossword.onRound=function(a){var b=$(a.currentTarget).html().charCodeAt(0)-9311;drawRound($data.selectedRound=b),$(".rounds label").on("click",$lib.Crossword.onRound),$lib.Crossword.drawDisplay()},$lib.Crossword.onBar=function(a){var b=$(a.currentTarget),c=b.attr("id").slice(3).split("-"),d=$data._means[$data.selectedRound-1][c.join(",")],e="1"==d.dir;$stage.game.cwcmd.css("opacity",1),$data._sel=[$data.selectedRound-1,c[0],c[1],c[2]],$(".cw-q-head").html(L[e?"cwVert":"cwHorz"]+d.len+L.cwL),$("#cw-q-input").val("").focus(),$(".cw-q-body").html(processWord("★",d.mean,d.theme,d.type.split(",")))},$lib.Crossword.turnStart=function(a,b){var c,d;$data._bdb={},$data._boards=a.boards,$data._means=a.means;for(c in a.boards)for(d in a.boards[c])$data._bdb[[c,a.boards[c][d][0],a.boards[c][d][1],a.boards[c][d][2]].join(",")]=a.boards[c][d];$(".rounds label").on("click",$lib.Crossword.onRound),$lib.Crossword.drawDisplay(),clearInterval($data._tTime),$data._tTime=addInterval(turnGoing,TICK),playBGM("jaqwi")},$lib.Crossword.turnGoing=$lib.Jaqwi.turnGoing,$lib.Crossword.turnHint=function(a){playSound("fail")},$lib.Typing.roundReady=function(a){$data.room.game.title.length;$data._chatter=mobile?$stage.game.hereText:$stage.talk,clearBoard(),$data._round=a.round,$data._roundTime=1e3*$data.room.time,$data._fastTime=1e4,$data._list=a.list.concat(a.list),$data.chain=0,drawList(),drawRound(a.round),playSound("round_start"),recordEvent("roundReady",{data:a})},$lib.Typing.spaceOn=function(){$data.room.opts.proverb||($data._spaced=!0,$("body").on("keydown","#"+$data._chatter.attr("id"),onSpace))},$lib.Typing.spaceOff=function(){delete $data._spaced,$("body").off("keydown","#"+$data._chatter.attr("id"),onSpace)},$lib.Typing.turnStart=function(a){$data._spectate||($stage.game.here.show(),mobile?$stage.game.hereText.val("").focus():$stage.talk.val("").focus(),$lib.Typing.spaceOn()),ws.onmessage=_onMessage,clearInterval($data._tTime),clearTrespasses(),$data._tTime=addInterval(turnGoing,TICK),$data._roundTime=a.roundTime,playBGM("jaqwi"),recordEvent("turnStart",{data:a})},$lib.Typing.turnGoing=$lib.Jaqwi.turnGoing,$lib.Typing.turnEnd=function(a,b){var c=$("<div>").addClass("deltaScore").html("+"+b.score),d=$("#game-user-"+a);b.error?($data.chain++,drawList(),playSound("fail")):b.ok?($data.id==a?($data.chain++,drawList(),playSound("mission"),pushHistory(b.value,"")):$data._spectate&&playSound("mission"),addScore(a,b.score),drawObtainedScore(d,c),updateScore(a,getScore(a))):(clearInterval($data._tTime),$lib.Typing.spaceOff(),$stage.game.here.hide(),stopBGM(),playSound("horr"),addTimeout(drawSpeed,1e3,b.speed),$data._round<$data.room.round&&restGoing(10))},$lib.Hunmin.roundReady=function(a){$data.room.game.title.length;clearBoard(),$data._roundTime=1e3*$data.room.time,$stage.game.display.html($data._char="&lt;"+a.theme+"&gt;"),$stage.game.chain.show().html($data.chain=0),$data.room.opts.mission&&$stage.game.items.show().css("opacity",1).html($data.mission=a.mission),drawRound(a.round),playSound("round_start"),recordEvent("roundReady",{data:a})},$lib.Hunmin.turnStart=function(a){$data.room.game.turn=a.turn,a.seq&&($data.room.game.seq=a.seq),$data._tid=$data.room.game.seq[a.turn],$data._tid.robot&&($data._tid=$data._tid.id),a.id=$data._tid,$stage.game.display.html($data._char),
$("#game-user-"+a.id).addClass("game-user-current"),$data._replay||($stage.game.here.css("display",a.id==$data.id?"block":"none"),a.id==$data.id&&(mobile?$stage.game.hereText.val("").focus():$stage.talk.focus())),$stage.game.items.html($data.mission=a.mission),ws.onmessage=_onMessage,clearInterval($data._tTime),clearTrespasses(),$data._chars=[a.char,a.subChar],$data._speed=a.speed,$data._tTime=addInterval(turnGoing,TICK),$data.turnTime=a.turnTime,$data._turnTime=a.turnTime,$data._roundTime=a.roundTime,$data._turnSound=playSound("T"+a.speed),recordEvent("turnStart",{data:a})},$lib.Hunmin.turnGoing=$lib.Classic.turnGoing,$lib.Hunmin.turnEnd=function(a,c){var d,e=$("<div>").addClass("deltaScore").html(c.score>0?"+"+(c.score-c.bonus):c.score),f=$(".game-user-current");$data._turnSound.stop(),addScore(a,c.score),clearInterval($data._tTime),c.ok?(clearTimeout($data._fail),$stage.game.here.hide(),$stage.game.chain.html(++$data.chain),pushDisplay(c.value,c.mean,c.theme,c.wc)):(e.addClass("lost"),$(".game-user-current").addClass("game-user-bomb"),$stage.game.here.hide(),playSound("timeout")),c.hint&&(c.hint=c.hint._id,d=c.hint.indexOf($data._chars[0]),-1==d&&(d=c.hint.indexOf($data._chars[1])),$stage.game.display.empty().append($("<label>").html(c.hint.slice(0,d+1))).append($("<label>").css("color","#AAAAAA").html(c.hint.slice(d+1)))),c.bonus&&(mobile?e.html("+"+(b.score-b.bonus)+"+"+b.bonus):addTimeout(function(){var a=$("<div>").addClass("deltaScore bonus").html("+"+c.bonus);drawObtainedScore(f,a)},500)),drawObtainedScore(f,e).removeClass("game-user-current"),updateScore(a,getScore(a))},$lib.Daneo.roundReady=function(a){$data.room.game.title.length;clearBoard(),$data._roundTime=1e3*$data.room.time,$stage.game.display.html($data._char="&lt;"+L["theme_"+a.theme]+"&gt;"),$stage.game.chain.show().html($data.chain=0),$data.room.opts.mission&&$stage.game.items.show().css("opacity",1).html($data.mission=a.mission),drawRound(a.round),playSound("round_start"),recordEvent("roundReady",{data:a})},$lib.Daneo.turnStart=function(a){$data.room.game.turn=a.turn,a.seq&&($data.room.game.seq=a.seq),$data._tid=$data.room.game.seq[a.turn],$data._tid.robot&&($data._tid=$data._tid.id),a.id=$data._tid,$stage.game.display.html($data._char),$("#game-user-"+a.id).addClass("game-user-current"),$data._replay||($stage.game.here.css("display",a.id==$data.id?"block":"none"),a.id==$data.id&&(mobile?$stage.game.hereText.val("").focus():$stage.talk.focus())),$stage.game.items.html($data.mission=a.mission),ws.onmessage=_onMessage,clearInterval($data._tTime),clearTrespasses(),$data._chars=[a.char,a.subChar],$data._speed=a.speed,$data._tTime=addInterval(turnGoing,TICK),$data.turnTime=a.turnTime,$data._turnTime=a.turnTime,$data._roundTime=a.roundTime,$data._turnSound=playSound("T"+a.speed),recordEvent("turnStart",{data:a})},$lib.Daneo.turnGoing=$lib.Classic.turnGoing,$lib.Daneo.turnEnd=function(a,c){var d,e=$("<div>").addClass("deltaScore").html(c.score>0?"+"+(c.score-c.bonus):c.score),f=$(".game-user-current");$data._turnSound.stop(),addScore(a,c.score),clearInterval($data._tTime),c.ok?(clearTimeout($data._fail),$stage.game.here.hide(),$stage.game.chain.html(++$data.chain),pushDisplay(c.value,c.mean,c.theme,c.wc)):(e.addClass("lost"),$(".game-user-current").addClass("game-user-bomb"),$stage.game.here.hide(),playSound("timeout")),c.hint&&(c.hint=c.hint._id,d=c.hint.indexOf($data._chars[0]),-1==d&&(d=c.hint.indexOf($data._chars[1])),$stage.game.display.empty().append($("<label>").html(c.hint.slice(0,d+1))).append($("<label>").css("color","#AAAAAA").html(c.hint.slice(d+1)))),c.bonus&&(mobile?e.html("+"+(b.score-b.bonus)+"+"+b.bonus):addTimeout(function(){var a=$("<div>").addClass("deltaScore bonus").html("+"+c.bonus);drawObtainedScore(f,a)},500)),drawObtainedScore(f,e).removeClass("game-user-current"),updateScore(a,getScore(a))},$lib.Sock.roundReady=function(a,b){a.seq&&a.seq.indexOf($data.id);clearBoard(),$data._relay=!0,$(".jjoriping,.rounds,.game-body").addClass("cw"),$data._va=[],$data._lang=RULE[MODE[$data.room.mode]].lang,$data._board=a.board,$data._maps=[],$data._roundTime=1e3*$data.room.time,$data._fastTime=1e4,$stage.game.items.hide(),$stage.game.bb.show(),$lib.Sock.drawDisplay(),drawRound(a.round),b||playSound("round_start"),clearInterval($data._tTime)},$lib.Sock.turnEnd=function(a,b){var c,d,e,f=$("<div>").addClass("deltaScore").html("+"+b.score),g=$("#game-user-"+a);if(b.score){for(c=b.value,e=c.length,$data._maps.push(c),d=0;d<e;d++)$data._board=$data._board.replace(c.charAt(d),"　");playSound(a==$data.id?"success":"mission"),$lib.Sock.drawDisplay(),addScore(a,b.score),updateScore(a,getScore(a)),drawObtainedScore(g,f)}else stopBGM(),$data._relay=!1,playSound("horr")},$lib.Sock.drawMaps=function(){function a(a){var b,c=$("<div>").addClass("bb-word"),d=a.length;for(b=0;b<d;b++)c.append($("<div>").addClass("bb-char").html(a.charAt(b)));return c}$stage.game.bb.empty(),$data._maps.sort(function(a,b){return b.length-a.length}).forEach(function(b){$stage.game.bb.append(a(b))})},$lib.Sock.drawDisplay=function(){var a,b=$("<div>").css("height","100%"),c=$data._board.split(""),d="ko"==$data._lang?"12.5%":"10%";c.forEach(function(c,e){b.append(a=$("<div>").addClass("sock-char sock-"+c).css({width:d,height:d}).html(c)),$data._va[e]&&$data._va[e]!=c&&a.html($data._va[e]).addClass("sock-picked").animate({opacity:0},500)}),$data._va=c,$stage.game.display.empty().append(b),$lib.Sock.drawMaps()},$lib.Sock.turnStart=function(a,b){clearInterval($data._tTime),$data._tTime=addInterval(turnGoing,TICK),playBGM("jaqwi")},$lib.Sock.turnGoing=$lib.Jaqwi.turnGoing,$lib.Sock.turnHint=function(a){playSound("fail")};var spamWarning=0,spamCount=0;delete window.WebSocket,delete window.setInterval;})();
>>>>>>> pr/nickname
